<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-02-28">

<title>TP1:Méthodes traditionnelles de calcul de la VaR et Expected Shortfall (ES)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/logo-bg.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-8ea72dc5fed832574809a9c94082fbbb.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-fdf986989e2058d46a90f864900247d8.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../img/logo-bg.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Accueil</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index_stat.html"> 
<span class="menu-text">Modélisation stat.</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index_gdr.html"> 
<span class="menu-text">Gestion des risques</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">À propos</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sommaire</h2>
   
  <ul>
  <li><a href="#i.-data-wrangling" id="toc-i.-data-wrangling" class="nav-link active" data-scroll-target="#i.-data-wrangling">I. Data wrangling</a></li>
  <li><a href="#ii.-implémentation-de-la-var" id="toc-ii.-implémentation-de-la-var" class="nav-link" data-scroll-target="#ii.-implémentation-de-la-var">II. Implémentation de la VaR</a>
  <ul class="collapse">
  <li><a href="#ii.1.-statistiques-descriptives" id="toc-ii.1.-statistiques-descriptives" class="nav-link" data-scroll-target="#ii.1.-statistiques-descriptives">II.1. Statistiques descriptives</a></li>
  <li><a href="#ii.2.-var-non-paramétrique" id="toc-ii.2.-var-non-paramétrique" class="nav-link" data-scroll-target="#ii.2.-var-non-paramétrique">II.2. VaR non paramétrique</a>
  <ul class="collapse">
  <li><a href="#ii.2.1.-historique" id="toc-ii.2.1.-historique" class="nav-link" data-scroll-target="#ii.2.1.-historique">II.2.1. Historique</a></li>
  <li><a href="#ii.2.2.-bootstrap" id="toc-ii.2.2.-bootstrap" class="nav-link" data-scroll-target="#ii.2.2.-bootstrap">II.2.2. Bootstrap</a></li>
  <li><a href="#ii.2.3.-backtest" id="toc-ii.2.3.-backtest" class="nav-link" data-scroll-target="#ii.2.3.-backtest">II.2.3. Backtest</a></li>
  </ul></li>
  <li><a href="#ii.3.-var-paramétrique" id="toc-ii.3.-var-paramétrique" class="nav-link" data-scroll-target="#ii.3.-var-paramétrique">II.3. VaR paramétrique</a>
  <ul class="collapse">
  <li><a href="#ii.3.1.-validation-ex-ante" id="toc-ii.3.1.-validation-ex-ante" class="nav-link" data-scroll-target="#ii.3.1.-validation-ex-ante">II.3.1. Validation ex-ante</a></li>
  <li><a href="#ii.3.2.-implémentation-de-la-var" id="toc-ii.3.2.-implémentation-de-la-var" class="nav-link" data-scroll-target="#ii.3.2.-implémentation-de-la-var">II.3.2. Implémentation de la VaR</a></li>
  </ul></li>
  <li><a href="#ii.4.-var-skew-student" id="toc-ii.4.-var-skew-student" class="nav-link" data-scroll-target="#ii.4.-var-skew-student">II.4. VaR skew-student</a>
  <ul class="collapse">
  <li><a href="#ii.4.1.-validation-ex-ante" id="toc-ii.4.1.-validation-ex-ante" class="nav-link" data-scroll-target="#ii.4.1.-validation-ex-ante">II.4.1. Validation ex-ante</a></li>
  <li><a href="#ii.4.2.-calcul-de-la-var-skew-student" id="toc-ii.4.2.-calcul-de-la-var-skew-student" class="nav-link" data-scroll-target="#ii.4.2.-calcul-de-la-var-skew-student">II.4.2. Calcul de la VaR Skew Student</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#iii.-implémentation-de-les" id="toc-iii.-implémentation-de-les" class="nav-link" data-scroll-target="#iii.-implémentation-de-les">III. Implémentation de l’ES</a></li>
  <li><a href="#iv.protocole-de-backtesting" id="toc-iv.protocole-de-backtesting" class="nav-link" data-scroll-target="#iv.protocole-de-backtesting">IV.Protocole de Backtesting</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="var_classiques.ipynb" download="var_classiques.ipynb"><i class="bi bi-journal-code"></i>Jupyter</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">TP1:Méthodes traditionnelles de calcul de la VaR et Expected Shortfall (ES)</h1>
</div>



<div class="quarto-title-meta column-page-right">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 28, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Ce TP est fait dans le but de modéliser la Value at Risk qui est une mesure de risque financier. La Value at Risk (VaR) est une mesure essentielle du risque de marché qui estime la perte potentielle maximale d’un portefeuille sur un horizon h donné, avec un certain niveau de confiance <span class="math inline">\(\alpha\)</span>. La VaR est utilisée par les institutions financières et les gestionnaires de risques pour évaluer l’exposition aux pertes extrêmes et ajuster leurs stratégies d’investissement. Elle est définie comme suit :</p>
<p><span class="math display">\[VaR_{\alpha}(h) = inf \{ l \in \mathbb{R} | P(PnL \geq -l) \geq 1 - \alpha \}\]</span></p>
<p>Le PnL représente le profit and loss, c’est-à-dire la variation de la valeur du portefeuille. Dans notre cas, nous utilserons les rendements logarithmiques des actifs financiers, qui est stationnaire, pour calculer la VaR. Les rendements logarithmiques sont calculés comme suit :</p>
<p><span class="math display">\[r_t = log(\frac{P_t}{P_{t-1}}) \approx \frac{P_t - P_{t-1}}{P_{t-1}}.\]</span></p>
<p>Cette mesure est préférée aux rendements simples car sa décomposition en termes additifs permet de mieux modéliser les variations de prix des actifs financiers. De plus, en supposant la distribution identique et indépendante des rendements, on peut facilement déterminer sa loi de probabilité et calculer la VaR.</p>
<p>Dans ce projet, nous explorerons plusieurs méthodes pour calculer la VaR, en tenant compte de la nature des rendements financiers et des hypothèses sous-jacentes :</p>
<ul>
<li><strong>Méthodes non paramétriques</strong> : VaR historique et VaR bootstrap.</li>
<li><strong>Méthodes paramétriques</strong>: VaR gaussienne et VaR basée sur une distribution Skew Student.</li>
<li><strong>Méthodes avancées</strong> : VaR avec pondération exponentielle EWMA et VaR calculée par diffusion d’actifs. En complément, nous calculerons également l’Expected Shortfall (ES), qui mesure la perte moyenne au-delà du seuil de la VaR. Cette mesure est plus robuste, car elle intègre les queues de distribution et est particulièrement utile pour évaluer les risques extrêmes.</li>
</ul>
<div id="a13d7e47" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Définition des librairies</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> bootstrap</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/cherylkouadio/Library/Python/3.9/lib/python/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning:

urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
</code></pre>
</div>
</div>
<div id="90ac0d53" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import des données du CAC 40</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(<span class="st">"^FCHI"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>YF.download() has changed argument auto_adjust default to True</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
</div>
<div id="5ec20c3f" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcul des rendements logarithmiques</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data[<span class="st">'log_return'</span>] <span class="op">=</span> np.log(data[<span class="st">'Close'</span>] <span class="op">/</span> data[<span class="st">'Close'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Retirer la première ligne</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.dropna()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b9b3a35c" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Close</th>
<th data-quarto-table-cell-role="th">High</th>
<th data-quarto-table-cell-role="th">Low</th>
<th data-quarto-table-cell-role="th">Open</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">log_return</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Ticker</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1990-03-02</td>
<td>1860.0</td>
<td>1860.0</td>
<td>1831.0</td>
<td>1831.0</td>
<td>0</td>
<td>0.015168</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990-03-05</td>
<td>1874.0</td>
<td>1874.0</td>
<td>1862.0</td>
<td>1866.0</td>
<td>0</td>
<td>0.007499</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1990-03-06</td>
<td>1872.0</td>
<td>1875.0</td>
<td>1866.0</td>
<td>1869.0</td>
<td>0</td>
<td>-0.001068</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990-03-07</td>
<td>1880.0</td>
<td>1881.0</td>
<td>1874.0</td>
<td>1874.0</td>
<td>0</td>
<td>0.004264</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1990-03-08</td>
<td>1917.0</td>
<td>1923.0</td>
<td>1891.0</td>
<td>1891.0</td>
<td>0</td>
<td>0.019490</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="i.-data-wrangling" class="level1">
<h1>I. Data wrangling</h1>
<p>Le jeu de données est constitué de 6 variables, à savoir, le prix de clôture (Close), le volume des transactions (Volume), le prix d’ouverture (Open), le prix le plus bas (Low), le prix le plus élevé (High) et les rendements logarithmiques (log-return). Pour calculer les rendements sur lesquels nous nous sommes baser pour mesurer le risque du portefeuille, nous avons utilisé le prix de clôture. Il aurait été idéal de disposer des prix de clôture ajustés, i.e.&nbsp;les prix de clôture qui tiennent compte des dividendes et des éventuels splits. Cependant, en raison de l’indispobilité de ces données, nous avons utilisé les prix de clôture bruts.</p>
<p>Sur tout l’historique du CAC 40, nous n’observons aucune donnée manquante et aucune valeur aberrante (i.e.&nbsp;Prix de clôture négatif). Nous avons donc pu calculer les rendements logarithmiques sans problème.</p>
<div id="e9a169fc" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>data.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 8887 entries, 1990-03-02 to 2025-02-28
Data columns (total 6 columns):
 #   Column           Non-Null Count  Dtype  
---  ------           --------------  -----  
 0   (Close, ^FCHI)   8887 non-null   float64
 1   (High, ^FCHI)    8887 non-null   float64
 2   (Low, ^FCHI)     8887 non-null   float64
 3   (Open, ^FCHI)    8887 non-null   float64
 4   (Volume, ^FCHI)  8887 non-null   int64  
 5   (log_return, )   8887 non-null   float64
dtypes: float64(5), int64(1)
memory usage: 486.0 KB</code></pre>
</div>
</div>
<div id="e9349882" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>data.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Close</th>
<th data-quarto-table-cell-role="th">High</th>
<th data-quarto-table-cell-role="th">Low</th>
<th data-quarto-table-cell-role="th">Open</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">log_return</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Ticker</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th">^FCHI</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>8887.000000</td>
<td>8887.000000</td>
<td>8887.000000</td>
<td>8887.000000</td>
<td>8.887000e+03</td>
<td>8887.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>4215.366902</td>
<td>4244.444319</td>
<td>4184.364187</td>
<td>4215.707752</td>
<td>6.417202e+07</td>
<td>0.000167</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>1613.148605</td>
<td>1620.763329</td>
<td>1605.485586</td>
<td>1613.186974</td>
<td>6.673571e+07</td>
<td>0.013423</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1441.000000</td>
<td>1459.000000</td>
<td>1425.000000</td>
<td>1438.000000</td>
<td>0.000000e+00</td>
<td>-0.130983</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>3053.954956</td>
<td>3089.070068</td>
<td>3014.035034</td>
<td>3052.150024</td>
<td>0.000000e+00</td>
<td>-0.006450</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>4213.700195</td>
<td>4245.959961</td>
<td>4176.479980</td>
<td>4217.450195</td>
<td>6.461570e+07</td>
<td>0.000453</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>5321.669922</td>
<td>5357.655029</td>
<td>5297.364990</td>
<td>5326.139893</td>
<td>1.092204e+08</td>
<td>0.007174</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>8239.990234</td>
<td>8259.190430</td>
<td>8211.200195</td>
<td>8241.679688</td>
<td>5.312476e+08</td>
<td>0.105946</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="ef413c6d" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check na</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.isna().<span class="bu">sum</span>())</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Price       Ticker
Close       ^FCHI     0
High        ^FCHI     0
Low         ^FCHI     0
Open        ^FCHI     0
Volume      ^FCHI     0
log_return            0
dtype: int64
================================================================================</code></pre>
</div>
</div>
<p>Sur tout l’historique du CAC40, i.e.&nbsp;entre 1990 jusqu’à récemment, nous avons enregistré 5 périodes de crise financière. Ces périodes sont les suivantes :</p>
<ul>
<li>1994 : Crise obligataire</li>
<li>2000 : Bulle Internet</li>
<li>2008 : Crise des subprimes</li>
<li>2011 : Crise de la dette souveraine</li>
<li>2020 : Crise du Covid-19</li>
</ul>
<p>Cela peut se réperer par les clusters de rendements observables sur le graphique ci-dessous. Comme on peut l’observer, ces clusters de volatilité sont généralement associés à des périodes où le rendement journalier chute brutalemment. Pour mesurer le risque de marché, il peut être utile de modéliser ces clusters de volatilité et de prendre en compte les queues de distribution à travers des modèles GARCH par exemple.</p>
<p>Pour modéliser la VaR comme mesure de risque, il serait utile également de prendre les événements extrêmes en considération. En effet, en observant la densité des rendements, on peut voir que la distribution des rendements est leptokurtique, c’est-à-dire que les queues de distribution sont plus épaisses que celles d’une distribution normale (kurtosis &gt; 3). Cela signifie que les événements extrêmes sont plus fréquents que ce que la distribution normale ne le suggère. De plus, le coefficient d’asytmmétrie est négatif, ce qui signifie que la distribution des rendements est asymétrique. Cela peut être problématique pour les méthodes paramétriques qui supposent, parfois, une distribution symétrique des rendements.</p>
<div id="158d34c7" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ax1.plot(data[<span class="st">'log_return'</span>], label<span class="op">=</span><span class="st">'Rendements logarithmiques'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Rendements logarithmiques'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>ax2.plot(data[<span class="st">'Close'</span>], label<span class="op">=</span><span class="st">'Prix historiques'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Prix historiques'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>fig.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.12</span>,<span class="fl">0.89</span>))</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Evolution des prix de clôture, rendements logarithmiques du CAC 40"</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-9-output-1.png" width="1042" height="524" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b4bb8c1c" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Densité des rendements logarithmiques</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>data[<span class="st">'log_return'</span>].plot(kind<span class="op">=</span><span class="st">'kde'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Densité des rendements logarithmiques du CAC 40"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-10-output-1.png" width="659" height="506" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="272447d1" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Skewness</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>skewness <span class="op">=</span> data[<span class="st">'log_return'</span>].skew()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Skewness: </span><span class="sc">{</span>skewness<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Kurtosis</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>kurtosis <span class="op">=</span> data[<span class="st">'log_return'</span>].kurtosis()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Kurtosis: </span><span class="sc">{</span>kurtosis<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Skewness: -0.20
Kurtosis: 5.90</code></pre>
</div>
</div>
<div id="6c67550a" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Autocorrélation et pacf</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.graphics.tsaplots <span class="im">import</span> plot_acf, plot_pacf</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>plot_acf(data[<span class="st">'log_return'</span>], lags<span class="op">=</span><span class="dv">20</span>, ax<span class="op">=</span>ax1)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>plot_pacf(data[<span class="st">'log_return'</span>], lags<span class="op">=</span><span class="dv">20</span>, ax<span class="op">=</span>ax2)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Autocorrélation et PACF des rendements logarithmiques du CAC 40"</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-12-output-1.png" width="962" height="543" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="3f071869" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check for stationarity</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.stattools <span class="im">import</span> adfuller</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adf_test(series, title<span class="op">=</span><span class="st">''</span>):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Pass in a time series and an optional title, returns an Adataset report</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Augmented Dickey-Fuller Test: </span><span class="sc">{}</span><span class="ch">\n</span><span class="st">'</span>.<span class="bu">format</span>(title))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># .dropna() handles differenced data</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> adfuller(series.dropna(),autolag<span class="op">=</span><span class="st">'AIC'</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> [<span class="st">'Adataset test statistic'</span>,<span class="st">'p-value'</span>,<span class="st">'# lags used'</span>,<span class="st">'# observations'</span>]</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> pd.Series(result[<span class="dv">0</span>:<span class="dv">4</span>],index<span class="op">=</span>labels)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key,val <span class="kw">in</span> result[<span class="dv">4</span>].items():</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        out[<span class="st">'critical value (</span><span class="sc">{}</span><span class="st">)'</span>.<span class="bu">format</span>(key)]<span class="op">=</span>val</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># .to_string() removes the line "dtype: float64"</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>out<span class="sc">.</span>to_string()<span class="sc">}</span><span class="ch">\n</span><span class="ss">'</span>)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result[<span class="dv">1</span>] <span class="op">&lt;=</span> <span class="fl">0.05</span>:</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Strong evidence against the null hypothesis"</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Reject the null hypothesis"</span>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Data has no unit root and is stationary"</span>)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Weak evidence against the null hypothesis"</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Fail to reject the null hypothesis"</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Data has a unit root and is non-stationary"</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>adf_test(data[<span class="st">"Close"</span>], title<span class="op">=</span><span class="st">'Prix de clôture'</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>adf_test(data[<span class="st">"log_return"</span>], title<span class="op">=</span><span class="st">'Log-rendements'</span>)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Augmented Dickey-Fuller Test: Prix de clôture

Adataset test statistic      -0.841167
p-value                       0.806729
# lags used                  30.000000
# observations             8856.000000
critical value (1%)          -3.431089
critical value (5%)          -2.861866
critical value (10%)         -2.566944

Weak evidence against the null hypothesis
Fail to reject the null hypothesis
Data has a unit root and is non-stationary
================================================================================
Augmented Dickey-Fuller Test: Log-rendements

Adataset test statistic     -41.264713
p-value                       0.000000
# lags used                   5.000000
# observations             8881.000000
critical value (1%)          -3.431087
critical value (5%)          -2.861866
critical value (10%)         -2.566943

Strong evidence against the null hypothesis
Reject the null hypothesis
Data has no unit root and is stationary
================================================================================</code></pre>
</div>
</div>
</section>
<section id="ii.-implémentation-de-la-var" class="level1">
<h1>II. Implémentation de la VaR</h1>
<p>On va prendre comme période d’apprentissage où la BCE fait baisser ses taux directeurs et comme période de (back-)test où la BCE fait augmenter ses taux directeurs. De ce fait, nous avons le découpage suivant : - Train : 15 octobre 2008 - 26 juillet 2022 - Test : 28 juillet 2022 - 11 juin 2024</p>
<p>On va implémenter les différentes méthodes de calcul de la VaR et de l’ES sur le jeu de données du CAC 40. On va comparer les performances de ces méthodes en utilisant la période de test. On s’attend à ce que les méthodes paramétriques soient moins performantes que les méthodes non paramétriques, car elles supposent une distribution des rendements qui n’est pas toujours vérifiée. De plus, les méthodes avancées, comme l’EWMA et la diffusion d’actifs, devraient être plus performantes que les méthodes non paramétriques, car elles prennent en compte la dynamique des rendements et les corrélations entre les actifs. En général, le backtest devrait être vérifié puisque la période de test ne comporte aucune crise financière.</p>
<div id="1f13e5e3" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data[[<span class="st">'log_return'</span>,<span class="st">"Close"</span>]][<span class="st">'15-10-2008'</span>:<span class="st">'26-07-2022'</span>]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>data_train <span class="op">=</span> train[<span class="st">'log_return'</span>]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> data[[<span class="st">'log_return'</span>,<span class="st">"Close"</span>]][<span class="st">'27-07-2022'</span>:<span class="st">'11-06-2024'</span>]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>data_test <span class="op">=</span> test[<span class="st">'log_return'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="ii.1.-statistiques-descriptives" class="level2">
<h2 class="anchored" data-anchor-id="ii.1.-statistiques-descriptives">II.1. Statistiques descriptives</h2>
<p>Nous constatons que dans la période d’entrainement est plus volatile (std=1.39%). Cela s’explique par le fait que la période d’entrainement prend en compte deux crises majeures : la crise des subprimes et la crise du Covid-19. Cela peut également se voir à travers les clusters de volatilité observables à la suite de ces crises. Dans la période de test, aucun évènement majeur n’est observé, avec une plus faible volatilité observée (std=0.08%).</p>
<p>On s’attend à ce que la VaR entrainée sur la période d’entrainement performe très bien sur la période de test, mais on s’attend également à ce que la VaR entrainée sur la période de test performe moins bien sur la période d’entrainement.</p>
<div id="184669dd" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>plt.plot(data_train, label<span class="op">=</span><span class="st">'Train'</span>, color<span class="op">=</span><span class="st">'grey'</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>plt.plot(data_test, label<span class="op">=</span><span class="st">'Test'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Données d'entrainement et de test"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-15-output-1.png" width="813" height="357" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1d006bc8" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>data_train.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>count    3523.000000
mean        0.000153
std         0.013953
min        -0.130983
25%        -0.006099
50%         0.000580
75%         0.006855
max         0.096169
Name: log_return, dtype: float64</code></pre>
</div>
</div>
<div id="6fc4cd8e" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>data_test.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>count    586.000000
mean       0.000292
std        0.008947
min       -0.036484
25%       -0.004763
50%        0.000642
75%        0.005612
max        0.041504
Name: log_return, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="ii.2.-var-non-paramétrique" class="level2">
<h2 class="anchored" data-anchor-id="ii.2.-var-non-paramétrique">II.2. VaR non paramétrique</h2>
<p>La VaR est une mesure de risque qui donne une estimation de la perte maximale que l’on peut subir avec un certain niveau de confiance <span class="math inline">\(\alpha\)</span> sur un horizon de temps donné. Par exemple, une VaR à 5% sur 1 jour de 1000 euros signifie que 95% du temps, on ne perdra pas plus de 1000 euros sur un jour.</p>
<p><span class="math display">\[P(\text{Loss} &lt; \text{VaR}) = \alpha.\]</span></p>
<p>On peut également raisonner en terme de gain, i.e.&nbsp;Profit and Loss (PnL).</p>
<p><span class="math display">\[P(\text{PnL} &gt; - \text{VaR}) = \alpha.\]</span></p>
<p>La VaR peut se calculer suivant trois approches : 1. <strong>Approche historique</strong> : On se base sur les rendements passés selon l’horizon fixé pour estimer la VaR, à l’aide d’un quantile empirique d’ordre <span class="math inline">\(\alpha\)</span>. Autrement, on peut se baser sur les rendements journaliers et utiliser la méthode de <strong>scaling</strong>. 2. <strong>Approche bootstrap</strong> : On tire aléatoirement des échantillons de rendements passés avec remise, puis on prend le quantile empirique d’ordre <span class="math inline">\(\alpha\)</span> pour calculer la VaR de chaque échantillon. La VaR finale est la moyenne des VaR obtenues.</p>
<section id="ii.2.1.-historique" class="level3">
<h3 class="anchored" data-anchor-id="ii.2.1.-historique">II.2.1. Historique</h3>
<div id="7a7afd51" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Objectif : implémenter une fonction calculant la VaR historique</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> historical_var(data, alpha<span class="op">=</span><span class="fl">0.99</span>):</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcul de la VaR historique</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">    data : les rendements logarithmiques</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : le niveau de confiance</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>np.percentile(data, <span class="dv">100</span><span class="op">*</span>(<span class="dv">1</span><span class="op">-</span> alpha))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b288628f" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcul de la VaR historique sur l'échantillon d'entrainement pour h=1j et alpha=0.99</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.99</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>var_hist_train <span class="op">=</span> historical_var(data_train, alpha<span class="op">=</span>alpha)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"La VaR historique pour h=1j et alpha=0.99 est : </span><span class="sc">{</span>var_hist_train<span class="sc">:.4%}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>La VaR historique pour h=1j et alpha=0.99 est : 4.0850%</code></pre>
</div>
</div>
<p>On constate que la VaR historique pour une horizon de 1 jour et un niveau de confiance de 99% est de -4,09%. De ce fait, la perte maximale que l’on peut subir avec un niveau de confiance de 99% sur un jour est de 4,09%. Autrement dit, il y a 1 chance sur 100 que la perte soit supérieure à 4,09%. Cette perte peut se produire 2 à 3 ans fois en une année (252 jours de trading).</p>
</section>
<section id="ii.2.2.-bootstrap" class="level3">
<h3 class="anchored" data-anchor-id="ii.2.2.-bootstrap">II.2.2. Bootstrap</h3>
<p>Pour l’implémentation de la VaR bootstrap, nous faisons le choix de faire un tirage de taille n=la taille de la série des rendements, avec remise. Ce choix est fait pour des raisons de simplicité. En ce qui concerne le choix du nombre d’échantillons, nous allons observer l’évolution de de l’estimation de la VaR en fonction du nombre d’échantillons. Nous limiterons à des échantillons compris entre 1000 et 10000, pour des raisons de temps computationnels, en ayant conscience que plus le nombre d’échantillons est grand, plus l’estimation de la VaR sera précise.</p>
<div id="a6c1bf6e" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Objectif : implémenter une fonction calculant la VaR bootstrap et un IC</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bootstrap_var(data, alpha<span class="op">=</span><span class="fl">0.99</span>, M<span class="op">=</span><span class="dv">1000</span>, seuil<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcul de la VaR bootstrap</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">    data : les rendements logarithmiques</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : le niveau de confiance de la VaR</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">    n : le nombre de simulations</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">    seuil : le seuil de l'intervalle de confiance</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set seed</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialisation du vecteur des VaR</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span> np.zeros(M)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcul de la VaR bootstrap</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(M):</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        sample <span class="op">=</span> np.random.choice(data, size<span class="op">=</span><span class="bu">len</span>(data), replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>        var[i] <span class="op">=</span> <span class="op">-</span>np.percentile(sample, <span class="dv">100</span><span class="op">*</span>(<span class="dv">1</span><span class="op">-</span> alpha))</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcul de l'intervalle de confiance</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    lower <span class="op">=</span> np.percentile(var, <span class="dv">100</span><span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>seuil)<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    upper <span class="op">=</span> np.percentile(var, <span class="dv">100</span><span class="op">*</span>(seuil <span class="op">+</span> (<span class="dv">1</span><span class="op">-</span>seuil)<span class="op">/</span><span class="dv">2</span>))</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(var), lower, upper</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c687172a" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Observer la variation de la VaR en fonction de M</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>M_values <span class="op">=</span> np.arange(<span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">10</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>var_bs_values <span class="op">=</span> []</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> M <span class="kw">in</span> tqdm(M_values):</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    var_bs_train, _, _ <span class="op">=</span> bootstrap_var(data_train, alpha<span class="op">=</span>alpha, M<span class="op">=</span>M)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    var_bs_values.append(var_bs_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/900 [00:00&lt;?, ?it/s]  0%|          | 2/900 [00:00&lt;01:04, 14.01it/s]  0%|          | 4/900 [00:00&lt;01:04, 13.90it/s]  1%|          | 6/900 [00:00&lt;01:04, 13.86it/s]  1%|          | 8/900 [00:00&lt;01:05, 13.68it/s]  1%|          | 10/900 [00:00&lt;01:05, 13.50it/s]  1%|▏         | 12/900 [00:00&lt;01:06, 13.32it/s]  2%|▏         | 14/900 [00:01&lt;01:07, 13.12it/s]  2%|▏         | 16/900 [00:01&lt;01:08, 12.93it/s]  2%|▏         | 18/900 [00:01&lt;01:09, 12.72it/s]  2%|▏         | 20/900 [00:01&lt;01:10, 12.55it/s]  2%|▏         | 22/900 [00:01&lt;01:10, 12.37it/s]  3%|▎         | 24/900 [00:01&lt;01:11, 12.19it/s]  3%|▎         | 26/900 [00:02&lt;01:12, 12.01it/s]  3%|▎         | 28/900 [00:02&lt;01:13, 11.83it/s]  3%|▎         | 30/900 [00:02&lt;01:14, 11.65it/s]  4%|▎         | 32/900 [00:02&lt;01:15, 11.44it/s]  4%|▍         | 34/900 [00:02&lt;01:16, 11.28it/s]  4%|▍         | 36/900 [00:02&lt;01:17, 11.12it/s]  4%|▍         | 38/900 [00:03&lt;01:18, 10.95it/s]  4%|▍         | 40/900 [00:03&lt;01:20, 10.74it/s]  5%|▍         | 42/900 [00:03&lt;01:20, 10.61it/s]  5%|▍         | 44/900 [00:03&lt;01:21, 10.47it/s]  5%|▌         | 46/900 [00:03&lt;01:23, 10.29it/s]  5%|▌         | 48/900 [00:04&lt;01:23, 10.16it/s]  6%|▌         | 50/900 [00:04&lt;01:24, 10.03it/s]  6%|▌         | 52/900 [00:04&lt;01:25,  9.91it/s]  6%|▌         | 53/900 [00:04&lt;01:26,  9.84it/s]  6%|▌         | 54/900 [00:04&lt;01:26,  9.76it/s]  6%|▌         | 55/900 [00:04&lt;01:27,  9.67it/s]  6%|▌         | 56/900 [00:04&lt;01:28,  9.57it/s]  6%|▋         | 57/900 [00:05&lt;01:28,  9.48it/s]  6%|▋         | 58/900 [00:05&lt;01:29,  9.40it/s]  7%|▋         | 59/900 [00:05&lt;01:30,  9.29it/s]  7%|▋         | 60/900 [00:05&lt;01:31,  9.22it/s]  7%|▋         | 61/900 [00:05&lt;01:31,  9.17it/s]  7%|▋         | 62/900 [00:05&lt;01:32,  9.11it/s]  7%|▋         | 63/900 [00:05&lt;01:32,  9.05it/s]  7%|▋         | 64/900 [00:05&lt;01:32,  8.99it/s]  7%|▋         | 65/900 [00:05&lt;01:33,  8.93it/s]  7%|▋         | 66/900 [00:06&lt;01:34,  8.79it/s]  7%|▋         | 67/900 [00:06&lt;01:35,  8.74it/s]  8%|▊         | 68/900 [00:06&lt;01:35,  8.72it/s]  8%|▊         | 69/900 [00:06&lt;01:35,  8.69it/s]  8%|▊         | 70/900 [00:06&lt;01:35,  8.65it/s]  8%|▊         | 71/900 [00:06&lt;01:36,  8.59it/s]  8%|▊         | 72/900 [00:06&lt;01:36,  8.55it/s]  8%|▊         | 73/900 [00:06&lt;01:37,  8.50it/s]  8%|▊         | 74/900 [00:07&lt;01:37,  8.47it/s]  8%|▊         | 75/900 [00:07&lt;01:37,  8.42it/s]  8%|▊         | 76/900 [00:07&lt;01:38,  8.35it/s]  9%|▊         | 77/900 [00:07&lt;01:38,  8.31it/s]  9%|▊         | 78/900 [00:07&lt;01:39,  8.27it/s]  9%|▉         | 79/900 [00:07&lt;01:39,  8.23it/s]  9%|▉         | 80/900 [00:07&lt;01:40,  8.18it/s]  9%|▉         | 81/900 [00:07&lt;01:40,  8.14it/s]  9%|▉         | 82/900 [00:07&lt;01:41,  8.10it/s]  9%|▉         | 83/900 [00:08&lt;01:41,  8.06it/s]  9%|▉         | 84/900 [00:08&lt;01:41,  8.02it/s]  9%|▉         | 85/900 [00:08&lt;01:42,  7.95it/s] 10%|▉         | 86/900 [00:08&lt;01:42,  7.91it/s] 10%|▉         | 87/900 [00:08&lt;01:43,  7.87it/s] 10%|▉         | 88/900 [00:08&lt;01:43,  7.83it/s] 10%|▉         | 89/900 [00:08&lt;01:44,  7.79it/s] 10%|█         | 90/900 [00:09&lt;01:44,  7.75it/s] 10%|█         | 91/900 [00:09&lt;01:44,  7.71it/s] 10%|█         | 92/900 [00:09&lt;01:45,  7.67it/s] 10%|█         | 93/900 [00:09&lt;01:45,  7.62it/s] 10%|█         | 94/900 [00:09&lt;01:46,  7.57it/s] 11%|█         | 95/900 [00:09&lt;01:46,  7.52it/s] 11%|█         | 96/900 [00:09&lt;01:47,  7.49it/s] 11%|█         | 97/900 [00:09&lt;01:47,  7.44it/s] 11%|█         | 98/900 [00:10&lt;01:48,  7.39it/s] 11%|█         | 99/900 [00:10&lt;01:49,  7.34it/s] 11%|█         | 100/900 [00:10&lt;01:49,  7.32it/s] 11%|█         | 101/900 [00:10&lt;01:49,  7.30it/s] 11%|█▏        | 102/900 [00:10&lt;01:51,  7.17it/s] 11%|█▏        | 103/900 [00:10&lt;01:51,  7.15it/s] 12%|█▏        | 104/900 [00:10&lt;01:51,  7.14it/s] 12%|█▏        | 105/900 [00:11&lt;01:51,  7.10it/s] 12%|█▏        | 106/900 [00:11&lt;01:52,  7.08it/s] 12%|█▏        | 107/900 [00:11&lt;01:52,  7.03it/s] 12%|█▏        | 108/900 [00:11&lt;01:53,  7.01it/s] 12%|█▏        | 109/900 [00:11&lt;01:53,  6.99it/s] 12%|█▏        | 110/900 [00:11&lt;01:53,  6.96it/s] 12%|█▏        | 111/900 [00:11&lt;01:53,  6.94it/s] 12%|█▏        | 112/900 [00:12&lt;01:54,  6.89it/s] 13%|█▎        | 113/900 [00:12&lt;01:54,  6.86it/s] 13%|█▎        | 114/900 [00:12&lt;01:54,  6.84it/s] 13%|█▎        | 115/900 [00:12&lt;01:55,  6.81it/s] 13%|█▎        | 116/900 [00:12&lt;01:55,  6.78it/s] 13%|█▎        | 117/900 [00:12&lt;01:55,  6.75it/s] 13%|█▎        | 118/900 [00:12&lt;01:56,  6.73it/s] 13%|█▎        | 119/900 [00:13&lt;01:56,  6.70it/s] 13%|█▎        | 120/900 [00:13&lt;01:57,  6.66it/s] 13%|█▎        | 121/900 [00:13&lt;01:57,  6.64it/s] 14%|█▎        | 122/900 [00:13&lt;01:57,  6.61it/s] 14%|█▎        | 123/900 [00:13&lt;01:58,  6.58it/s] 14%|█▍        | 124/900 [00:13&lt;01:58,  6.53it/s] 14%|█▍        | 125/900 [00:14&lt;01:59,  6.51it/s] 14%|█▍        | 126/900 [00:14&lt;01:59,  6.48it/s] 14%|█▍        | 127/900 [00:14&lt;01:59,  6.46it/s] 14%|█▍        | 128/900 [00:14&lt;02:00,  6.43it/s] 14%|█▍        | 129/900 [00:14&lt;02:00,  6.38it/s] 14%|█▍        | 130/900 [00:14&lt;02:01,  6.36it/s] 15%|█▍        | 131/900 [00:15&lt;02:01,  6.34it/s] 15%|█▍        | 132/900 [00:15&lt;02:01,  6.31it/s] 15%|█▍        | 133/900 [00:15&lt;02:02,  6.29it/s] 15%|█▍        | 134/900 [00:15&lt;02:02,  6.26it/s] 15%|█▌        | 135/900 [00:15&lt;02:02,  6.23it/s] 15%|█▌        | 136/900 [00:15&lt;02:03,  6.20it/s] 15%|█▌        | 137/900 [00:15&lt;02:03,  6.17it/s] 15%|█▌        | 138/900 [00:16&lt;02:04,  6.13it/s] 15%|█▌        | 139/900 [00:16&lt;02:04,  6.11it/s] 16%|█▌        | 140/900 [00:16&lt;02:04,  6.09it/s] 16%|█▌        | 141/900 [00:16&lt;02:04,  6.08it/s] 16%|█▌        | 142/900 [00:16&lt;02:05,  6.05it/s] 16%|█▌        | 143/900 [00:16&lt;02:05,  6.03it/s] 16%|█▌        | 144/900 [00:17&lt;02:05,  6.00it/s] 16%|█▌        | 145/900 [00:17&lt;02:06,  5.98it/s] 16%|█▌        | 146/900 [00:17&lt;02:06,  5.95it/s] 16%|█▋        | 147/900 [00:17&lt;02:06,  5.93it/s] 16%|█▋        | 148/900 [00:17&lt;02:07,  5.91it/s] 17%|█▋        | 149/900 [00:17&lt;02:07,  5.88it/s] 17%|█▋        | 150/900 [00:18&lt;02:07,  5.86it/s] 17%|█▋        | 151/900 [00:18&lt;02:08,  5.84it/s] 17%|█▋        | 152/900 [00:18&lt;02:08,  5.82it/s] 17%|█▋        | 153/900 [00:18&lt;02:08,  5.80it/s] 17%|█▋        | 154/900 [00:18&lt;02:09,  5.78it/s] 17%|█▋        | 155/900 [00:19&lt;02:09,  5.75it/s] 17%|█▋        | 156/900 [00:19&lt;02:09,  5.73it/s] 17%|█▋        | 157/900 [00:19&lt;02:10,  5.71it/s] 18%|█▊        | 158/900 [00:19&lt;02:10,  5.68it/s] 18%|█▊        | 159/900 [00:19&lt;02:10,  5.66it/s] 18%|█▊        | 160/900 [00:19&lt;02:11,  5.62it/s] 18%|█▊        | 161/900 [00:20&lt;02:12,  5.59it/s] 18%|█▊        | 162/900 [00:20&lt;02:12,  5.57it/s] 18%|█▊        | 163/900 [00:20&lt;02:13,  5.54it/s] 18%|█▊        | 164/900 [00:20&lt;02:13,  5.52it/s] 18%|█▊        | 165/900 [00:20&lt;02:13,  5.50it/s] 18%|█▊        | 166/900 [00:21&lt;02:13,  5.49it/s] 19%|█▊        | 167/900 [00:21&lt;02:15,  5.42it/s] 19%|█▊        | 168/900 [00:21&lt;02:15,  5.41it/s] 19%|█▉        | 169/900 [00:21&lt;02:15,  5.40it/s] 19%|█▉        | 170/900 [00:21&lt;02:15,  5.38it/s] 19%|█▉        | 171/900 [00:21&lt;02:15,  5.37it/s] 19%|█▉        | 172/900 [00:22&lt;02:16,  5.34it/s] 19%|█▉        | 173/900 [00:22&lt;02:16,  5.33it/s] 19%|█▉        | 174/900 [00:22&lt;02:16,  5.31it/s] 19%|█▉        | 175/900 [00:22&lt;02:16,  5.29it/s] 20%|█▉        | 176/900 [00:22&lt;02:16,  5.28it/s] 20%|█▉        | 177/900 [00:23&lt;02:17,  5.27it/s] 20%|█▉        | 178/900 [00:23&lt;02:17,  5.26it/s] 20%|█▉        | 179/900 [00:23&lt;02:17,  5.24it/s] 20%|██        | 180/900 [00:23&lt;02:17,  5.22it/s] 20%|██        | 181/900 [00:23&lt;02:18,  5.20it/s] 20%|██        | 182/900 [00:24&lt;02:18,  5.19it/s] 20%|██        | 183/900 [00:24&lt;02:18,  5.17it/s] 20%|██        | 184/900 [00:24&lt;02:18,  5.15it/s] 21%|██        | 185/900 [00:24&lt;02:19,  5.14it/s] 21%|██        | 186/900 [00:24&lt;02:19,  5.12it/s] 21%|██        | 187/900 [00:25&lt;02:19,  5.09it/s] 21%|██        | 188/900 [00:25&lt;02:20,  5.06it/s] 21%|██        | 189/900 [00:25&lt;02:20,  5.05it/s] 21%|██        | 190/900 [00:25&lt;02:20,  5.04it/s] 21%|██        | 191/900 [00:25&lt;02:21,  5.02it/s] 21%|██▏       | 192/900 [00:26&lt;02:21,  5.00it/s] 21%|██▏       | 193/900 [00:26&lt;02:21,  4.99it/s] 22%|██▏       | 194/900 [00:26&lt;02:22,  4.97it/s] 22%|██▏       | 195/900 [00:26&lt;02:23,  4.92it/s] 22%|██▏       | 196/900 [00:26&lt;02:24,  4.87it/s] 22%|██▏       | 197/900 [00:27&lt;02:24,  4.87it/s] 22%|██▏       | 198/900 [00:27&lt;02:26,  4.78it/s] 22%|██▏       | 199/900 [00:27&lt;02:26,  4.78it/s] 22%|██▏       | 200/900 [00:27&lt;02:26,  4.78it/s] 22%|██▏       | 201/900 [00:27&lt;02:25,  4.79it/s] 22%|██▏       | 202/900 [00:28&lt;02:25,  4.79it/s] 23%|██▎       | 203/900 [00:28&lt;02:26,  4.77it/s] 23%|██▎       | 204/900 [00:28&lt;02:25,  4.77it/s] 23%|██▎       | 205/900 [00:28&lt;02:26,  4.75it/s] 23%|██▎       | 206/900 [00:28&lt;02:26,  4.73it/s] 23%|██▎       | 207/900 [00:29&lt;02:26,  4.73it/s] 23%|██▎       | 208/900 [00:29&lt;02:26,  4.72it/s] 23%|██▎       | 209/900 [00:29&lt;02:26,  4.72it/s] 23%|██▎       | 210/900 [00:29&lt;02:26,  4.71it/s] 23%|██▎       | 211/900 [00:30&lt;02:26,  4.69it/s] 24%|██▎       | 212/900 [00:30&lt;02:27,  4.67it/s] 24%|██▎       | 213/900 [00:30&lt;02:27,  4.66it/s] 24%|██▍       | 214/900 [00:30&lt;02:27,  4.65it/s] 24%|██▍       | 215/900 [00:30&lt;02:27,  4.63it/s] 24%|██▍       | 216/900 [00:31&lt;02:28,  4.62it/s] 24%|██▍       | 217/900 [00:31&lt;02:28,  4.60it/s] 24%|██▍       | 218/900 [00:31&lt;02:28,  4.59it/s] 24%|██▍       | 219/900 [00:31&lt;02:28,  4.57it/s] 24%|██▍       | 220/900 [00:31&lt;02:29,  4.56it/s] 25%|██▍       | 221/900 [00:32&lt;02:29,  4.55it/s] 25%|██▍       | 222/900 [00:32&lt;02:29,  4.52it/s] 25%|██▍       | 223/900 [00:32&lt;02:29,  4.52it/s] 25%|██▍       | 224/900 [00:32&lt;02:30,  4.49it/s] 25%|██▌       | 225/900 [00:33&lt;02:30,  4.48it/s] 25%|██▌       | 226/900 [00:33&lt;02:30,  4.47it/s] 25%|██▌       | 227/900 [00:33&lt;02:30,  4.47it/s] 25%|██▌       | 228/900 [00:33&lt;02:30,  4.45it/s] 25%|██▌       | 229/900 [00:34&lt;02:31,  4.44it/s] 26%|██▌       | 230/900 [00:34&lt;02:31,  4.43it/s] 26%|██▌       | 231/900 [00:34&lt;02:31,  4.42it/s] 26%|██▌       | 232/900 [00:34&lt;02:32,  4.39it/s] 26%|██▌       | 233/900 [00:34&lt;02:32,  4.38it/s] 26%|██▌       | 234/900 [00:35&lt;02:32,  4.37it/s] 26%|██▌       | 235/900 [00:35&lt;02:32,  4.36it/s] 26%|██▌       | 236/900 [00:35&lt;02:33,  4.33it/s] 26%|██▋       | 237/900 [00:35&lt;02:33,  4.33it/s] 26%|██▋       | 238/900 [00:36&lt;02:33,  4.32it/s] 27%|██▋       | 239/900 [00:36&lt;02:33,  4.30it/s] 27%|██▋       | 240/900 [00:36&lt;02:33,  4.29it/s] 27%|██▋       | 241/900 [00:36&lt;02:33,  4.28it/s] 27%|██▋       | 242/900 [00:37&lt;02:33,  4.27it/s] 27%|██▋       | 243/900 [00:37&lt;02:34,  4.26it/s] 27%|██▋       | 244/900 [00:37&lt;02:34,  4.25it/s] 27%|██▋       | 245/900 [00:37&lt;02:34,  4.23it/s] 27%|██▋       | 246/900 [00:37&lt;02:35,  4.22it/s] 27%|██▋       | 247/900 [00:38&lt;02:35,  4.21it/s] 28%|██▊       | 248/900 [00:38&lt;02:35,  4.20it/s] 28%|██▊       | 249/900 [00:38&lt;02:35,  4.19it/s] 28%|██▊       | 250/900 [00:38&lt;02:35,  4.18it/s] 28%|██▊       | 251/900 [00:39&lt;02:36,  4.15it/s] 28%|██▊       | 252/900 [00:39&lt;02:36,  4.15it/s] 28%|██▊       | 253/900 [00:39&lt;02:36,  4.14it/s] 28%|██▊       | 254/900 [00:39&lt;02:36,  4.13it/s] 28%|██▊       | 255/900 [00:40&lt;02:37,  4.11it/s] 28%|██▊       | 256/900 [00:40&lt;02:37,  4.09it/s] 29%|██▊       | 257/900 [00:40&lt;02:38,  4.07it/s] 29%|██▊       | 258/900 [00:40&lt;02:38,  4.05it/s] 29%|██▉       | 259/900 [00:41&lt;02:38,  4.05it/s] 29%|██▉       | 260/900 [00:41&lt;02:38,  4.05it/s] 29%|██▉       | 261/900 [00:41&lt;02:38,  4.04it/s] 29%|██▉       | 262/900 [00:41&lt;02:38,  4.04it/s] 29%|██▉       | 263/900 [00:42&lt;02:38,  4.03it/s] 29%|██▉       | 264/900 [00:42&lt;02:39,  4.00it/s] 29%|██▉       | 265/900 [00:42&lt;02:38,  4.00it/s] 30%|██▉       | 266/900 [00:42&lt;02:39,  3.97it/s] 30%|██▉       | 267/900 [00:43&lt;02:39,  3.97it/s] 30%|██▉       | 268/900 [00:43&lt;02:39,  3.96it/s] 30%|██▉       | 269/900 [00:43&lt;02:39,  3.95it/s] 30%|███       | 270/900 [00:43&lt;02:39,  3.95it/s] 30%|███       | 271/900 [00:44&lt;02:39,  3.94it/s] 30%|███       | 272/900 [00:44&lt;02:39,  3.93it/s] 30%|███       | 273/900 [00:44&lt;02:40,  3.91it/s] 30%|███       | 274/900 [00:44&lt;02:41,  3.89it/s] 31%|███       | 275/900 [00:45&lt;02:40,  3.89it/s] 31%|███       | 276/900 [00:45&lt;02:40,  3.88it/s] 31%|███       | 277/900 [00:45&lt;02:41,  3.87it/s] 31%|███       | 278/900 [00:45&lt;02:40,  3.86it/s] 31%|███       | 279/900 [00:46&lt;02:41,  3.85it/s] 31%|███       | 280/900 [00:46&lt;02:41,  3.83it/s] 31%|███       | 281/900 [00:46&lt;02:41,  3.82it/s] 31%|███▏      | 282/900 [00:47&lt;02:41,  3.82it/s] 31%|███▏      | 283/900 [00:47&lt;02:41,  3.81it/s] 32%|███▏      | 284/900 [00:47&lt;02:42,  3.79it/s] 32%|███▏      | 285/900 [00:47&lt;02:42,  3.78it/s] 32%|███▏      | 286/900 [00:48&lt;02:42,  3.78it/s] 32%|███▏      | 287/900 [00:48&lt;02:42,  3.76it/s] 32%|███▏      | 288/900 [00:48&lt;02:42,  3.76it/s] 32%|███▏      | 289/900 [00:48&lt;02:43,  3.74it/s] 32%|███▏      | 290/900 [00:49&lt;02:43,  3.72it/s] 32%|███▏      | 291/900 [00:49&lt;02:45,  3.68it/s] 32%|███▏      | 292/900 [00:49&lt;02:45,  3.68it/s] 33%|███▎      | 293/900 [00:49&lt;02:45,  3.67it/s] 33%|███▎      | 294/900 [00:50&lt;02:45,  3.67it/s] 33%|███▎      | 295/900 [00:50&lt;02:45,  3.66it/s] 33%|███▎      | 296/900 [00:50&lt;02:45,  3.65it/s] 33%|███▎      | 297/900 [00:51&lt;02:44,  3.66it/s] 33%|███▎      | 298/900 [00:51&lt;02:44,  3.66it/s] 33%|███▎      | 299/900 [00:51&lt;02:44,  3.65it/s] 33%|███▎      | 300/900 [00:51&lt;02:44,  3.65it/s] 33%|███▎      | 301/900 [00:52&lt;02:45,  3.63it/s] 34%|███▎      | 302/900 [00:52&lt;02:44,  3.63it/s] 34%|███▎      | 303/900 [00:52&lt;02:44,  3.62it/s] 34%|███▍      | 304/900 [00:53&lt;02:45,  3.60it/s] 34%|███▍      | 305/900 [00:53&lt;02:46,  3.58it/s] 34%|███▍      | 306/900 [00:53&lt;02:45,  3.58it/s] 34%|███▍      | 307/900 [00:53&lt;02:45,  3.58it/s] 34%|███▍      | 308/900 [00:54&lt;02:46,  3.56it/s] 34%|███▍      | 309/900 [00:54&lt;02:46,  3.55it/s] 34%|███▍      | 310/900 [00:54&lt;02:46,  3.55it/s] 35%|███▍      | 311/900 [00:55&lt;02:46,  3.54it/s] 35%|███▍      | 312/900 [00:55&lt;02:46,  3.52it/s] 35%|███▍      | 313/900 [00:55&lt;02:46,  3.52it/s] 35%|███▍      | 314/900 [00:55&lt;02:46,  3.52it/s] 35%|███▌      | 315/900 [00:56&lt;02:46,  3.52it/s] 35%|███▌      | 316/900 [00:56&lt;02:46,  3.51it/s] 35%|███▌      | 317/900 [00:56&lt;02:46,  3.50it/s] 35%|███▌      | 318/900 [00:57&lt;02:46,  3.50it/s] 35%|███▌      | 319/900 [00:57&lt;02:46,  3.49it/s] 36%|███▌      | 320/900 [00:57&lt;02:46,  3.48it/s] 36%|███▌      | 321/900 [00:57&lt;02:46,  3.48it/s] 36%|███▌      | 322/900 [00:58&lt;02:46,  3.47it/s] 36%|███▌      | 323/900 [00:58&lt;02:46,  3.46it/s] 36%|███▌      | 324/900 [00:58&lt;02:46,  3.45it/s] 36%|███▌      | 325/900 [00:59&lt;02:46,  3.45it/s] 36%|███▌      | 326/900 [00:59&lt;02:46,  3.44it/s] 36%|███▋      | 327/900 [00:59&lt;02:47,  3.41it/s] 36%|███▋      | 328/900 [00:59&lt;02:47,  3.41it/s] 37%|███▋      | 329/900 [01:00&lt;02:47,  3.40it/s] 37%|███▋      | 330/900 [01:00&lt;02:47,  3.40it/s] 37%|███▋      | 331/900 [01:00&lt;02:47,  3.39it/s] 37%|███▋      | 332/900 [01:01&lt;02:48,  3.37it/s] 37%|███▋      | 333/900 [01:01&lt;02:48,  3.37it/s] 37%|███▋      | 334/900 [01:01&lt;02:48,  3.37it/s] 37%|███▋      | 335/900 [01:01&lt;02:48,  3.36it/s] 37%|███▋      | 336/900 [01:02&lt;02:48,  3.36it/s] 37%|███▋      | 337/900 [01:02&lt;02:48,  3.34it/s] 38%|███▊      | 338/900 [01:02&lt;02:49,  3.33it/s] 38%|███▊      | 339/900 [01:03&lt;02:48,  3.32it/s] 38%|███▊      | 340/900 [01:03&lt;02:48,  3.32it/s] 38%|███▊      | 341/900 [01:03&lt;02:48,  3.32it/s] 38%|███▊      | 342/900 [01:04&lt;02:48,  3.31it/s] 38%|███▊      | 343/900 [01:04&lt;02:48,  3.30it/s] 38%|███▊      | 344/900 [01:04&lt;02:48,  3.30it/s] 38%|███▊      | 345/900 [01:05&lt;02:48,  3.29it/s] 38%|███▊      | 346/900 [01:05&lt;02:48,  3.29it/s] 39%|███▊      | 347/900 [01:05&lt;02:48,  3.28it/s] 39%|███▊      | 348/900 [01:05&lt;02:48,  3.27it/s] 39%|███▉      | 349/900 [01:06&lt;02:48,  3.26it/s] 39%|███▉      | 350/900 [01:06&lt;02:49,  3.25it/s] 39%|███▉      | 351/900 [01:06&lt;02:49,  3.25it/s] 39%|███▉      | 352/900 [01:07&lt;02:49,  3.24it/s] 39%|███▉      | 353/900 [01:07&lt;02:49,  3.23it/s] 39%|███▉      | 354/900 [01:07&lt;02:52,  3.16it/s] 39%|███▉      | 355/900 [01:08&lt;02:51,  3.18it/s] 40%|███▉      | 356/900 [01:08&lt;02:51,  3.17it/s] 40%|███▉      | 357/900 [01:08&lt;02:50,  3.18it/s] 40%|███▉      | 358/900 [01:09&lt;02:50,  3.18it/s] 40%|███▉      | 359/900 [01:09&lt;02:50,  3.18it/s] 40%|████      | 360/900 [01:09&lt;02:50,  3.17it/s] 40%|████      | 361/900 [01:10&lt;02:50,  3.17it/s] 40%|████      | 362/900 [01:10&lt;02:50,  3.16it/s] 40%|████      | 363/900 [01:10&lt;02:50,  3.16it/s] 40%|████      | 364/900 [01:10&lt;02:50,  3.15it/s] 41%|████      | 365/900 [01:11&lt;02:50,  3.14it/s] 41%|████      | 366/900 [01:11&lt;02:50,  3.14it/s] 41%|████      | 367/900 [01:11&lt;02:50,  3.13it/s] 41%|████      | 368/900 [01:12&lt;02:50,  3.13it/s] 41%|████      | 369/900 [01:12&lt;02:50,  3.11it/s] 41%|████      | 370/900 [01:12&lt;02:50,  3.10it/s] 41%|████      | 371/900 [01:13&lt;02:50,  3.10it/s] 41%|████▏     | 372/900 [01:13&lt;02:51,  3.09it/s] 41%|████▏     | 373/900 [01:13&lt;02:51,  3.08it/s] 42%|████▏     | 374/900 [01:14&lt;02:51,  3.07it/s] 42%|████▏     | 375/900 [01:14&lt;02:51,  3.06it/s] 42%|████▏     | 376/900 [01:14&lt;02:51,  3.06it/s] 42%|████▏     | 377/900 [01:15&lt;02:51,  3.06it/s] 42%|████▏     | 378/900 [01:15&lt;02:51,  3.05it/s] 42%|████▏     | 379/900 [01:15&lt;02:51,  3.04it/s] 42%|████▏     | 380/900 [01:16&lt;02:51,  3.03it/s] 42%|████▏     | 381/900 [01:16&lt;02:52,  3.02it/s] 42%|████▏     | 382/900 [01:16&lt;02:51,  3.02it/s] 43%|████▎     | 383/900 [01:17&lt;02:51,  3.02it/s] 43%|████▎     | 384/900 [01:17&lt;02:51,  3.01it/s] 43%|████▎     | 385/900 [01:17&lt;02:51,  3.01it/s] 43%|████▎     | 386/900 [01:18&lt;02:50,  3.01it/s] 43%|████▎     | 387/900 [01:18&lt;02:50,  3.00it/s] 43%|████▎     | 388/900 [01:18&lt;02:50,  3.00it/s] 43%|████▎     | 389/900 [01:19&lt;02:51,  2.99it/s] 43%|████▎     | 390/900 [01:19&lt;02:50,  2.98it/s] 43%|████▎     | 391/900 [01:19&lt;02:51,  2.97it/s] 44%|████▎     | 392/900 [01:20&lt;02:51,  2.96it/s] 44%|████▎     | 393/900 [01:20&lt;02:51,  2.95it/s] 44%|████▍     | 394/900 [01:20&lt;02:51,  2.95it/s] 44%|████▍     | 395/900 [01:21&lt;02:51,  2.95it/s] 44%|████▍     | 396/900 [01:21&lt;02:51,  2.94it/s] 44%|████▍     | 397/900 [01:21&lt;02:51,  2.94it/s] 44%|████▍     | 398/900 [01:22&lt;02:51,  2.94it/s] 44%|████▍     | 399/900 [01:22&lt;02:51,  2.92it/s] 44%|████▍     | 400/900 [01:22&lt;02:52,  2.91it/s] 45%|████▍     | 401/900 [01:23&lt;02:51,  2.91it/s] 45%|████▍     | 402/900 [01:23&lt;02:51,  2.90it/s] 45%|████▍     | 403/900 [01:24&lt;02:51,  2.89it/s] 45%|████▍     | 404/900 [01:24&lt;02:51,  2.89it/s] 45%|████▌     | 405/900 [01:24&lt;02:51,  2.89it/s] 45%|████▌     | 406/900 [01:25&lt;02:51,  2.88it/s] 45%|████▌     | 407/900 [01:25&lt;02:55,  2.81it/s] 45%|████▌     | 408/900 [01:25&lt;03:01,  2.71it/s] 45%|████▌     | 409/900 [01:26&lt;02:58,  2.76it/s] 46%|████▌     | 410/900 [01:26&lt;02:55,  2.78it/s] 46%|████▌     | 411/900 [01:26&lt;02:56,  2.77it/s] 46%|████▌     | 412/900 [01:27&lt;02:57,  2.75it/s] 46%|████▌     | 413/900 [01:27&lt;02:55,  2.78it/s] 46%|████▌     | 414/900 [01:27&lt;02:53,  2.79it/s] 46%|████▌     | 415/900 [01:28&lt;02:53,  2.80it/s] 46%|████▌     | 416/900 [01:28&lt;02:52,  2.81it/s] 46%|████▋     | 417/900 [01:29&lt;02:51,  2.81it/s] 46%|████▋     | 418/900 [01:29&lt;02:51,  2.81it/s] 47%|████▋     | 419/900 [01:29&lt;02:51,  2.81it/s] 47%|████▋     | 420/900 [01:30&lt;02:51,  2.80it/s] 47%|████▋     | 421/900 [01:30&lt;02:50,  2.80it/s] 47%|████▋     | 422/900 [01:30&lt;02:50,  2.80it/s] 47%|████▋     | 423/900 [01:31&lt;02:51,  2.79it/s] 47%|████▋     | 424/900 [01:31&lt;02:51,  2.78it/s] 47%|████▋     | 425/900 [01:31&lt;02:51,  2.77it/s] 47%|████▋     | 426/900 [01:32&lt;02:51,  2.77it/s] 47%|████▋     | 427/900 [01:32&lt;02:51,  2.76it/s] 48%|████▊     | 428/900 [01:32&lt;02:51,  2.75it/s] 48%|████▊     | 429/900 [01:33&lt;02:51,  2.75it/s] 48%|████▊     | 430/900 [01:33&lt;02:55,  2.67it/s] 48%|████▊     | 431/900 [01:34&lt;02:54,  2.69it/s] 48%|████▊     | 432/900 [01:34&lt;02:52,  2.71it/s] 48%|████▊     | 433/900 [01:34&lt;02:51,  2.72it/s] 48%|████▊     | 434/900 [01:35&lt;02:51,  2.72it/s] 48%|████▊     | 435/900 [01:35&lt;02:50,  2.72it/s] 48%|████▊     | 436/900 [01:35&lt;02:50,  2.72it/s] 49%|████▊     | 437/900 [01:36&lt;02:51,  2.71it/s] 49%|████▊     | 438/900 [01:36&lt;02:50,  2.71it/s] 49%|████▉     | 439/900 [01:37&lt;02:50,  2.71it/s] 49%|████▉     | 440/900 [01:37&lt;02:50,  2.70it/s] 49%|████▉     | 441/900 [01:37&lt;02:49,  2.70it/s] 49%|████▉     | 442/900 [01:38&lt;02:49,  2.70it/s] 49%|████▉     | 443/900 [01:38&lt;02:49,  2.69it/s] 49%|████▉     | 444/900 [01:38&lt;02:49,  2.69it/s] 49%|████▉     | 445/900 [01:39&lt;02:49,  2.68it/s] 50%|████▉     | 446/900 [01:39&lt;02:49,  2.68it/s] 50%|████▉     | 447/900 [01:40&lt;02:49,  2.67it/s] 50%|████▉     | 448/900 [01:40&lt;02:49,  2.67it/s] 50%|████▉     | 449/900 [01:40&lt;02:49,  2.67it/s] 50%|█████     | 450/900 [01:41&lt;02:49,  2.65it/s] 50%|█████     | 451/900 [01:41&lt;02:50,  2.63it/s] 50%|█████     | 452/900 [01:41&lt;02:50,  2.63it/s] 50%|█████     | 453/900 [01:42&lt;02:50,  2.63it/s] 50%|█████     | 454/900 [01:42&lt;02:49,  2.63it/s] 51%|█████     | 455/900 [01:43&lt;02:49,  2.63it/s] 51%|█████     | 456/900 [01:43&lt;02:49,  2.62it/s] 51%|█████     | 457/900 [01:43&lt;02:49,  2.62it/s] 51%|█████     | 458/900 [01:44&lt;02:48,  2.62it/s] 51%|█████     | 459/900 [01:44&lt;02:48,  2.61it/s] 51%|█████     | 460/900 [01:45&lt;02:48,  2.61it/s] 51%|█████     | 461/900 [01:45&lt;02:48,  2.60it/s] 51%|█████▏    | 462/900 [01:45&lt;02:48,  2.60it/s] 51%|█████▏    | 463/900 [01:46&lt;02:48,  2.59it/s] 52%|█████▏    | 464/900 [01:46&lt;02:48,  2.59it/s] 52%|█████▏    | 465/900 [01:46&lt;02:48,  2.59it/s] 52%|█████▏    | 466/900 [01:47&lt;02:48,  2.58it/s] 52%|█████▏    | 467/900 [01:47&lt;02:47,  2.58it/s] 52%|█████▏    | 468/900 [01:48&lt;02:47,  2.57it/s] 52%|█████▏    | 469/900 [01:48&lt;02:47,  2.57it/s] 52%|█████▏    | 470/900 [01:48&lt;02:47,  2.56it/s] 52%|█████▏    | 471/900 [01:49&lt;02:47,  2.56it/s] 52%|█████▏    | 472/900 [01:49&lt;02:47,  2.55it/s] 53%|█████▎    | 473/900 [01:50&lt;02:47,  2.55it/s] 53%|█████▎    | 474/900 [01:50&lt;02:47,  2.55it/s] 53%|█████▎    | 475/900 [01:50&lt;02:47,  2.54it/s] 53%|█████▎    | 476/900 [01:51&lt;02:47,  2.54it/s] 53%|█████▎    | 477/900 [01:51&lt;02:47,  2.53it/s] 53%|█████▎    | 478/900 [01:52&lt;02:46,  2.53it/s] 53%|█████▎    | 479/900 [01:52&lt;02:47,  2.52it/s] 53%|█████▎    | 480/900 [01:52&lt;02:47,  2.51it/s] 53%|█████▎    | 481/900 [01:53&lt;02:46,  2.51it/s] 54%|█████▎    | 482/900 [01:53&lt;02:46,  2.51it/s] 54%|█████▎    | 483/900 [01:54&lt;02:46,  2.50it/s] 54%|█████▍    | 484/900 [01:54&lt;02:46,  2.50it/s] 54%|█████▍    | 485/900 [01:54&lt;02:47,  2.48it/s] 54%|█████▍    | 486/900 [01:55&lt;02:46,  2.48it/s] 54%|█████▍    | 487/900 [01:55&lt;02:46,  2.47it/s] 54%|█████▍    | 488/900 [01:56&lt;02:47,  2.46it/s] 54%|█████▍    | 489/900 [01:56&lt;02:46,  2.46it/s] 54%|█████▍    | 490/900 [01:56&lt;02:46,  2.47it/s] 55%|█████▍    | 491/900 [01:57&lt;02:45,  2.47it/s] 55%|█████▍    | 492/900 [01:57&lt;02:45,  2.47it/s] 55%|█████▍    | 493/900 [01:58&lt;02:45,  2.46it/s] 55%|█████▍    | 494/900 [01:58&lt;02:45,  2.45it/s] 55%|█████▌    | 495/900 [01:58&lt;02:45,  2.44it/s] 55%|█████▌    | 496/900 [01:59&lt;02:45,  2.44it/s] 55%|█████▌    | 497/900 [01:59&lt;02:45,  2.44it/s] 55%|█████▌    | 498/900 [02:00&lt;02:45,  2.44it/s] 55%|█████▌    | 499/900 [02:00&lt;02:45,  2.42it/s] 56%|█████▌    | 500/900 [02:01&lt;02:45,  2.42it/s] 56%|█████▌    | 501/900 [02:01&lt;02:44,  2.42it/s] 56%|█████▌    | 502/900 [02:01&lt;02:44,  2.42it/s] 56%|█████▌    | 503/900 [02:02&lt;02:44,  2.42it/s] 56%|█████▌    | 504/900 [02:02&lt;02:44,  2.41it/s] 56%|█████▌    | 505/900 [02:03&lt;02:43,  2.41it/s] 56%|█████▌    | 506/900 [02:03&lt;02:44,  2.40it/s] 56%|█████▋    | 507/900 [02:03&lt;02:44,  2.39it/s] 56%|█████▋    | 508/900 [02:04&lt;02:44,  2.39it/s] 57%|█████▋    | 509/900 [02:04&lt;02:43,  2.39it/s] 57%|█████▋    | 510/900 [02:05&lt;02:43,  2.39it/s] 57%|█████▋    | 511/900 [02:05&lt;02:42,  2.39it/s] 57%|█████▋    | 512/900 [02:06&lt;02:42,  2.38it/s] 57%|█████▋    | 513/900 [02:06&lt;02:42,  2.38it/s] 57%|█████▋    | 514/900 [02:06&lt;02:42,  2.38it/s] 57%|█████▋    | 515/900 [02:07&lt;02:42,  2.37it/s] 57%|█████▋    | 516/900 [02:07&lt;02:41,  2.37it/s] 57%|█████▋    | 517/900 [02:08&lt;02:41,  2.37it/s] 58%|█████▊    | 518/900 [02:08&lt;02:41,  2.36it/s] 58%|█████▊    | 519/900 [02:08&lt;02:41,  2.36it/s] 58%|█████▊    | 520/900 [02:09&lt;02:41,  2.36it/s] 58%|█████▊    | 521/900 [02:09&lt;02:41,  2.35it/s] 58%|█████▊    | 522/900 [02:10&lt;02:41,  2.34it/s] 58%|█████▊    | 523/900 [02:10&lt;02:41,  2.34it/s] 58%|█████▊    | 524/900 [02:11&lt;02:40,  2.34it/s] 58%|█████▊    | 525/900 [02:11&lt;02:40,  2.34it/s] 58%|█████▊    | 526/900 [02:11&lt;02:40,  2.33it/s] 59%|█████▊    | 527/900 [02:12&lt;02:40,  2.32it/s] 59%|█████▊    | 528/900 [02:12&lt;02:40,  2.32it/s] 59%|█████▉    | 529/900 [02:13&lt;02:40,  2.32it/s] 59%|█████▉    | 530/900 [02:13&lt;02:39,  2.32it/s] 59%|█████▉    | 531/900 [02:14&lt;02:40,  2.30it/s] 59%|█████▉    | 532/900 [02:14&lt;02:39,  2.30it/s] 59%|█████▉    | 533/900 [02:15&lt;02:40,  2.29it/s] 59%|█████▉    | 534/900 [02:15&lt;02:39,  2.29it/s] 59%|█████▉    | 535/900 [02:15&lt;02:39,  2.29it/s] 60%|█████▉    | 536/900 [02:16&lt;02:38,  2.29it/s] 60%|█████▉    | 537/900 [02:16&lt;02:38,  2.29it/s] 60%|█████▉    | 538/900 [02:17&lt;02:38,  2.29it/s] 60%|█████▉    | 539/900 [02:17&lt;02:38,  2.28it/s] 60%|██████    | 540/900 [02:18&lt;02:37,  2.28it/s] 60%|██████    | 541/900 [02:18&lt;02:37,  2.28it/s] 60%|██████    | 542/900 [02:18&lt;02:37,  2.28it/s] 60%|██████    | 543/900 [02:19&lt;02:37,  2.27it/s] 60%|██████    | 544/900 [02:19&lt;02:36,  2.27it/s] 61%|██████    | 545/900 [02:20&lt;02:36,  2.26it/s] 61%|██████    | 546/900 [02:20&lt;02:37,  2.25it/s] 61%|██████    | 547/900 [02:21&lt;02:36,  2.25it/s] 61%|██████    | 548/900 [02:21&lt;02:36,  2.25it/s] 61%|██████    | 549/900 [02:22&lt;02:35,  2.25it/s] 61%|██████    | 550/900 [02:22&lt;02:35,  2.25it/s] 61%|██████    | 551/900 [02:22&lt;02:35,  2.25it/s] 61%|██████▏   | 552/900 [02:23&lt;02:35,  2.24it/s] 61%|██████▏   | 553/900 [02:23&lt;02:35,  2.23it/s] 62%|██████▏   | 554/900 [02:24&lt;02:35,  2.23it/s] 62%|██████▏   | 555/900 [02:24&lt;02:35,  2.22it/s] 62%|██████▏   | 556/900 [02:25&lt;02:35,  2.21it/s] 62%|██████▏   | 557/900 [02:25&lt;02:41,  2.12it/s] 62%|██████▏   | 558/900 [02:26&lt;02:39,  2.15it/s] 62%|██████▏   | 559/900 [02:26&lt;02:37,  2.16it/s] 62%|██████▏   | 560/900 [02:27&lt;02:39,  2.13it/s] 62%|██████▏   | 561/900 [02:27&lt;02:37,  2.15it/s] 62%|██████▏   | 562/900 [02:28&lt;02:35,  2.17it/s] 63%|██████▎   | 563/900 [02:28&lt;02:34,  2.18it/s] 63%|██████▎   | 564/900 [02:28&lt;02:33,  2.18it/s] 63%|██████▎   | 565/900 [02:29&lt;02:33,  2.18it/s] 63%|██████▎   | 566/900 [02:29&lt;02:32,  2.18it/s] 63%|██████▎   | 567/900 [02:30&lt;02:32,  2.18it/s] 63%|██████▎   | 568/900 [02:30&lt;02:32,  2.18it/s] 63%|██████▎   | 569/900 [02:31&lt;02:31,  2.18it/s] 63%|██████▎   | 570/900 [02:31&lt;02:31,  2.18it/s] 63%|██████▎   | 571/900 [02:32&lt;02:31,  2.18it/s] 64%|██████▎   | 572/900 [02:32&lt;02:30,  2.17it/s] 64%|██████▎   | 573/900 [02:33&lt;02:30,  2.17it/s] 64%|██████▍   | 574/900 [02:33&lt;02:30,  2.17it/s] 64%|██████▍   | 575/900 [02:34&lt;02:30,  2.16it/s] 64%|██████▍   | 576/900 [02:34&lt;02:29,  2.16it/s] 64%|██████▍   | 577/900 [02:34&lt;02:29,  2.16it/s] 64%|██████▍   | 578/900 [02:35&lt;02:29,  2.16it/s] 64%|██████▍   | 579/900 [02:35&lt;02:29,  2.15it/s] 64%|██████▍   | 580/900 [02:36&lt;02:29,  2.14it/s] 65%|██████▍   | 581/900 [02:36&lt;02:29,  2.14it/s] 65%|██████▍   | 582/900 [02:37&lt;02:29,  2.13it/s] 65%|██████▍   | 583/900 [02:37&lt;02:28,  2.13it/s] 65%|██████▍   | 584/900 [02:38&lt;02:28,  2.13it/s] 65%|██████▌   | 585/900 [02:38&lt;02:27,  2.13it/s] 65%|██████▌   | 586/900 [02:39&lt;02:27,  2.13it/s] 65%|██████▌   | 587/900 [02:39&lt;02:27,  2.13it/s] 65%|██████▌   | 588/900 [02:40&lt;02:26,  2.12it/s] 65%|██████▌   | 589/900 [02:40&lt;02:26,  2.12it/s] 66%|██████▌   | 590/900 [02:41&lt;02:26,  2.11it/s] 66%|██████▌   | 591/900 [02:41&lt;02:26,  2.10it/s] 66%|██████▌   | 592/900 [02:42&lt;02:26,  2.10it/s] 66%|██████▌   | 593/900 [02:42&lt;02:26,  2.10it/s] 66%|██████▌   | 594/900 [02:42&lt;02:25,  2.10it/s] 66%|██████▌   | 595/900 [02:43&lt;02:25,  2.10it/s] 66%|██████▌   | 596/900 [02:43&lt;02:25,  2.09it/s] 66%|██████▋   | 597/900 [02:44&lt;02:25,  2.09it/s] 66%|██████▋   | 598/900 [02:44&lt;02:25,  2.08it/s] 67%|██████▋   | 599/900 [02:45&lt;02:24,  2.08it/s] 67%|██████▋   | 600/900 [02:45&lt;02:24,  2.08it/s] 67%|██████▋   | 601/900 [02:46&lt;02:23,  2.08it/s] 67%|██████▋   | 602/900 [02:46&lt;02:23,  2.08it/s] 67%|██████▋   | 603/900 [02:47&lt;02:23,  2.08it/s] 67%|██████▋   | 604/900 [02:47&lt;02:22,  2.07it/s] 67%|██████▋   | 605/900 [02:48&lt;02:22,  2.07it/s] 67%|██████▋   | 606/900 [02:48&lt;02:22,  2.07it/s] 67%|██████▋   | 607/900 [02:49&lt;02:22,  2.06it/s] 68%|██████▊   | 608/900 [02:49&lt;02:21,  2.06it/s] 68%|██████▊   | 609/900 [02:50&lt;02:21,  2.05it/s] 68%|██████▊   | 610/900 [02:50&lt;02:21,  2.05it/s] 68%|██████▊   | 611/900 [02:51&lt;02:21,  2.05it/s] 68%|██████▊   | 612/900 [02:51&lt;02:20,  2.05it/s] 68%|██████▊   | 613/900 [02:52&lt;02:20,  2.05it/s] 68%|██████▊   | 614/900 [02:52&lt;02:20,  2.04it/s] 68%|██████▊   | 615/900 [02:53&lt;02:19,  2.04it/s] 68%|██████▊   | 616/900 [02:53&lt;02:19,  2.04it/s] 69%|██████▊   | 617/900 [02:54&lt;02:19,  2.03it/s] 69%|██████▊   | 618/900 [02:54&lt;02:18,  2.03it/s] 69%|██████▉   | 619/900 [02:55&lt;02:18,  2.03it/s] 69%|██████▉   | 620/900 [02:55&lt;02:18,  2.03it/s] 69%|██████▉   | 621/900 [02:56&lt;02:18,  2.02it/s] 69%|██████▉   | 622/900 [02:56&lt;02:17,  2.02it/s] 69%|██████▉   | 623/900 [02:57&lt;02:17,  2.02it/s] 69%|██████▉   | 624/900 [02:57&lt;02:16,  2.01it/s] 69%|██████▉   | 625/900 [02:58&lt;02:16,  2.01it/s] 70%|██████▉   | 626/900 [02:58&lt;02:16,  2.01it/s] 70%|██████▉   | 627/900 [02:59&lt;02:15,  2.01it/s] 70%|██████▉   | 628/900 [02:59&lt;02:15,  2.01it/s] 70%|██████▉   | 629/900 [03:00&lt;02:15,  2.00it/s] 70%|███████   | 630/900 [03:00&lt;02:15,  2.00it/s] 70%|███████   | 631/900 [03:01&lt;02:14,  2.00it/s] 70%|███████   | 632/900 [03:01&lt;02:14,  2.00it/s] 70%|███████   | 633/900 [03:02&lt;02:13,  1.99it/s] 70%|███████   | 634/900 [03:02&lt;02:13,  1.99it/s] 71%|███████   | 635/900 [03:03&lt;02:13,  1.99it/s] 71%|███████   | 636/900 [03:03&lt;02:12,  1.99it/s] 71%|███████   | 637/900 [03:04&lt;02:12,  1.98it/s] 71%|███████   | 638/900 [03:04&lt;02:12,  1.98it/s] 71%|███████   | 639/900 [03:05&lt;02:11,  1.98it/s] 71%|███████   | 640/900 [03:05&lt;02:11,  1.98it/s] 71%|███████   | 641/900 [03:06&lt;02:11,  1.97it/s] 71%|███████▏  | 642/900 [03:06&lt;02:11,  1.96it/s] 71%|███████▏  | 643/900 [03:07&lt;02:10,  1.96it/s] 72%|███████▏  | 644/900 [03:07&lt;02:10,  1.96it/s] 72%|███████▏  | 645/900 [03:08&lt;02:10,  1.96it/s] 72%|███████▏  | 646/900 [03:08&lt;02:10,  1.95it/s] 72%|███████▏  | 647/900 [03:09&lt;02:09,  1.95it/s] 72%|███████▏  | 648/900 [03:09&lt;02:09,  1.94it/s] 72%|███████▏  | 649/900 [03:10&lt;02:09,  1.93it/s] 72%|███████▏  | 650/900 [03:10&lt;02:09,  1.94it/s] 72%|███████▏  | 651/900 [03:11&lt;02:08,  1.94it/s] 72%|███████▏  | 652/900 [03:11&lt;02:08,  1.93it/s] 73%|███████▎  | 653/900 [03:12&lt;02:07,  1.93it/s] 73%|███████▎  | 654/900 [03:12&lt;02:07,  1.93it/s] 73%|███████▎  | 655/900 [03:13&lt;02:09,  1.89it/s] 73%|███████▎  | 656/900 [03:13&lt;02:08,  1.90it/s] 73%|███████▎  | 657/900 [03:14&lt;02:07,  1.90it/s] 73%|███████▎  | 658/900 [03:15&lt;02:06,  1.91it/s] 73%|███████▎  | 659/900 [03:15&lt;02:06,  1.91it/s] 73%|███████▎  | 660/900 [03:16&lt;02:05,  1.91it/s] 73%|███████▎  | 661/900 [03:16&lt;02:04,  1.92it/s] 74%|███████▎  | 662/900 [03:17&lt;02:04,  1.91it/s] 74%|███████▎  | 663/900 [03:17&lt;02:03,  1.91it/s] 74%|███████▍  | 664/900 [03:18&lt;02:03,  1.91it/s] 74%|███████▍  | 665/900 [03:18&lt;02:04,  1.89it/s] 74%|███████▍  | 666/900 [03:19&lt;02:08,  1.82it/s] 74%|███████▍  | 667/900 [03:19&lt;02:06,  1.84it/s] 74%|███████▍  | 668/900 [03:20&lt;02:06,  1.84it/s] 74%|███████▍  | 669/900 [03:20&lt;02:05,  1.83it/s] 74%|███████▍  | 670/900 [03:21&lt;02:04,  1.85it/s] 75%|███████▍  | 671/900 [03:21&lt;02:03,  1.85it/s] 75%|███████▍  | 672/900 [03:22&lt;02:03,  1.85it/s] 75%|███████▍  | 673/900 [03:23&lt;02:02,  1.86it/s] 75%|███████▍  | 674/900 [03:23&lt;02:01,  1.86it/s] 75%|███████▌  | 675/900 [03:24&lt;02:00,  1.86it/s] 75%|███████▌  | 676/900 [03:24&lt;02:01,  1.85it/s] 75%|███████▌  | 677/900 [03:25&lt;02:01,  1.84it/s] 75%|███████▌  | 678/900 [03:25&lt;02:00,  1.83it/s] 75%|███████▌  | 679/900 [03:26&lt;02:01,  1.82it/s] 76%|███████▌  | 680/900 [03:26&lt;02:00,  1.83it/s] 76%|███████▌  | 681/900 [03:27&lt;01:59,  1.83it/s] 76%|███████▌  | 682/900 [03:28&lt;02:05,  1.73it/s] 76%|███████▌  | 683/900 [03:28&lt;02:03,  1.75it/s] 76%|███████▌  | 684/900 [03:29&lt;02:02,  1.76it/s] 76%|███████▌  | 685/900 [03:29&lt;02:01,  1.77it/s] 76%|███████▌  | 686/900 [03:30&lt;02:01,  1.77it/s] 76%|███████▋  | 687/900 [03:30&lt;02:00,  1.77it/s] 76%|███████▋  | 688/900 [03:31&lt;02:01,  1.75it/s] 77%|███████▋  | 689/900 [03:32&lt;02:00,  1.76it/s] 77%|███████▋  | 690/900 [03:32&lt;01:59,  1.76it/s] 77%|███████▋  | 691/900 [03:33&lt;01:58,  1.76it/s] 77%|███████▋  | 692/900 [03:33&lt;01:57,  1.77it/s] 77%|███████▋  | 693/900 [03:34&lt;01:57,  1.77it/s] 77%|███████▋  | 694/900 [03:34&lt;01:56,  1.76it/s] 77%|███████▋  | 695/900 [03:35&lt;01:57,  1.75it/s] 77%|███████▋  | 696/900 [03:35&lt;01:55,  1.77it/s] 77%|███████▋  | 697/900 [03:36&lt;01:54,  1.78it/s] 78%|███████▊  | 698/900 [03:37&lt;01:52,  1.79it/s] 78%|███████▊  | 699/900 [03:37&lt;01:51,  1.80it/s] 78%|███████▊  | 700/900 [03:38&lt;01:51,  1.80it/s] 78%|███████▊  | 701/900 [03:38&lt;01:50,  1.79it/s] 78%|███████▊  | 702/900 [03:39&lt;01:50,  1.79it/s] 78%|███████▊  | 703/900 [03:39&lt;01:49,  1.79it/s] 78%|███████▊  | 704/900 [03:40&lt;01:49,  1.79it/s] 78%|███████▊  | 705/900 [03:40&lt;01:48,  1.79it/s] 78%|███████▊  | 706/900 [03:41&lt;01:48,  1.79it/s] 79%|███████▊  | 707/900 [03:42&lt;01:47,  1.79it/s] 79%|███████▊  | 708/900 [03:42&lt;01:47,  1.79it/s] 79%|███████▉  | 709/900 [03:43&lt;01:46,  1.79it/s] 79%|███████▉  | 710/900 [03:43&lt;01:46,  1.79it/s] 79%|███████▉  | 711/900 [03:44&lt;01:46,  1.77it/s] 79%|███████▉  | 712/900 [03:44&lt;01:45,  1.77it/s] 79%|███████▉  | 713/900 [03:45&lt;01:45,  1.77it/s] 79%|███████▉  | 714/900 [03:46&lt;01:45,  1.77it/s] 79%|███████▉  | 715/900 [03:46&lt;01:44,  1.76it/s] 80%|███████▉  | 716/900 [03:47&lt;01:45,  1.75it/s] 80%|███████▉  | 717/900 [03:47&lt;01:44,  1.75it/s] 80%|███████▉  | 718/900 [03:48&lt;01:43,  1.76it/s] 80%|███████▉  | 719/900 [03:48&lt;01:42,  1.76it/s] 80%|████████  | 720/900 [03:49&lt;01:42,  1.76it/s] 80%|████████  | 721/900 [03:50&lt;01:41,  1.76it/s] 80%|████████  | 722/900 [03:50&lt;01:41,  1.76it/s] 80%|████████  | 723/900 [03:51&lt;01:40,  1.75it/s] 80%|████████  | 724/900 [03:51&lt;01:40,  1.76it/s] 81%|████████  | 725/900 [03:52&lt;01:39,  1.76it/s] 81%|████████  | 726/900 [03:52&lt;01:39,  1.75it/s] 81%|████████  | 727/900 [03:53&lt;01:38,  1.75it/s] 81%|████████  | 728/900 [03:54&lt;01:38,  1.75it/s] 81%|████████  | 729/900 [03:54&lt;01:37,  1.75it/s] 81%|████████  | 730/900 [03:55&lt;01:37,  1.75it/s] 81%|████████  | 731/900 [03:55&lt;01:39,  1.70it/s] 81%|████████▏ | 732/900 [03:56&lt;01:39,  1.70it/s] 81%|████████▏ | 733/900 [03:57&lt;01:38,  1.69it/s] 82%|████████▏ | 734/900 [03:57&lt;01:39,  1.68it/s] 82%|████████▏ | 735/900 [03:58&lt;01:37,  1.68it/s] 82%|████████▏ | 736/900 [03:58&lt;01:37,  1.68it/s] 82%|████████▏ | 737/900 [03:59&lt;01:37,  1.67it/s] 82%|████████▏ | 738/900 [04:00&lt;01:36,  1.67it/s] 82%|████████▏ | 739/900 [04:00&lt;01:36,  1.67it/s] 82%|████████▏ | 740/900 [04:01&lt;01:35,  1.68it/s] 82%|████████▏ | 741/900 [04:01&lt;01:35,  1.66it/s] 82%|████████▏ | 742/900 [04:02&lt;01:34,  1.67it/s] 83%|████████▎ | 743/900 [04:02&lt;01:33,  1.68it/s] 83%|████████▎ | 744/900 [04:03&lt;01:33,  1.67it/s] 83%|████████▎ | 745/900 [04:04&lt;01:32,  1.67it/s] 83%|████████▎ | 746/900 [04:04&lt;01:32,  1.66it/s] 83%|████████▎ | 747/900 [04:05&lt;01:32,  1.65it/s] 83%|████████▎ | 748/900 [04:06&lt;01:32,  1.64it/s] 83%|████████▎ | 749/900 [04:06&lt;01:32,  1.64it/s] 83%|████████▎ | 750/900 [04:07&lt;01:30,  1.65it/s] 83%|████████▎ | 751/900 [04:07&lt;01:29,  1.67it/s] 84%|████████▎ | 752/900 [04:08&lt;01:29,  1.66it/s] 84%|████████▎ | 753/900 [04:09&lt;01:28,  1.67it/s] 84%|████████▍ | 754/900 [04:09&lt;01:28,  1.66it/s] 84%|████████▍ | 755/900 [04:10&lt;01:27,  1.66it/s] 84%|████████▍ | 756/900 [04:10&lt;01:26,  1.66it/s] 84%|████████▍ | 757/900 [04:11&lt;01:25,  1.66it/s] 84%|████████▍ | 758/900 [04:12&lt;01:25,  1.66it/s] 84%|████████▍ | 759/900 [04:12&lt;01:25,  1.64it/s] 84%|████████▍ | 760/900 [04:13&lt;01:25,  1.64it/s] 85%|████████▍ | 761/900 [04:13&lt;01:24,  1.65it/s] 85%|████████▍ | 762/900 [04:14&lt;01:23,  1.65it/s] 85%|████████▍ | 763/900 [04:15&lt;01:22,  1.66it/s] 85%|████████▍ | 764/900 [04:15&lt;01:21,  1.66it/s] 85%|████████▌ | 765/900 [04:16&lt;01:21,  1.66it/s] 85%|████████▌ | 766/900 [04:16&lt;01:20,  1.67it/s] 85%|████████▌ | 767/900 [04:17&lt;01:19,  1.66it/s] 85%|████████▌ | 768/900 [04:18&lt;01:19,  1.66it/s] 85%|████████▌ | 769/900 [04:18&lt;01:19,  1.64it/s] 86%|████████▌ | 770/900 [04:19&lt;01:18,  1.65it/s] 86%|████████▌ | 771/900 [04:19&lt;01:18,  1.65it/s] 86%|████████▌ | 772/900 [04:20&lt;01:17,  1.64it/s] 86%|████████▌ | 773/900 [04:21&lt;01:17,  1.64it/s] 86%|████████▌ | 774/900 [04:21&lt;01:16,  1.65it/s] 86%|████████▌ | 775/900 [04:22&lt;01:15,  1.65it/s] 86%|████████▌ | 776/900 [04:22&lt;01:15,  1.65it/s] 86%|████████▋ | 777/900 [04:23&lt;01:14,  1.65it/s] 86%|████████▋ | 778/900 [04:24&lt;01:14,  1.64it/s] 87%|████████▋ | 779/900 [04:24&lt;01:14,  1.62it/s] 87%|████████▋ | 780/900 [04:25&lt;01:19,  1.51it/s] 87%|████████▋ | 781/900 [04:26&lt;01:23,  1.42it/s] 87%|████████▋ | 782/900 [04:27&lt;01:23,  1.41it/s] 87%|████████▋ | 783/900 [04:27&lt;01:20,  1.45it/s] 87%|████████▋ | 784/900 [04:28&lt;01:17,  1.49it/s] 87%|████████▋ | 785/900 [04:29&lt;01:15,  1.52it/s] 87%|████████▋ | 786/900 [04:29&lt;01:13,  1.54it/s] 87%|████████▋ | 787/900 [04:30&lt;01:14,  1.51it/s] 88%|████████▊ | 788/900 [04:30&lt;01:13,  1.53it/s] 88%|████████▊ | 789/900 [04:31&lt;01:11,  1.56it/s] 88%|████████▊ | 790/900 [04:32&lt;01:11,  1.53it/s] 88%|████████▊ | 791/900 [04:32&lt;01:12,  1.49it/s] 88%|████████▊ | 792/900 [04:33&lt;01:10,  1.53it/s] 88%|████████▊ | 793/900 [04:34&lt;01:09,  1.54it/s] 88%|████████▊ | 794/900 [04:34&lt;01:07,  1.56it/s] 88%|████████▊ | 795/900 [04:35&lt;01:06,  1.58it/s] 88%|████████▊ | 796/900 [04:36&lt;01:10,  1.47it/s] 89%|████████▊ | 797/900 [04:37&lt;01:15,  1.37it/s] 89%|████████▊ | 798/900 [04:37&lt;01:11,  1.43it/s] 89%|████████▉ | 799/900 [04:38&lt;01:08,  1.48it/s] 89%|████████▉ | 800/900 [04:38&lt;01:05,  1.52it/s] 89%|████████▉ | 801/900 [04:39&lt;01:04,  1.55it/s] 89%|████████▉ | 802/900 [04:40&lt;01:02,  1.56it/s] 89%|████████▉ | 803/900 [04:40&lt;01:01,  1.58it/s] 89%|████████▉ | 804/900 [04:41&lt;01:00,  1.58it/s] 89%|████████▉ | 805/900 [04:42&lt;01:00,  1.58it/s] 90%|████████▉ | 806/900 [04:42&lt;00:59,  1.59it/s] 90%|████████▉ | 807/900 [04:43&lt;00:58,  1.59it/s] 90%|████████▉ | 808/900 [04:44&lt;00:59,  1.54it/s] 90%|████████▉ | 809/900 [04:44&lt;00:59,  1.53it/s] 90%|█████████ | 810/900 [04:45&lt;00:58,  1.54it/s] 90%|█████████ | 811/900 [04:45&lt;00:57,  1.55it/s] 90%|█████████ | 812/900 [04:46&lt;00:56,  1.55it/s] 90%|█████████ | 813/900 [04:47&lt;00:55,  1.56it/s] 90%|█████████ | 814/900 [04:47&lt;00:54,  1.57it/s] 91%|█████████ | 815/900 [04:48&lt;00:54,  1.55it/s] 91%|█████████ | 816/900 [04:49&lt;00:54,  1.55it/s] 91%|█████████ | 817/900 [04:49&lt;00:53,  1.55it/s] 91%|█████████ | 818/900 [04:50&lt;00:52,  1.55it/s] 91%|█████████ | 819/900 [04:51&lt;00:52,  1.56it/s] 91%|█████████ | 820/900 [04:51&lt;00:51,  1.54it/s] 91%|█████████ | 821/900 [04:52&lt;00:50,  1.55it/s] 91%|█████████▏| 822/900 [04:53&lt;00:50,  1.56it/s] 91%|█████████▏| 823/900 [04:53&lt;00:49,  1.55it/s] 92%|█████████▏| 824/900 [04:54&lt;00:48,  1.55it/s] 92%|█████████▏| 825/900 [04:54&lt;00:48,  1.56it/s] 92%|█████████▏| 826/900 [04:55&lt;00:47,  1.54it/s] 92%|█████████▏| 827/900 [04:56&lt;00:47,  1.54it/s] 92%|█████████▏| 828/900 [04:56&lt;00:47,  1.53it/s] 92%|█████████▏| 829/900 [04:57&lt;00:46,  1.54it/s] 92%|█████████▏| 830/900 [04:58&lt;00:45,  1.54it/s] 92%|█████████▏| 831/900 [04:58&lt;00:44,  1.54it/s] 92%|█████████▏| 832/900 [04:59&lt;00:44,  1.54it/s] 93%|█████████▎| 833/900 [05:00&lt;00:43,  1.53it/s] 93%|█████████▎| 834/900 [05:00&lt;00:44,  1.49it/s] 93%|█████████▎| 835/900 [05:01&lt;00:43,  1.50it/s] 93%|█████████▎| 836/900 [05:02&lt;00:42,  1.52it/s] 93%|█████████▎| 837/900 [05:02&lt;00:41,  1.53it/s] 93%|█████████▎| 838/900 [05:03&lt;00:40,  1.54it/s] 93%|█████████▎| 839/900 [05:04&lt;00:39,  1.54it/s] 93%|█████████▎| 840/900 [05:04&lt;00:38,  1.54it/s] 93%|█████████▎| 841/900 [05:05&lt;00:38,  1.54it/s] 94%|█████████▎| 842/900 [05:06&lt;00:37,  1.54it/s] 94%|█████████▎| 843/900 [05:06&lt;00:37,  1.53it/s] 94%|█████████▍| 844/900 [05:07&lt;00:36,  1.53it/s] 94%|█████████▍| 845/900 [05:08&lt;00:35,  1.53it/s] 94%|█████████▍| 846/900 [05:08&lt;00:35,  1.53it/s] 94%|█████████▍| 847/900 [05:09&lt;00:34,  1.53it/s] 94%|█████████▍| 848/900 [05:10&lt;00:34,  1.52it/s] 94%|█████████▍| 849/900 [05:10&lt;00:33,  1.52it/s] 94%|█████████▍| 850/900 [05:11&lt;00:32,  1.52it/s] 95%|█████████▍| 851/900 [05:12&lt;00:32,  1.52it/s] 95%|█████████▍| 852/900 [05:12&lt;00:31,  1.52it/s] 95%|█████████▍| 853/900 [05:13&lt;00:31,  1.50it/s] 95%|█████████▍| 854/900 [05:14&lt;00:30,  1.50it/s] 95%|█████████▌| 855/900 [05:14&lt;00:29,  1.51it/s] 95%|█████████▌| 856/900 [05:15&lt;00:29,  1.51it/s] 95%|█████████▌| 857/900 [05:16&lt;00:28,  1.50it/s] 95%|█████████▌| 858/900 [05:16&lt;00:28,  1.50it/s] 95%|█████████▌| 859/900 [05:17&lt;00:27,  1.50it/s] 96%|█████████▌| 860/900 [05:18&lt;00:26,  1.50it/s] 96%|█████████▌| 861/900 [05:18&lt;00:25,  1.50it/s] 96%|█████████▌| 862/900 [05:19&lt;00:25,  1.50it/s] 96%|█████████▌| 863/900 [05:20&lt;00:24,  1.50it/s] 96%|█████████▌| 864/900 [05:20&lt;00:24,  1.50it/s] 96%|█████████▌| 865/900 [05:21&lt;00:23,  1.50it/s] 96%|█████████▌| 866/900 [05:22&lt;00:22,  1.48it/s] 96%|█████████▋| 867/900 [05:22&lt;00:23,  1.43it/s] 96%|█████████▋| 868/900 [05:23&lt;00:22,  1.44it/s] 97%|█████████▋| 869/900 [05:24&lt;00:21,  1.45it/s] 97%|█████████▋| 870/900 [05:24&lt;00:20,  1.44it/s] 97%|█████████▋| 871/900 [05:25&lt;00:20,  1.45it/s] 97%|█████████▋| 872/900 [05:26&lt;00:19,  1.45it/s] 97%|█████████▋| 873/900 [05:26&lt;00:18,  1.44it/s] 97%|█████████▋| 874/900 [05:27&lt;00:18,  1.43it/s] 97%|█████████▋| 875/900 [05:28&lt;00:17,  1.43it/s] 97%|█████████▋| 876/900 [05:29&lt;00:16,  1.43it/s] 97%|█████████▋| 877/900 [05:29&lt;00:15,  1.44it/s] 98%|█████████▊| 878/900 [05:30&lt;00:15,  1.45it/s] 98%|█████████▊| 879/900 [05:31&lt;00:14,  1.45it/s] 98%|█████████▊| 880/900 [05:31&lt;00:13,  1.44it/s] 98%|█████████▊| 881/900 [05:32&lt;00:13,  1.43it/s] 98%|█████████▊| 882/900 [05:33&lt;00:12,  1.44it/s] 98%|█████████▊| 883/900 [05:33&lt;00:11,  1.44it/s] 98%|█████████▊| 884/900 [05:34&lt;00:11,  1.43it/s] 98%|█████████▊| 885/900 [05:35&lt;00:10,  1.41it/s] 98%|█████████▊| 886/900 [05:36&lt;00:09,  1.43it/s] 99%|█████████▊| 887/900 [05:36&lt;00:09,  1.42it/s] 99%|█████████▊| 888/900 [05:37&lt;00:08,  1.43it/s] 99%|█████████▉| 889/900 [05:38&lt;00:07,  1.42it/s] 99%|█████████▉| 890/900 [05:38&lt;00:06,  1.43it/s] 99%|█████████▉| 891/900 [05:39&lt;00:06,  1.43it/s] 99%|█████████▉| 892/900 [05:40&lt;00:05,  1.43it/s] 99%|█████████▉| 893/900 [05:40&lt;00:04,  1.44it/s] 99%|█████████▉| 894/900 [05:41&lt;00:04,  1.44it/s] 99%|█████████▉| 895/900 [05:42&lt;00:03,  1.44it/s]100%|█████████▉| 896/900 [05:42&lt;00:02,  1.44it/s]100%|█████████▉| 897/900 [05:43&lt;00:02,  1.45it/s]100%|█████████▉| 898/900 [05:44&lt;00:01,  1.45it/s]100%|█████████▉| 899/900 [05:45&lt;00:00,  1.45it/s]100%|██████████| 900/900 [05:45&lt;00:00,  1.45it/s]100%|██████████| 900/900 [05:45&lt;00:00,  2.60it/s]</code></pre>
</div>
</div>
<div id="dcc85ef6" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>plt.plot(M_values, var_bs_values, marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Nombre de simulations'</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'VaR bootstrap'</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Variation de la VaR bootstrap en fonction du nombre de simulations"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>Text(0.5, 1.0, 'Variation de la VaR bootstrap en fonction du nombre de simulations')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-22-output-2.png" width="846" height="376" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Pour la taille de l’echantillon bootstrap, nous allons prendre M=8000 étant donné que la courbe semble se stabiliser à partir de cette valeur. Avec ce choix, la VaR estimé est de 4.11%% avec un intervalle de confiance à 5% de [4.05%, 4.09%]. De plus, en ce qui concerne la VaR historique, nous constatons que l’estimation est contenu dans l’intervalle de confiance.</p>
<div id="97e8afbd" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>M<span class="op">=</span><span class="dv">8000</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>var_bs_train, lower_ic,upper_ic <span class="op">=</span> bootstrap_var(data_train, alpha<span class="op">=</span>alpha, M<span class="op">=</span>M)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"La VaR bootstrap pour h=1j et alpha=0.99 est : </span><span class="sc">{</span>var_bs_train<span class="sc">:.4%}</span><span class="ss">"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"L'intervalle de confiance est : [</span><span class="sc">{</span>lower_ic<span class="sc">:.4%}</span><span class="ss">, </span><span class="sc">{</span>upper_ic<span class="sc">:.4%}</span><span class="ss">]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>La VaR bootstrap pour h=1j et alpha=0.99 est : 4.1065%
L'intervalle de confiance est : [4.0536%, 4.0939%]</code></pre>
</div>
</div>
</section>
<section id="ii.2.3.-backtest" class="level3">
<h3 class="anchored" data-anchor-id="ii.2.3.-backtest">II.2.3. Backtest</h3>
<p>Pour l’exercice de backtest, il s’agit de : 1. Déterminer si la proportion <span class="math inline">\(p\)</span> de violations de la VaR est cohérente avec le niveau de confiance, i.e.&nbsp;égale à <span class="math inline">\(1-\alpha\)</span>. Cela permet de vérifier si la mesure de risque est bien calibrée. Pour cela, nous pouvons avoir recours à un test de proportion ou un test de ratio de vraisemblance.</p>
<pre><code>**Unconditional coverage test** :
Soit I la variable indicatrice de violation de la VaR, i.e. $I=1$ si la perte est supérieure à la VaR, et $I=0$ sinon. La proportion de violations de la VaR est donnée par :

$$p = \frac{1}{n} \sum_{i=1}^{n} I_i = \frac{Z}{n}$$

Sous H0, i.e. p=1-$\alpha$, Z $\sim$ Binomiale(n, 1-$\alpha$). En supposant que n est suffisamment grand, on peut approximer Z par une loi normale. Ainsi donc :
$$\frac{Z - n (1-\alpha)}{\sqrt{\alpha (1-\alpha) n}} \sim \mathcal{N}(n(1-\alpha), n\alpha(1-\alpha))$$

Sous cette hypothèse asymptotique, on peut calculer la statistique du ratio de vraisemblance suivant :
$$LR = -2 ln \left( \frac{L(H1)}{L(H0)} \right) =-2 ln \left( 1- (1-\alpha))^{n-e}(1-\alpha)^e \right) + 2 ln \left( (1-\frac{e}{n})^{n-e} (\frac{e}{n})^e  \right)  \sim \chi^2(1)$$

où e est le nombre de violations de la VaR. On rejette H0 si LR &gt; $\chi^2(1-\alpha)$.

**Test de proportion** :
$$
H_0 : p = p_0 = 1-\alpha \\ H_1 : p &gt; 1-\alpha
$$
On peut également utiliser un test binomial pour tester si la proportion de violations de la VaR est égale à $1-\alpha$. On peut calculer la statistique du test suivant :
$$Z = \frac{p - p_0}{\sqrt{p_0 (1-p_0) / n}} \sim \mathcal{N}(0,1)$$

On rejette H0 si Z &gt; $p_0+ \phi^{-1}(1-\alpha) \sqrt{p_0 (1-p_0)/n}$, où $\phi$ est la quantile de la loi normale standard.</code></pre>
<ol start="2" type="1">
<li><p>Déterminer si, lorsqu’il y en a, les violations de VaR à deux différents jours sont indépendantes. Cela permet si la mesure de risque est capable de réagir aux chocs de marché affectant la volatilité des rendements. Pour cela, nous utilisons un conditional coverage test.</p>
<p><strong>Conditional coverage test</strong> : y revenir</p></li>
</ol>
<div id="cfe93e81" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> stats</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Objectif : implémenter une fonction calculant le nombre d'exception sur l'échantillon test</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> exceptions(data, var):</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcul du nombre d'exception</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co">    data : les rendements logarithmiques</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">    var : la VaR</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>(data <span class="op">&lt;</span> <span class="op">-</span>var)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Objectif : test de proportion binomiale</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> binomial_test(n, p, p0 <span class="op">=</span> <span class="fl">0.01</span>, alpha<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Test de proportion binomiale</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co">    H0 : p = p0</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co">    H1 : p &gt; p0</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co">    n : le nombre d'essais</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co">    p : la proportion</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : le niveau de confiance</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> (p <span class="op">-</span> p0) <span class="op">/</span> np.sqrt(p0 <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> p0) <span class="op">/</span> n)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#reject_zone = p0 + stats.norm.ppf(1 - alpha) * np.sqrt(p0 * (1 - p0) / n)</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    p_value <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> stats.norm.cdf(z)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    reject <span class="op">=</span> p_value <span class="op">&lt;</span> alpha</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcul des IC</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    lower <span class="op">=</span> p <span class="op">-</span> stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> np.sqrt(p <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> p) <span class="op">/</span> n)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    upper <span class="op">=</span> p <span class="op">+</span> stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> np.sqrt(p <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> p) <span class="op">/</span> n)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p_value, reject, lower, upper</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Unconditionnal coverage test ==&gt; to do.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c3dbcc93" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Backtest de la VaR historique</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>exceptions_test <span class="op">=</span> exceptions(data_test, var_hist_train)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Le nombre d'exceptions sur l'échantillon de test est : </span><span class="sc">{</span>exceptions_test<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(data_test)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> exceptions_test <span class="op">/</span> n</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>p_value, reject, lower,upper <span class="op">=</span> binomial_test(n, p)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"H0 : le nombre d'exceptions est inférieur ou égale à </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>alpha<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"IC : [</span><span class="sc">{</span>lower<span class="sc">:.2%}</span><span class="ss">,</span><span class="sc">{</span>upper<span class="sc">:.2%}</span><span class="ss">]"</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"La p-value du test de proportion binomiale est : </span><span class="sc">{</span>p_value<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rejet de l'hypothèse nulle : </span><span class="sc">{</span>reject<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Le nombre d'exceptions sur l'échantillon de test est : 0
================================================================================
H0 : le nombre d'exceptions est inférieur ou égale à 1.00%
IC : [0.00%,0.00%]
La p-value du test de proportion binomiale est : 0.9925
Rejet de l'hypothèse nulle : False
================================================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="ii.3.-var-paramétrique" class="level2">
<h2 class="anchored" data-anchor-id="ii.3.-var-paramétrique">II.3. VaR paramétrique</h2>
<section id="ii.3.1.-validation-ex-ante" class="level3">
<h3 class="anchored" data-anchor-id="ii.3.1.-validation-ex-ante">II.3.1. Validation ex-ante</h3>
<p>Visuellement, les données ne semblent pas suivre une loi normale. En effet, les quantiles théoriques d’une loi normale ne collent pas avec les quantiles empiriques des rendements. Cela peut être dû à la présence de queues épaisses observables sur l’estimation de la densité des rendements sur l’échantillon d’apprentissage, de pics, de clusters de volatilité que nous avons observées plus haut. De plus, le skewness est négatif ce qui indique une asymétrie négative des rendements. Enfin, le kurtosis est supérieur à 3, ce qui indique une distribution leptokurtique des rendements.</p>
<p>Nous allons tout de même implémenter une VaR gaussienne pour voir comment elle se comporte dans le backtest.</p>
<div id="bf85ba2a" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test visuel d'adéquation de la loi normale</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un Q-Q plot</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>stats.probplot(data_train, dist<span class="op">=</span><span class="st">"norm"</span>, plot<span class="op">=</span>ax)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Personnalisation du graphique</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Q-Q Plot (Normal Distribution)"</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Theoretical Quantiles"</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Sample Quantiles"</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Afficher le graphique</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-26-output-1.png" width="832" height="523" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="13f87652" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Densité de l'echantillon train et l'échantillon de test</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>data_train.plot(kind<span class="op">=</span><span class="st">'kde'</span>, label<span class="op">=</span><span class="st">'Train'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Densité de l'échantillon d'entrainement"</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-27-output-1.png" width="808" height="357" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="6c801a90" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Skewness et kurtosis</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Skewness de l'échantillon d'entrainement : "</span>, data_train.skew())</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Kurtosis de l'échantillon d'entrainement : "</span>, data_train.kurt())</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Skewness de l'échantillon d'entrainement :  -0.2981820421484688
Kurtosis de l'échantillon d'entrainement :  7.353960005618779
================================================================================</code></pre>
</div>
</div>
<div id="5faf99dd" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> kstest</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Test de Kolmogorov-Smirnov</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>ks_stat, ks_p_value <span class="op">=</span> kstest(data_train, <span class="st">'norm'</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"H0 : Les données suivent une loi normale"</span>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Statistique de test : </span><span class="sc">{</span>ks_stat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"P-value : </span><span class="sc">{</span>ks_p_value<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
H0 : Les données suivent une loi normale
Statistique de test : 0.4775
P-value : 0.0000
================================================================================</code></pre>
</div>
</div>
</section>
<section id="ii.3.2.-implémentation-de-la-var" class="level3">
<h3 class="anchored" data-anchor-id="ii.3.2.-implémentation-de-la-var">II.3.2. Implémentation de la VaR</h3>
<section id="a.-méthode-scaling" class="level4">
<h4 class="anchored" data-anchor-id="a.-méthode-scaling">a. Méthode scaling</h4>
<div id="41a5f2b5" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Objectif : écrire une fonction qui calcule la VaR gaussienne</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaussian_var(data, alpha):</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcul de la VaR gaussienne</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">    data : les rendements logarithmiques</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : le niveau de confiance</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> np.mean(data)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> np.std(data)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>(mu <span class="op">+</span> sigma <span class="op">*</span> norm.ppf(<span class="dv">1</span> <span class="op">-</span> alpha))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d31d6dbd" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>var_gauss_train <span class="op">=</span> gaussian_var(data_train, alpha<span class="op">=</span>alpha)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"La VaR gaussienne pour h=1j et alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss"> est : </span><span class="sc">{</span>var_gauss_train<span class="sc">:.4%}</span><span class="ss">"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"La VaR historique pour h=10j et alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss"> est : </span><span class="sc">{</span>np<span class="sc">.</span>sqrt(<span class="dv">10</span>)<span class="op">*</span>var_gauss_train<span class="sc">:.4%}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>La VaR gaussienne pour h=1j et alpha=0.99 est : 3.2302%
La VaR historique pour h=10j et alpha=0.99 est : 10.2148%</code></pre>
</div>
</div>
</section>
<section id="b.-méthode-de-diffusion-dun-actif" class="level4">
<h4 class="anchored" data-anchor-id="b.-méthode-de-diffusion-dun-actif">b. Méthode de diffusion d’un actif</h4>
<p>Pour calculer la <strong>VaR gaussienne à 10 jours</strong> par <strong>méthode de diffusion d’un actif</strong>, nous allons suivre les étapes suivantes :</p>
<p>L’évolution du prix d’un actif suit un processus de type mouvement brownien géométrique : <span class="math display">\[
dS_t = \mu S_t dt + \sigma S_t dW_t &lt;=&gt; S_t = S_{t-1} e^{(\mu - \frac{1}{2} \sigma^2) + \sigma W_t}
\]</span> où $ S_t$ est le prix de l’actif à l’instant$ t$, $ $ est le rendement moyen estimé (drift), $ $ est la volatilité du rendement, $ dW_t$ est un mouvement brownien standard.</p>
<p>On peut de ce fait calculer plusieurs trajectoires de rendements de <span class="math inline">\(S_0\)</span> et <span class="math inline">\(S_{10}\)</span>, puis calculer la VaR à partir de la série des rendements $ r_{10j} = (S_{10} / S_{0}) $ obtenus avec ces trajectoires.</p>
<p>En utilisant la méthode de scaling et la méthode de diffusion, nous obtenons sensiblement la même VaR.</p>
<div id="2d93186f" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> np.mean(data_train)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> np.std(data_train)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>return_sim <span class="op">=</span> []</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>S0 <span class="op">=</span> train[<span class="st">'Close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(M):</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> np.zeros(T<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    S[<span class="dv">0</span>] <span class="op">=</span> S0</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,T<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        Wt <span class="op">=</span> np.random.normal()</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>        S[t] <span class="op">=</span> S[t<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> np.exp((mu <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span>) <span class="op">+</span> sigma <span class="op">*</span> Wt)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    return_sim.append(np.log(S[T]<span class="op">/</span>S0))</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>var_gauss_diffusion <span class="op">=</span> gaussian_var(return_sim, alpha<span class="op">=</span>alpha)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"La VaR gaussienne pour h=10j et alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss"> est : </span><span class="sc">{</span>var_gauss_diffusion<span class="sc">:.4%}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>La VaR gaussienne pour h=10j et alpha=0.99 est : 10.0053%</code></pre>
</div>
</div>
</section>
<section id="c.-méthode-ewma" class="level4">
<h4 class="anchored" data-anchor-id="c.-méthode-ewma">c.&nbsp;Méthode EWMA</h4>
<p>La VaR EWMA est une méthode qui permet de calculer la VaR en surpondérant les rendements les plus récents. Cela permet de donner plus de poids aux rendements les plus récents, et donc de mieux capturer les changements de volatilité. La VaR EWMA est donnée par la formule suivante :</p>
<p><span class="math display">\[
VaR_{t+1} = \mu + \sigma \times z_{\alpha}
\]</span></p>
<div id="283adde6" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># VaR la méthode EWMA (Exponential Weighting Moving Average)</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaussian_var_ewma(data, alpha, lambda_<span class="op">=</span><span class="fl">0.94</span>):</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcul de la VaR gaussienne EWMA</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">    data : les rendements logarithmiques</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : le niveau de confiance</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">    lambda_ : le paramètre de lissage</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> np.array([(<span class="dv">1</span><span class="op">-</span>lambda_)<span class="op">*</span>(lambda_<span class="op">**</span>i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data))])</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> weights <span class="op">/</span> np.<span class="bu">sum</span>(weights)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> np.<span class="bu">sum</span>(data[::<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> weights)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> np.sqrt(np.<span class="bu">sum</span>(weights <span class="op">*</span> (data[::<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> mu)<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>(mu <span class="op">+</span> sigma <span class="op">*</span> stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> alpha)), mu, sigma</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="co"># y revenir</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b555f280" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>lambdas <span class="op">=</span> [<span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">0.99</span>]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.99</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> stats</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> l <span class="kw">in</span> lambdas:</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Lambda : "</span>, l)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">15</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    var_gauss_emwa, mu, sigma <span class="op">=</span> gaussian_var_ewma(data_train, alpha<span class="op">=</span>alpha, lambda_<span class="op">=</span>l)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"La VaR gaussienne EWMA pour h=1j et alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss"> est : </span><span class="sc">{</span>var_gauss_emwa<span class="sc">:.4%}</span><span class="ss">"</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"La moyenne est : </span><span class="sc">{</span>mu<span class="sc">:.4%}</span><span class="ss">"</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"L'écart-type est : </span><span class="sc">{</span>sigma<span class="sc">:.4%}</span><span class="ss">"</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    n_exceptions <span class="op">=</span> exceptions(data_test, var_gauss_emwa)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Le nombre d'exceptions sur l'échantillon de test est : </span><span class="sc">{</span>n_exceptions<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Lambda :  0.9
---------------
La VaR gaussienne EWMA pour h=1j et alpha=0.99 est : 2.3751%
La moyenne est : 0.1898%
L'écart-type est : 1.1025%
Le nombre d'exceptions sur l'échantillon de test est : 5
================================================================================
Lambda :  0.95
---------------
La VaR gaussienne EWMA pour h=1j et alpha=0.99 est : 2.8969%
La moyenne est : 0.0735%
L'écart-type est : 1.2768%
Le nombre d'exceptions sur l'échantillon de test est : 4
================================================================================
Lambda :  0.99
---------------
La VaR gaussienne EWMA pour h=1j et alpha=0.99 est : 3.3511%
La moyenne est : -0.0321%
L'écart-type est : 1.4267%
Le nombre d'exceptions sur l'échantillon de test est : 1</code></pre>
</div>
</div>
<p>Avec la méthode EWMA, nous observons une que la VaR diminue plus <span class="math inline">\(\lambda\)</span> augmente. Cela est dû au fait que plus <span class="math inline">\(\lambda\)</span> est grand, plus les rendements les plus récents sont surpondérés, et donc la volatilité est plus faible, en raison de la fin de la période d’apprentissage.</p>
</section>
</section>
</section>
<section id="ii.4.-var-skew-student" class="level2">
<h2 class="anchored" data-anchor-id="ii.4.-var-skew-student">II.4. VaR skew-student</h2>
<section id="ii.4.1.-validation-ex-ante" class="level3">
<h3 class="anchored" data-anchor-id="ii.4.1.-validation-ex-ante">II.4.1. Validation ex-ante</h3>
<div id="8dfa0ee6" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ecrire une fonction permettant d’estimer les paramètres d’une loi de Skew Student par maximum de vraisemblance.</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> t</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> skew_student_pdf(x, mu, sigma, gamma, nu ):</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the Skew Student-t probability density function (PDF).</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    t_x <span class="op">=</span> ((x <span class="op">-</span> mu) <span class="op">*</span> gamma <span class="op">/</span> sigma) <span class="op">*</span> np.sqrt((nu <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (nu <span class="op">+</span> ((x <span class="op">-</span> mu) <span class="op">/</span> sigma) <span class="op">**</span> <span class="dv">2</span>))</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PDF of the standard Student-t distribution</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    pdf_t <span class="op">=</span> t.pdf(x , df<span class="op">=</span>nu,  loc<span class="op">=</span>mu, scale<span class="op">=</span>sigma)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CDF of the transformed Student-t distribution</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    cdf_t <span class="op">=</span> t.cdf(t_x, df<span class="op">=</span>nu <span class="op">+</span> <span class="dv">1</span>,loc<span class="op">=</span><span class="dv">0</span>, scale<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skew Student density function</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    density <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> pdf_t <span class="op">*</span> cdf_t</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> density</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> skew_student_log_likelihood(params, data):</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcul de la log-vraisemblance de la loi de Skew Student</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="co">    params [mu, sigma, gamma, nu]: les paramètres de la loi</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="co">    data : les rendements logarithmiques</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>    mu, sigma, gamma, nu <span class="op">=</span> params</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    density <span class="op">=</span> skew_student_pdf(data , mu, sigma, gamma, nu)</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log-vraisemblance</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    loglik <span class="op">=</span> np.<span class="bu">sum</span>(np.log(density))</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span> loglik</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimisation des paramètres avec contraintes de positivité sur sigma et nu</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> skew_student_fit(data):</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimation des paramètres de la loi de Skew Student</span></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initial guess</span></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.array([np.mean(data), np.std(data), <span class="dv">1</span>, <span class="dv">4</span>])</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># contraintes</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> [(<span class="va">None</span>, <span class="va">None</span>), (<span class="dv">0</span>, <span class="va">None</span>), (<span class="va">None</span>, <span class="va">None</span>), (<span class="va">None</span>, <span class="va">None</span>)]</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># optimisation</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> minimize(skew_student_log_likelihood, x0, args<span class="op">=</span>(data), bounds<span class="op">=</span>bounds)</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res.x</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> skew_student_fit(data_train)</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Les paramètres estimés de la loi de Skew Student sont : "</span>)</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">15</span>)</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mu : "</span>, params[<span class="dv">0</span>])</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sigma : "</span>, params[<span class="dv">1</span>])</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Gamma : "</span>, params[<span class="dv">2</span>])</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Nu : "</span>, params[<span class="dv">3</span>])</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>params_sstd <span class="op">=</span> {</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu"</span> : params[<span class="dv">0</span>],</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma"</span> : params[<span class="dv">1</span>],</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gamma"</span> : params[<span class="dv">2</span>],</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nu"</span> : params[<span class="dv">3</span>]</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Les paramètres estimés de la loi de Skew Student sont : 
---------------
Mu :  0.0023251952411471218
Sigma :  0.008823931435233275
Gamma :  -0.23188477391476636
Nu :  2.9618199934116825
================================================================================</code></pre>
</div>
</div>
<div id="15fc58b8" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Superposition de la densité théorique et des données</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>x_values <span class="op">=</span> np.linspace(<span class="bu">min</span>(data_train), <span class="bu">max</span>(data_train), <span class="dv">1000</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>theoretical_density <span class="op">=</span> skew_student_pdf(x_values, <span class="op">**</span>params_sstd)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">4</span>))</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>plt.hist(data_train, bins<span class="op">=</span><span class="dv">30</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Données empiriques'</span>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>plt.plot(x_values, theoretical_density, label<span class="op">=</span><span class="st">'Densité Skew Student'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Densité normale</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>plt.plot(x_values, stats.norm.pdf(x_values, np.mean(data_train), np.std(data_train)), label<span class="op">=</span><span class="st">'Densité normale'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Rendements logarithmiques'</span>)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Densité'</span>)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparaison entre les données et la densité théorique d'une loi de Skew Student"</span>)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-36-output-1.png" width="808" height="377" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Le graphique ci-dessus est satisfaisant. La densité théorique de la skew-student semble bien s’ajuster aux données. La loi skew-student de paramètres (<span class="math inline">\(\mu = 0.002, \sigma = 0.009, \gamma = -0.23, \nu = 2.96\)</span>). Le <span class="math inline">\(\mu\)</span> est le rendement moyen, <span class="math inline">\(\sigma\)</span> est l’écart-type, <span class="math inline">\(\gamma\)</span> est le coefficient d’asymétrie et <span class="math inline">\(\nu\)</span> est le degré de liberté. Le skewness est négatif, ce qui indique une asymétrie négative des rendements, comme ce qu’on a observé plus haut.</p>
<p>Nous allons appuyer cette validation en utilisant le QQ-plot. La fonction quantile d’une loi skew-student n’est pas analytique. Pour ce faire, nous allons construire la fonction de repartition de la skew-student ainsi que la fonction quantile qui est l’inverse de cette fonction de repartition. Nous allons ensuite comparer les quantiles théoriques de la skew-student avec les quantiles empiriques des rendements.</p>
<p>En observant le QQ-plot, on constate que les quantiles théoriques de la skew-student collent bien avec les quantiles empiriques des rendements. Cela confirme que la skew-student est une bonne approximation de la distribution des rendements. Pour une validation plus rigoureuse, on peut utiliser un test de Kolmogorov-Smirnov pour tester si les rendements suivent une loi skew-student.</p>
<div id="9f5bc3f6" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Intégration de la fonction de densité</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> integrate</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize_scalar</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> integrale_SkewStudent(x,params):</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    borne_inf <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    resultat_integration, erreur <span class="op">=</span> integrate.quad(<span class="kw">lambda</span> x: skew_student_pdf(x, <span class="op">**</span>params), borne_inf, x)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resultat_integration</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fonc_minimize(x, alpha,params):</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> integrale_SkewStudent(x,params)<span class="op">-</span>alpha</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">abs</span>(value)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> skew_student_quantile(alpha,mu, sigma, gamma, nu ):</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu"</span> : mu ,</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma"</span> : sigma,</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gamma"</span> : gamma,</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nu"</span> : nu</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> alpha <span class="op">&lt;</span><span class="dv">0</span> <span class="kw">or</span> alpha <span class="op">&gt;</span><span class="dv">1</span>:</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Veuillez entrer un niveau alpha entre 0 et 1"</span>)</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>        resultat_minimisation <span class="op">=</span> minimize_scalar(<span class="kw">lambda</span> x: fonc_minimize(x, alpha,params))</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> resultat_minimisation.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="43b428df" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>niveaux_quantiles <span class="op">=</span> np.arange(<span class="fl">0.001</span>, <span class="dv">1</span>, <span class="fl">0.001</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>quantiles_empiriques <span class="op">=</span> np.quantile(data_train, niveaux_quantiles)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>quantiles_theoriques <span class="op">=</span> [skew_student_quantile(alpha,<span class="op">**</span>params_sstd) <span class="cf">for</span> alpha <span class="kw">in</span> tqdm(niveaux_quantiles)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/999 [00:00&lt;?, ?it/s]  0%|          | 1/999 [00:00&lt;05:35,  2.97it/s]  0%|          | 2/999 [00:00&lt;05:26,  3.05it/s]  0%|          | 3/999 [00:00&lt;05:30,  3.02it/s]  0%|          | 4/999 [00:01&lt;06:18,  2.63it/s]  1%|          | 5/999 [00:01&lt;06:32,  2.53it/s]  1%|          | 6/999 [00:02&lt;06:37,  2.50it/s]  1%|          | 7/999 [00:02&lt;06:34,  2.52it/s]  1%|          | 8/999 [00:03&lt;06:49,  2.42it/s]  1%|          | 9/999 [00:03&lt;06:48,  2.43it/s]  1%|          | 10/999 [00:03&lt;06:58,  2.36it/s]  1%|          | 11/999 [00:04&lt;06:43,  2.45it/s]  1%|          | 12/999 [00:04&lt;06:49,  2.41it/s]  1%|▏         | 13/999 [00:05&lt;06:58,  2.36it/s]  1%|▏         | 14/999 [00:05&lt;07:08,  2.30it/s]  2%|▏         | 15/999 [00:06&lt;06:57,  2.36it/s]  2%|▏         | 16/999 [00:06&lt;06:59,  2.34it/s]  2%|▏         | 17/999 [00:06&lt;06:54,  2.37it/s]  2%|▏         | 18/999 [00:07&lt;06:56,  2.36it/s]  2%|▏         | 19/999 [00:07&lt;06:58,  2.34it/s]  2%|▏         | 20/999 [00:08&lt;06:46,  2.41it/s]  2%|▏         | 21/999 [00:08&lt;06:44,  2.42it/s]  2%|▏         | 22/999 [00:09&lt;06:54,  2.36it/s]  2%|▏         | 23/999 [00:09&lt;06:52,  2.37it/s]  2%|▏         | 24/999 [00:09&lt;06:45,  2.41it/s]  3%|▎         | 25/999 [00:10&lt;06:50,  2.37it/s]  3%|▎         | 26/999 [00:10&lt;07:13,  2.25it/s]  3%|▎         | 27/999 [00:11&lt;07:05,  2.29it/s]  3%|▎         | 28/999 [00:11&lt;06:59,  2.31it/s]  3%|▎         | 29/999 [00:12&lt;07:03,  2.29it/s]  3%|▎         | 30/999 [00:12&lt;06:59,  2.31it/s]  3%|▎         | 31/999 [00:12&lt;06:58,  2.32it/s]  3%|▎         | 32/999 [00:13&lt;07:06,  2.26it/s]  3%|▎         | 33/999 [00:13&lt;07:24,  2.17it/s]  3%|▎         | 34/999 [00:14&lt;07:34,  2.12it/s]  4%|▎         | 35/999 [00:14&lt;07:34,  2.12it/s]  4%|▎         | 36/999 [00:15&lt;07:39,  2.10it/s]  4%|▎         | 37/999 [00:15&lt;07:42,  2.08it/s]  4%|▍         | 38/999 [00:16&lt;07:58,  2.01it/s]  4%|▍         | 39/999 [00:16&lt;08:08,  1.96it/s]  4%|▍         | 40/999 [00:17&lt;07:59,  2.00it/s]  4%|▍         | 41/999 [00:17&lt;07:53,  2.02it/s]  4%|▍         | 42/999 [00:18&lt;07:53,  2.02it/s]  4%|▍         | 43/999 [00:18&lt;07:49,  2.04it/s]  4%|▍         | 44/999 [00:19&lt;07:44,  2.06it/s]  5%|▍         | 45/999 [00:19&lt;07:43,  2.06it/s]  5%|▍         | 46/999 [00:20&lt;07:46,  2.04it/s]  5%|▍         | 47/999 [00:20&lt;07:40,  2.07it/s]  5%|▍         | 48/999 [00:21&lt;07:50,  2.02it/s]  5%|▍         | 49/999 [00:21&lt;08:00,  1.98it/s]  5%|▌         | 50/999 [00:22&lt;07:49,  2.02it/s]  5%|▌         | 51/999 [00:22&lt;07:48,  2.02it/s]  5%|▌         | 52/999 [00:23&lt;08:03,  1.96it/s]  5%|▌         | 53/999 [00:23&lt;08:03,  1.96it/s]  5%|▌         | 54/999 [00:24&lt;07:50,  2.01it/s]  6%|▌         | 55/999 [00:24&lt;07:59,  1.97it/s]  6%|▌         | 56/999 [00:25&lt;07:53,  1.99it/s]  6%|▌         | 57/999 [00:25&lt;07:58,  1.97it/s]  6%|▌         | 58/999 [00:26&lt;08:02,  1.95it/s]  6%|▌         | 59/999 [00:26&lt;07:43,  2.03it/s]  6%|▌         | 60/999 [00:27&lt;07:45,  2.02it/s]  6%|▌         | 61/999 [00:27&lt;08:01,  1.95it/s]  6%|▌         | 62/999 [00:28&lt;08:07,  1.92it/s]  6%|▋         | 63/999 [00:28&lt;08:08,  1.92it/s]  6%|▋         | 64/999 [00:29&lt;08:07,  1.92it/s]  7%|▋         | 65/999 [00:29&lt;07:53,  1.97it/s]  7%|▋         | 66/999 [00:30&lt;07:41,  2.02it/s]  7%|▋         | 67/999 [00:30&lt;07:55,  1.96it/s]  7%|▋         | 68/999 [00:31&lt;07:41,  2.02it/s]  7%|▋         | 69/999 [00:31&lt;07:47,  1.99it/s]  7%|▋         | 70/999 [00:32&lt;07:38,  2.03it/s]  7%|▋         | 71/999 [00:32&lt;07:47,  1.99it/s]  7%|▋         | 72/999 [00:33&lt;07:53,  1.96it/s]  7%|▋         | 73/999 [00:34&lt;07:58,  1.94it/s]  7%|▋         | 74/999 [00:34&lt;07:51,  1.96it/s]  8%|▊         | 75/999 [00:35&lt;07:59,  1.93it/s]  8%|▊         | 76/999 [00:35&lt;08:03,  1.91it/s]  8%|▊         | 77/999 [00:36&lt;07:51,  1.95it/s]  8%|▊         | 78/999 [00:36&lt;08:02,  1.91it/s]  8%|▊         | 79/999 [00:37&lt;08:06,  1.89it/s]  8%|▊         | 80/999 [00:37&lt;08:01,  1.91it/s]  8%|▊         | 81/999 [00:38&lt;07:47,  1.96it/s]  8%|▊         | 82/999 [00:38&lt;07:46,  1.97it/s]  8%|▊         | 83/999 [00:39&lt;07:37,  2.00it/s]  8%|▊         | 84/999 [00:39&lt;07:39,  1.99it/s]  9%|▊         | 85/999 [00:40&lt;07:41,  1.98it/s]  9%|▊         | 86/999 [00:40&lt;07:39,  1.99it/s]  9%|▊         | 87/999 [00:41&lt;07:42,  1.97it/s]  9%|▉         | 88/999 [00:41&lt;07:31,  2.02it/s]  9%|▉         | 89/999 [00:42&lt;07:26,  2.04it/s]  9%|▉         | 90/999 [00:42&lt;07:11,  2.11it/s]  9%|▉         | 91/999 [00:43&lt;07:16,  2.08it/s]  9%|▉         | 92/999 [00:43&lt;07:15,  2.08it/s]  9%|▉         | 93/999 [00:43&lt;06:51,  2.20it/s]  9%|▉         | 94/999 [00:44&lt;07:07,  2.11it/s] 10%|▉         | 95/999 [00:44&lt;07:23,  2.04it/s] 10%|▉         | 96/999 [00:45&lt;07:25,  2.03it/s] 10%|▉         | 97/999 [00:45&lt;07:35,  1.98it/s] 10%|▉         | 98/999 [00:46&lt;07:38,  1.96it/s] 10%|▉         | 99/999 [00:47&lt;07:37,  1.97it/s] 10%|█         | 100/999 [00:47&lt;07:47,  1.92it/s] 10%|█         | 101/999 [00:48&lt;07:42,  1.94it/s] 10%|█         | 102/999 [00:48&lt;07:54,  1.89it/s] 10%|█         | 103/999 [00:49&lt;07:43,  1.93it/s] 10%|█         | 104/999 [00:49&lt;07:34,  1.97it/s] 11%|█         | 105/999 [00:50&lt;07:23,  2.01it/s] 11%|█         | 106/999 [00:50&lt;07:29,  1.99it/s] 11%|█         | 107/999 [00:51&lt;07:27,  1.99it/s] 11%|█         | 108/999 [00:51&lt;07:42,  1.92it/s] 11%|█         | 109/999 [00:52&lt;07:42,  1.92it/s] 11%|█         | 110/999 [00:52&lt;07:36,  1.95it/s] 11%|█         | 111/999 [00:53&lt;07:37,  1.94it/s] 11%|█         | 112/999 [00:53&lt;07:46,  1.90it/s] 11%|█▏        | 113/999 [00:54&lt;07:52,  1.88it/s] 11%|█▏        | 114/999 [00:54&lt;07:46,  1.90it/s] 12%|█▏        | 115/999 [00:55&lt;07:46,  1.90it/s] 12%|█▏        | 116/999 [00:55&lt;07:40,  1.92it/s] 12%|█▏        | 117/999 [00:56&lt;07:42,  1.91it/s] 12%|█▏        | 118/999 [00:56&lt;07:43,  1.90it/s] 12%|█▏        | 119/999 [00:57&lt;07:48,  1.88it/s] 12%|█▏        | 120/999 [00:57&lt;07:39,  1.91it/s] 12%|█▏        | 121/999 [00:58&lt;07:43,  1.90it/s] 12%|█▏        | 122/999 [00:59&lt;08:00,  1.83it/s] 12%|█▏        | 123/999 [00:59&lt;07:57,  1.83it/s] 12%|█▏        | 124/999 [01:00&lt;08:07,  1.80it/s] 13%|█▎        | 125/999 [01:00&lt;08:03,  1.81it/s] 13%|█▎        | 126/999 [01:01&lt;08:09,  1.78it/s] 13%|█▎        | 127/999 [01:01&lt;08:04,  1.80it/s] 13%|█▎        | 128/999 [01:02&lt;07:53,  1.84it/s] 13%|█▎        | 129/999 [01:02&lt;07:47,  1.86it/s] 13%|█▎        | 130/999 [01:03&lt;07:50,  1.85it/s] 13%|█▎        | 131/999 [01:04&lt;07:48,  1.85it/s] 13%|█▎        | 132/999 [01:04&lt;07:37,  1.89it/s] 13%|█▎        | 133/999 [01:04&lt;07:29,  1.93it/s] 13%|█▎        | 134/999 [01:05&lt;07:19,  1.97it/s] 14%|█▎        | 135/999 [01:06&lt;07:23,  1.95it/s] 14%|█▎        | 136/999 [01:06&lt;07:29,  1.92it/s] 14%|█▎        | 137/999 [01:07&lt;07:33,  1.90it/s] 14%|█▍        | 138/999 [01:07&lt;07:24,  1.94it/s] 14%|█▍        | 139/999 [01:08&lt;07:39,  1.87it/s] 14%|█▍        | 140/999 [01:08&lt;07:44,  1.85it/s] 14%|█▍        | 141/999 [01:09&lt;07:38,  1.87it/s] 14%|█▍        | 142/999 [01:09&lt;07:29,  1.91it/s] 14%|█▍        | 143/999 [01:10&lt;07:19,  1.95it/s] 14%|█▍        | 144/999 [01:10&lt;07:12,  1.98it/s] 15%|█▍        | 145/999 [01:11&lt;07:07,  2.00it/s] 15%|█▍        | 146/999 [01:11&lt;07:05,  2.00it/s] 15%|█▍        | 147/999 [01:12&lt;07:16,  1.95it/s] 15%|█▍        | 148/999 [01:12&lt;07:45,  1.83it/s] 15%|█▍        | 149/999 [01:13&lt;07:45,  1.83it/s] 15%|█▌        | 150/999 [01:14&lt;07:54,  1.79it/s] 15%|█▌        | 151/999 [01:14&lt;07:58,  1.77it/s] 15%|█▌        | 152/999 [01:15&lt;07:43,  1.83it/s] 15%|█▌        | 153/999 [01:15&lt;07:46,  1.81it/s] 15%|█▌        | 154/999 [01:16&lt;07:46,  1.81it/s] 16%|█▌        | 155/999 [01:16&lt;07:54,  1.78it/s] 16%|█▌        | 156/999 [01:17&lt;08:07,  1.73it/s] 16%|█▌        | 157/999 [01:18&lt;08:14,  1.70it/s] 16%|█▌        | 158/999 [01:18&lt;07:59,  1.75it/s] 16%|█▌        | 159/999 [01:19&lt;07:58,  1.75it/s] 16%|█▌        | 160/999 [01:19&lt;08:07,  1.72it/s] 16%|█▌        | 161/999 [01:20&lt;08:05,  1.73it/s] 16%|█▌        | 162/999 [01:20&lt;08:09,  1.71it/s] 16%|█▋        | 163/999 [01:21&lt;08:13,  1.69it/s] 16%|█▋        | 164/999 [01:22&lt;08:23,  1.66it/s] 17%|█▋        | 165/999 [01:22&lt;08:22,  1.66it/s] 17%|█▋        | 166/999 [01:23&lt;08:20,  1.67it/s] 17%|█▋        | 167/999 [01:23&lt;08:19,  1.66it/s] 17%|█▋        | 168/999 [01:24&lt;08:19,  1.66it/s] 17%|█▋        | 169/999 [01:25&lt;08:08,  1.70it/s] 17%|█▋        | 170/999 [01:25&lt;08:12,  1.68it/s] 17%|█▋        | 171/999 [01:26&lt;08:05,  1.70it/s] 17%|█▋        | 172/999 [01:26&lt;08:20,  1.65it/s] 17%|█▋        | 173/999 [01:27&lt;08:15,  1.67it/s] 17%|█▋        | 174/999 [01:28&lt;08:06,  1.69it/s] 18%|█▊        | 175/999 [01:28&lt;08:11,  1.68it/s] 18%|█▊        | 176/999 [01:29&lt;08:13,  1.67it/s] 18%|█▊        | 177/999 [01:29&lt;08:23,  1.63it/s] 18%|█▊        | 178/999 [01:30&lt;08:15,  1.66it/s] 18%|█▊        | 179/999 [01:31&lt;08:13,  1.66it/s] 18%|█▊        | 180/999 [01:31&lt;08:03,  1.69it/s] 18%|█▊        | 181/999 [01:32&lt;08:05,  1.68it/s] 18%|█▊        | 182/999 [01:32&lt;08:02,  1.69it/s] 18%|█▊        | 183/999 [01:33&lt;08:23,  1.62it/s] 18%|█▊        | 184/999 [01:34&lt;08:12,  1.66it/s] 19%|█▊        | 185/999 [01:34&lt;08:20,  1.63it/s] 19%|█▊        | 186/999 [01:35&lt;08:34,  1.58it/s] 19%|█▊        | 187/999 [01:36&lt;08:31,  1.59it/s] 19%|█▉        | 188/999 [01:36&lt;08:38,  1.56it/s] 19%|█▉        | 189/999 [01:37&lt;08:30,  1.59it/s] 19%|█▉        | 190/999 [01:37&lt;08:26,  1.60it/s] 19%|█▉        | 191/999 [01:38&lt;08:10,  1.65it/s] 19%|█▉        | 192/999 [01:39&lt;08:18,  1.62it/s] 19%|█▉        | 193/999 [01:39&lt;08:03,  1.67it/s] 19%|█▉        | 194/999 [01:40&lt;07:45,  1.73it/s] 20%|█▉        | 195/999 [01:40&lt;07:36,  1.76it/s] 20%|█▉        | 196/999 [01:41&lt;07:40,  1.74it/s] 20%|█▉        | 197/999 [01:41&lt;07:50,  1.70it/s] 20%|█▉        | 198/999 [01:42&lt;07:42,  1.73it/s] 20%|█▉        | 199/999 [01:43&lt;07:36,  1.75it/s] 20%|██        | 200/999 [01:43&lt;07:51,  1.69it/s] 20%|██        | 201/999 [01:44&lt;07:43,  1.72it/s] 20%|██        | 202/999 [01:44&lt;07:41,  1.73it/s] 20%|██        | 203/999 [01:45&lt;07:36,  1.74it/s] 20%|██        | 204/999 [01:45&lt;07:13,  1.83it/s] 21%|██        | 205/999 [01:46&lt;07:06,  1.86it/s] 21%|██        | 206/999 [01:46&lt;07:08,  1.85it/s] 21%|██        | 207/999 [01:47&lt;07:24,  1.78it/s] 21%|██        | 208/999 [01:48&lt;07:26,  1.77it/s] 21%|██        | 209/999 [01:48&lt;07:48,  1.69it/s] 21%|██        | 210/999 [01:49&lt;07:58,  1.65it/s] 21%|██        | 211/999 [01:50&lt;08:06,  1.62it/s] 21%|██        | 212/999 [01:50&lt;08:02,  1.63it/s] 21%|██▏       | 213/999 [01:51&lt;08:08,  1.61it/s] 21%|██▏       | 214/999 [01:51&lt;07:57,  1.64it/s] 22%|██▏       | 215/999 [01:52&lt;07:56,  1.65it/s] 22%|██▏       | 216/999 [01:53&lt;07:50,  1.67it/s] 22%|██▏       | 217/999 [01:53&lt;07:39,  1.70it/s] 22%|██▏       | 218/999 [01:54&lt;07:40,  1.70it/s] 22%|██▏       | 219/999 [01:54&lt;07:33,  1.72it/s] 22%|██▏       | 220/999 [01:55&lt;07:37,  1.70it/s] 22%|██▏       | 221/999 [01:56&lt;07:41,  1.69it/s] 22%|██▏       | 222/999 [01:56&lt;07:31,  1.72it/s] 22%|██▏       | 223/999 [01:57&lt;07:21,  1.76it/s] 22%|██▏       | 224/999 [01:57&lt;07:26,  1.73it/s] 23%|██▎       | 225/999 [01:58&lt;07:42,  1.67it/s] 23%|██▎       | 226/999 [01:58&lt;07:40,  1.68it/s] 23%|██▎       | 227/999 [01:59&lt;07:26,  1.73it/s] 23%|██▎       | 228/999 [02:00&lt;07:27,  1.72it/s] 23%|██▎       | 229/999 [02:00&lt;07:17,  1.76it/s] 23%|██▎       | 230/999 [02:01&lt;07:30,  1.71it/s] 23%|██▎       | 231/999 [02:01&lt;07:26,  1.72it/s] 23%|██▎       | 232/999 [02:02&lt;07:28,  1.71it/s] 23%|██▎       | 233/999 [02:02&lt;07:33,  1.69it/s] 23%|██▎       | 234/999 [02:03&lt;07:29,  1.70it/s] 24%|██▎       | 235/999 [02:04&lt;07:28,  1.70it/s] 24%|██▎       | 236/999 [02:04&lt;07:32,  1.69it/s] 24%|██▎       | 237/999 [02:05&lt;07:37,  1.67it/s] 24%|██▍       | 238/999 [02:06&lt;07:55,  1.60it/s] 24%|██▍       | 239/999 [02:06&lt;08:02,  1.57it/s] 24%|██▍       | 240/999 [02:07&lt;08:10,  1.55it/s] 24%|██▍       | 241/999 [02:08&lt;08:06,  1.56it/s] 24%|██▍       | 242/999 [02:08&lt;08:12,  1.54it/s] 24%|██▍       | 243/999 [02:09&lt;08:23,  1.50it/s] 24%|██▍       | 244/999 [02:10&lt;08:25,  1.49it/s] 25%|██▍       | 245/999 [02:10&lt;08:22,  1.50it/s] 25%|██▍       | 246/999 [02:11&lt;08:28,  1.48it/s] 25%|██▍       | 247/999 [02:12&lt;08:23,  1.49it/s] 25%|██▍       | 248/999 [02:12&lt;08:31,  1.47it/s] 25%|██▍       | 249/999 [02:13&lt;08:32,  1.46it/s] 25%|██▌       | 250/999 [02:14&lt;08:32,  1.46it/s] 25%|██▌       | 251/999 [02:14&lt;08:28,  1.47it/s] 25%|██▌       | 252/999 [02:15&lt;08:24,  1.48it/s] 25%|██▌       | 253/999 [02:16&lt;08:32,  1.45it/s] 25%|██▌       | 254/999 [02:16&lt;08:45,  1.42it/s] 26%|██▌       | 255/999 [02:17&lt;08:30,  1.46it/s] 26%|██▌       | 256/999 [02:18&lt;08:19,  1.49it/s] 26%|██▌       | 257/999 [02:18&lt;08:08,  1.52it/s] 26%|██▌       | 258/999 [02:19&lt;08:10,  1.51it/s] 26%|██▌       | 259/999 [02:20&lt;07:59,  1.54it/s] 26%|██▌       | 260/999 [02:20&lt;07:56,  1.55it/s] 26%|██▌       | 261/999 [02:21&lt;07:49,  1.57it/s] 26%|██▌       | 262/999 [02:21&lt;07:32,  1.63it/s] 26%|██▋       | 263/999 [02:22&lt;07:30,  1.63it/s] 26%|██▋       | 264/999 [02:23&lt;07:42,  1.59it/s] 27%|██▋       | 265/999 [02:23&lt;07:42,  1.59it/s] 27%|██▋       | 266/999 [02:24&lt;07:35,  1.61it/s] 27%|██▋       | 267/999 [02:25&lt;07:33,  1.61it/s] 27%|██▋       | 268/999 [02:25&lt;07:45,  1.57it/s] 27%|██▋       | 269/999 [02:26&lt;07:42,  1.58it/s] 27%|██▋       | 270/999 [02:27&lt;07:48,  1.56it/s] 27%|██▋       | 271/999 [02:27&lt;07:38,  1.59it/s] 27%|██▋       | 272/999 [02:28&lt;07:45,  1.56it/s] 27%|██▋       | 273/999 [02:28&lt;07:49,  1.55it/s] 27%|██▋       | 274/999 [02:29&lt;07:44,  1.56it/s] 28%|██▊       | 275/999 [02:30&lt;07:48,  1.55it/s] 28%|██▊       | 276/999 [02:30&lt;07:48,  1.54it/s] 28%|██▊       | 277/999 [02:31&lt;07:40,  1.57it/s] 28%|██▊       | 278/999 [02:32&lt;07:41,  1.56it/s] 28%|██▊       | 279/999 [02:32&lt;07:41,  1.56it/s] 28%|██▊       | 280/999 [02:33&lt;07:54,  1.52it/s] 28%|██▊       | 281/999 [02:34&lt;07:56,  1.51it/s] 28%|██▊       | 282/999 [02:34&lt;08:04,  1.48it/s] 28%|██▊       | 283/999 [02:35&lt;08:11,  1.46it/s] 28%|██▊       | 284/999 [02:36&lt;08:23,  1.42it/s] 29%|██▊       | 285/999 [02:37&lt;08:33,  1.39it/s] 29%|██▊       | 286/999 [02:37&lt;08:23,  1.42it/s] 29%|██▊       | 287/999 [02:38&lt;08:30,  1.39it/s] 29%|██▉       | 288/999 [02:39&lt;08:16,  1.43it/s] 29%|██▉       | 289/999 [02:39&lt;08:29,  1.39it/s] 29%|██▉       | 290/999 [02:40&lt;08:27,  1.40it/s] 29%|██▉       | 291/999 [02:41&lt;08:21,  1.41it/s] 29%|██▉       | 292/999 [02:42&lt;08:17,  1.42it/s] 29%|██▉       | 293/999 [02:42&lt;08:11,  1.44it/s] 29%|██▉       | 294/999 [02:43&lt;08:09,  1.44it/s] 30%|██▉       | 295/999 [02:44&lt;08:12,  1.43it/s] 30%|██▉       | 296/999 [02:44&lt;08:21,  1.40it/s] 30%|██▉       | 297/999 [02:45&lt;08:23,  1.39it/s] 30%|██▉       | 298/999 [02:46&lt;08:34,  1.36it/s] 30%|██▉       | 299/999 [02:47&lt;08:17,  1.41it/s] 30%|███       | 300/999 [02:47&lt;08:17,  1.41it/s] 30%|███       | 301/999 [02:48&lt;08:22,  1.39it/s] 30%|███       | 302/999 [02:49&lt;08:19,  1.39it/s] 30%|███       | 303/999 [02:49&lt;08:19,  1.39it/s] 30%|███       | 304/999 [02:50&lt;08:16,  1.40it/s] 31%|███       | 305/999 [02:51&lt;08:14,  1.40it/s] 31%|███       | 306/999 [02:52&lt;08:04,  1.43it/s] 31%|███       | 307/999 [02:52&lt;07:59,  1.44it/s] 31%|███       | 308/999 [02:53&lt;07:49,  1.47it/s] 31%|███       | 309/999 [02:54&lt;07:55,  1.45it/s] 31%|███       | 310/999 [02:54&lt;08:00,  1.43it/s] 31%|███       | 311/999 [02:55&lt;08:03,  1.42it/s] 31%|███       | 312/999 [02:56&lt;08:11,  1.40it/s] 31%|███▏      | 313/999 [02:56&lt;08:11,  1.40it/s] 31%|███▏      | 314/999 [02:57&lt;08:04,  1.41it/s] 32%|███▏      | 315/999 [02:58&lt;08:06,  1.41it/s] 32%|███▏      | 316/999 [02:59&lt;08:05,  1.41it/s] 32%|███▏      | 317/999 [02:59&lt;08:03,  1.41it/s] 32%|███▏      | 318/999 [03:00&lt;07:56,  1.43it/s] 32%|███▏      | 319/999 [03:01&lt;08:07,  1.39it/s] 32%|███▏      | 320/999 [03:01&lt;08:11,  1.38it/s] 32%|███▏      | 321/999 [03:02&lt;08:24,  1.34it/s] 32%|███▏      | 322/999 [03:03&lt;08:10,  1.38it/s] 32%|███▏      | 323/999 [03:04&lt;08:09,  1.38it/s] 32%|███▏      | 324/999 [03:04&lt;08:10,  1.38it/s] 33%|███▎      | 325/999 [03:05&lt;07:55,  1.42it/s] 33%|███▎      | 326/999 [03:06&lt;07:52,  1.42it/s] 33%|███▎      | 327/999 [03:06&lt;08:04,  1.39it/s] 33%|███▎      | 328/999 [03:07&lt;07:56,  1.41it/s] 33%|███▎      | 329/999 [03:08&lt;07:56,  1.41it/s] 33%|███▎      | 330/999 [03:09&lt;07:52,  1.41it/s] 33%|███▎      | 331/999 [03:09&lt;08:01,  1.39it/s] 33%|███▎      | 332/999 [03:10&lt;07:52,  1.41it/s] 33%|███▎      | 333/999 [03:11&lt;07:51,  1.41it/s] 33%|███▎      | 334/999 [03:11&lt;07:47,  1.42it/s] 34%|███▎      | 335/999 [03:12&lt;07:43,  1.43it/s] 34%|███▎      | 336/999 [03:13&lt;07:50,  1.41it/s] 34%|███▎      | 337/999 [03:14&lt;07:47,  1.41it/s] 34%|███▍      | 338/999 [03:14&lt;07:55,  1.39it/s] 34%|███▍      | 339/999 [03:15&lt;07:43,  1.42it/s] 34%|███▍      | 340/999 [03:16&lt;07:35,  1.45it/s] 34%|███▍      | 341/999 [03:16&lt;07:41,  1.43it/s] 34%|███▍      | 342/999 [03:17&lt;07:35,  1.44it/s] 34%|███▍      | 343/999 [03:18&lt;07:34,  1.44it/s] 34%|███▍      | 344/999 [03:18&lt;07:38,  1.43it/s] 35%|███▍      | 345/999 [03:19&lt;07:31,  1.45it/s] 35%|███▍      | 346/999 [03:20&lt;07:34,  1.44it/s] 35%|███▍      | 347/999 [03:21&lt;07:36,  1.43it/s] 35%|███▍      | 348/999 [03:21&lt;07:40,  1.41it/s] 35%|███▍      | 349/999 [03:22&lt;07:31,  1.44it/s] 35%|███▌      | 350/999 [03:23&lt;07:31,  1.44it/s] 35%|███▌      | 351/999 [03:23&lt;07:37,  1.42it/s] 35%|███▌      | 352/999 [03:24&lt;07:38,  1.41it/s] 35%|███▌      | 353/999 [03:25&lt;07:42,  1.40it/s] 35%|███▌      | 354/999 [03:25&lt;07:40,  1.40it/s] 36%|███▌      | 355/999 [03:26&lt;07:32,  1.42it/s] 36%|███▌      | 356/999 [03:27&lt;07:26,  1.44it/s] 36%|███▌      | 357/999 [03:28&lt;07:23,  1.45it/s] 36%|███▌      | 358/999 [03:28&lt;07:19,  1.46it/s] 36%|███▌      | 359/999 [03:29&lt;07:27,  1.43it/s] 36%|███▌      | 360/999 [03:30&lt;07:22,  1.44it/s] 36%|███▌      | 361/999 [03:30&lt;07:36,  1.40it/s] 36%|███▌      | 362/999 [03:31&lt;07:30,  1.42it/s] 36%|███▋      | 363/999 [03:32&lt;07:20,  1.44it/s] 36%|███▋      | 364/999 [03:32&lt;07:15,  1.46it/s] 37%|███▋      | 365/999 [03:33&lt;07:17,  1.45it/s] 37%|███▋      | 366/999 [03:34&lt;07:04,  1.49it/s] 37%|███▋      | 367/999 [03:34&lt;07:07,  1.48it/s] 37%|███▋      | 368/999 [03:35&lt;07:07,  1.48it/s] 37%|███▋      | 369/999 [03:36&lt;07:08,  1.47it/s] 37%|███▋      | 370/999 [03:36&lt;07:06,  1.47it/s] 37%|███▋      | 371/999 [03:37&lt;07:04,  1.48it/s] 37%|███▋      | 372/999 [03:38&lt;06:59,  1.49it/s] 37%|███▋      | 373/999 [03:38&lt;06:56,  1.50it/s] 37%|███▋      | 374/999 [03:39&lt;06:55,  1.50it/s] 38%|███▊      | 375/999 [03:40&lt;06:49,  1.53it/s] 38%|███▊      | 376/999 [03:40&lt;06:48,  1.53it/s] 38%|███▊      | 377/999 [03:41&lt;06:48,  1.52it/s] 38%|███▊      | 378/999 [03:42&lt;06:52,  1.51it/s] 38%|███▊      | 379/999 [03:42&lt;06:50,  1.51it/s] 38%|███▊      | 380/999 [03:43&lt;06:59,  1.48it/s] 38%|███▊      | 381/999 [03:44&lt;07:05,  1.45it/s] 38%|███▊      | 382/999 [03:44&lt;06:53,  1.49it/s] 38%|███▊      | 383/999 [03:45&lt;06:50,  1.50it/s] 38%|███▊      | 384/999 [03:46&lt;07:00,  1.46it/s] 39%|███▊      | 385/999 [03:46&lt;07:01,  1.46it/s] 39%|███▊      | 386/999 [03:47&lt;07:01,  1.45it/s] 39%|███▊      | 387/999 [03:48&lt;06:45,  1.51it/s] 39%|███▉      | 388/999 [03:48&lt;06:52,  1.48it/s] 39%|███▉      | 389/999 [03:49&lt;06:51,  1.48it/s] 39%|███▉      | 390/999 [03:50&lt;06:50,  1.49it/s] 39%|███▉      | 391/999 [03:51&lt;06:52,  1.47it/s] 39%|███▉      | 392/999 [03:51&lt;06:58,  1.45it/s] 39%|███▉      | 393/999 [03:52&lt;07:01,  1.44it/s] 39%|███▉      | 394/999 [03:53&lt;06:57,  1.45it/s] 40%|███▉      | 395/999 [03:53&lt;06:57,  1.45it/s] 40%|███▉      | 396/999 [03:54&lt;07:02,  1.43it/s] 40%|███▉      | 397/999 [03:55&lt;07:04,  1.42it/s] 40%|███▉      | 398/999 [03:56&lt;07:12,  1.39it/s] 40%|███▉      | 399/999 [03:56&lt;07:19,  1.36it/s] 40%|████      | 400/999 [03:57&lt;07:20,  1.36it/s] 40%|████      | 401/999 [03:58&lt;07:17,  1.37it/s] 40%|████      | 402/999 [03:58&lt;07:11,  1.38it/s] 40%|████      | 403/999 [03:59&lt;07:43,  1.29it/s] 40%|████      | 404/999 [04:00&lt;07:26,  1.33it/s] 41%|████      | 405/999 [04:01&lt;07:14,  1.37it/s] 41%|████      | 406/999 [04:01&lt;07:01,  1.41it/s] 41%|████      | 407/999 [04:02&lt;06:55,  1.42it/s] 41%|████      | 408/999 [04:03&lt;06:52,  1.43it/s] 41%|████      | 409/999 [04:03&lt;06:56,  1.42it/s] 41%|████      | 410/999 [04:04&lt;06:53,  1.42it/s] 41%|████      | 411/999 [04:05&lt;07:00,  1.40it/s] 41%|████      | 412/999 [04:06&lt;06:48,  1.44it/s] 41%|████▏     | 413/999 [04:06&lt;06:42,  1.46it/s] 41%|████▏     | 414/999 [04:07&lt;06:42,  1.45it/s] 42%|████▏     | 415/999 [04:08&lt;06:44,  1.44it/s] 42%|████▏     | 416/999 [04:08&lt;06:53,  1.41it/s] 42%|████▏     | 417/999 [04:09&lt;06:59,  1.39it/s] 42%|████▏     | 418/999 [04:10&lt;06:55,  1.40it/s] 42%|████▏     | 419/999 [04:11&lt;07:03,  1.37it/s] 42%|████▏     | 420/999 [04:11&lt;07:06,  1.36it/s] 42%|████▏     | 421/999 [04:12&lt;07:06,  1.36it/s] 42%|████▏     | 422/999 [04:13&lt;07:09,  1.34it/s] 42%|████▏     | 423/999 [04:14&lt;07:09,  1.34it/s] 42%|████▏     | 424/999 [04:14&lt;07:06,  1.35it/s] 43%|████▎     | 425/999 [04:15&lt;07:09,  1.34it/s] 43%|████▎     | 426/999 [04:16&lt;07:03,  1.35it/s] 43%|████▎     | 427/999 [04:17&lt;07:12,  1.32it/s] 43%|████▎     | 428/999 [04:17&lt;07:04,  1.35it/s] 43%|████▎     | 429/999 [04:18&lt;07:16,  1.31it/s] 43%|████▎     | 430/999 [04:19&lt;07:02,  1.35it/s] 43%|████▎     | 431/999 [04:19&lt;06:45,  1.40it/s] 43%|████▎     | 432/999 [04:20&lt;06:35,  1.43it/s] 43%|████▎     | 433/999 [04:21&lt;06:32,  1.44it/s] 43%|████▎     | 434/999 [04:22&lt;06:41,  1.41it/s] 44%|████▎     | 435/999 [04:22&lt;06:37,  1.42it/s] 44%|████▎     | 436/999 [04:23&lt;06:44,  1.39it/s] 44%|████▎     | 437/999 [04:24&lt;06:49,  1.37it/s] 44%|████▍     | 438/999 [04:24&lt;06:43,  1.39it/s] 44%|████▍     | 439/999 [04:25&lt;06:40,  1.40it/s] 44%|████▍     | 440/999 [04:26&lt;06:45,  1.38it/s] 44%|████▍     | 441/999 [04:27&lt;06:39,  1.40it/s] 44%|████▍     | 442/999 [04:27&lt;06:38,  1.40it/s] 44%|████▍     | 443/999 [04:28&lt;06:38,  1.39it/s] 44%|████▍     | 444/999 [04:29&lt;06:23,  1.45it/s] 45%|████▍     | 445/999 [04:29&lt;06:29,  1.42it/s] 45%|████▍     | 446/999 [04:30&lt;06:32,  1.41it/s] 45%|████▍     | 447/999 [04:31&lt;06:33,  1.40it/s] 45%|████▍     | 448/999 [04:32&lt;06:23,  1.44it/s] 45%|████▍     | 449/999 [04:32&lt;06:25,  1.43it/s] 45%|████▌     | 450/999 [04:33&lt;06:32,  1.40it/s] 45%|████▌     | 451/999 [04:34&lt;06:32,  1.40it/s] 45%|████▌     | 452/999 [04:34&lt;06:43,  1.36it/s] 45%|████▌     | 453/999 [04:35&lt;06:46,  1.34it/s] 45%|████▌     | 454/999 [04:36&lt;06:47,  1.34it/s] 46%|████▌     | 455/999 [04:37&lt;06:40,  1.36it/s] 46%|████▌     | 456/999 [04:37&lt;06:35,  1.37it/s] 46%|████▌     | 457/999 [04:38&lt;06:31,  1.38it/s] 46%|████▌     | 458/999 [04:39&lt;06:36,  1.36it/s] 46%|████▌     | 459/999 [04:40&lt;06:41,  1.34it/s] 46%|████▌     | 460/999 [04:40&lt;06:39,  1.35it/s] 46%|████▌     | 461/999 [04:41&lt;06:49,  1.31it/s] 46%|████▌     | 462/999 [04:42&lt;06:35,  1.36it/s] 46%|████▋     | 463/999 [04:43&lt;06:32,  1.37it/s] 46%|████▋     | 464/999 [04:43&lt;06:36,  1.35it/s] 47%|████▋     | 465/999 [04:44&lt;06:37,  1.34it/s] 47%|████▋     | 466/999 [04:45&lt;06:40,  1.33it/s] 47%|████▋     | 467/999 [04:46&lt;06:27,  1.37it/s] 47%|████▋     | 468/999 [04:46&lt;06:21,  1.39it/s] 47%|████▋     | 469/999 [04:47&lt;06:15,  1.41it/s] 47%|████▋     | 470/999 [04:48&lt;06:20,  1.39it/s] 47%|████▋     | 471/999 [04:48&lt;06:26,  1.37it/s] 47%|████▋     | 472/999 [04:49&lt;06:31,  1.35it/s] 47%|████▋     | 473/999 [04:50&lt;06:36,  1.33it/s] 47%|████▋     | 474/999 [04:51&lt;06:21,  1.38it/s] 48%|████▊     | 475/999 [04:51&lt;06:16,  1.39it/s] 48%|████▊     | 476/999 [04:52&lt;06:09,  1.41it/s] 48%|████▊     | 477/999 [04:53&lt;06:06,  1.42it/s] 48%|████▊     | 478/999 [04:53&lt;06:12,  1.40it/s] 48%|████▊     | 479/999 [04:54&lt;06:15,  1.38it/s] 48%|████▊     | 480/999 [04:55&lt;06:16,  1.38it/s] 48%|████▊     | 481/999 [04:56&lt;06:26,  1.34it/s] 48%|████▊     | 482/999 [04:56&lt;06:23,  1.35it/s] 48%|████▊     | 483/999 [04:57&lt;06:24,  1.34it/s] 48%|████▊     | 484/999 [04:58&lt;06:09,  1.39it/s] 49%|████▊     | 485/999 [04:59&lt;06:07,  1.40it/s] 49%|████▊     | 486/999 [04:59&lt;05:59,  1.43it/s] 49%|████▊     | 487/999 [05:00&lt;06:05,  1.40it/s] 49%|████▉     | 488/999 [05:01&lt;06:04,  1.40it/s] 49%|████▉     | 489/999 [05:01&lt;06:01,  1.41it/s] 49%|████▉     | 490/999 [05:02&lt;05:51,  1.45it/s] 49%|████▉     | 491/999 [05:03&lt;05:44,  1.48it/s] 49%|████▉     | 492/999 [05:03&lt;05:40,  1.49it/s] 49%|████▉     | 493/999 [05:04&lt;05:46,  1.46it/s] 49%|████▉     | 494/999 [05:05&lt;05:52,  1.43it/s] 50%|████▉     | 495/999 [05:05&lt;05:51,  1.43it/s] 50%|████▉     | 496/999 [05:06&lt;05:56,  1.41it/s] 50%|████▉     | 497/999 [05:07&lt;06:00,  1.39it/s] 50%|████▉     | 498/999 [05:08&lt;06:16,  1.33it/s] 50%|████▉     | 499/999 [05:08&lt;05:53,  1.41it/s] 50%|█████     | 500/999 [05:09&lt;05:48,  1.43it/s] 50%|█████     | 501/999 [05:10&lt;05:37,  1.47it/s] 50%|█████     | 502/999 [05:10&lt;05:51,  1.41it/s] 50%|█████     | 503/999 [05:11&lt;05:42,  1.45it/s] 50%|█████     | 504/999 [05:12&lt;05:31,  1.49it/s] 51%|█████     | 505/999 [05:12&lt;05:29,  1.50it/s] 51%|█████     | 506/999 [05:13&lt;05:35,  1.47it/s] 51%|█████     | 507/999 [05:14&lt;05:38,  1.45it/s] 51%|█████     | 508/999 [05:14&lt;05:25,  1.51it/s] 51%|█████     | 509/999 [05:15&lt;05:22,  1.52it/s] 51%|█████     | 510/999 [05:16&lt;05:30,  1.48it/s] 51%|█████     | 511/999 [05:16&lt;05:20,  1.52it/s] 51%|█████▏    | 512/999 [05:17&lt;05:14,  1.55it/s] 51%|█████▏    | 513/999 [05:18&lt;05:11,  1.56it/s] 51%|█████▏    | 514/999 [05:18&lt;05:12,  1.55it/s] 52%|█████▏    | 515/999 [05:19&lt;05:17,  1.53it/s] 52%|█████▏    | 516/999 [05:20&lt;05:13,  1.54it/s] 52%|█████▏    | 517/999 [05:20&lt;05:13,  1.54it/s] 52%|█████▏    | 518/999 [05:21&lt;05:13,  1.53it/s] 52%|█████▏    | 519/999 [05:22&lt;05:10,  1.55it/s] 52%|█████▏    | 520/999 [05:22&lt;05:05,  1.57it/s] 52%|█████▏    | 521/999 [05:23&lt;05:07,  1.55it/s] 52%|█████▏    | 522/999 [05:23&lt;05:06,  1.56it/s] 52%|█████▏    | 523/999 [05:24&lt;05:00,  1.59it/s] 52%|█████▏    | 524/999 [05:25&lt;05:06,  1.55it/s] 53%|█████▎    | 525/999 [05:26&lt;05:21,  1.47it/s] 53%|█████▎    | 526/999 [05:26&lt;05:22,  1.46it/s] 53%|█████▎    | 527/999 [05:27&lt;05:15,  1.49it/s] 53%|█████▎    | 528/999 [05:28&lt;05:16,  1.49it/s] 53%|█████▎    | 529/999 [05:28&lt;05:13,  1.50it/s] 53%|█████▎    | 530/999 [05:29&lt;05:24,  1.44it/s] 53%|█████▎    | 531/999 [05:30&lt;05:24,  1.44it/s] 53%|█████▎    | 532/999 [05:30&lt;05:26,  1.43it/s] 53%|█████▎    | 533/999 [05:31&lt;05:31,  1.41it/s] 53%|█████▎    | 534/999 [05:32&lt;05:26,  1.43it/s] 54%|█████▎    | 535/999 [05:32&lt;05:19,  1.45it/s] 54%|█████▎    | 536/999 [05:33&lt;05:18,  1.45it/s] 54%|█████▍    | 537/999 [05:34&lt;05:17,  1.45it/s] 54%|█████▍    | 538/999 [05:34&lt;05:11,  1.48it/s] 54%|█████▍    | 539/999 [05:35&lt;05:06,  1.50it/s] 54%|█████▍    | 540/999 [05:36&lt;05:01,  1.52it/s] 54%|█████▍    | 541/999 [05:36&lt;05:00,  1.53it/s] 54%|█████▍    | 542/999 [05:37&lt;04:57,  1.53it/s] 54%|█████▍    | 543/999 [05:38&lt;05:07,  1.49it/s] 54%|█████▍    | 544/999 [05:38&lt;05:09,  1.47it/s] 55%|█████▍    | 545/999 [05:39&lt;05:12,  1.45it/s] 55%|█████▍    | 546/999 [05:40&lt;05:10,  1.46it/s] 55%|█████▍    | 547/999 [05:41&lt;05:12,  1.45it/s] 55%|█████▍    | 548/999 [05:41&lt;05:08,  1.46it/s] 55%|█████▍    | 549/999 [05:42&lt;05:02,  1.49it/s] 55%|█████▌    | 550/999 [05:43&lt;05:01,  1.49it/s] 55%|█████▌    | 551/999 [05:43&lt;05:08,  1.45it/s] 55%|█████▌    | 552/999 [05:44&lt;05:02,  1.48it/s] 55%|█████▌    | 553/999 [05:45&lt;05:02,  1.47it/s] 55%|█████▌    | 554/999 [05:45&lt;05:05,  1.46it/s] 56%|█████▌    | 555/999 [05:46&lt;05:07,  1.44it/s] 56%|█████▌    | 556/999 [05:47&lt;05:06,  1.45it/s] 56%|█████▌    | 557/999 [05:47&lt;05:08,  1.43it/s] 56%|█████▌    | 558/999 [05:48&lt;05:07,  1.43it/s] 56%|█████▌    | 559/999 [05:49&lt;05:09,  1.42it/s] 56%|█████▌    | 560/999 [05:49&lt;05:07,  1.43it/s] 56%|█████▌    | 561/999 [05:50&lt;05:03,  1.44it/s] 56%|█████▋    | 562/999 [05:51&lt;05:02,  1.44it/s] 56%|█████▋    | 563/999 [05:52&lt;05:11,  1.40it/s] 56%|█████▋    | 564/999 [05:52&lt;05:05,  1.42it/s] 57%|█████▋    | 565/999 [05:53&lt;05:06,  1.42it/s] 57%|█████▋    | 566/999 [05:54&lt;05:00,  1.44it/s] 57%|█████▋    | 567/999 [05:54&lt;04:57,  1.45it/s] 57%|█████▋    | 568/999 [05:55&lt;04:59,  1.44it/s] 57%|█████▋    | 569/999 [05:56&lt;05:04,  1.41it/s] 57%|█████▋    | 570/999 [05:57&lt;05:03,  1.42it/s] 57%|█████▋    | 571/999 [05:57&lt;05:02,  1.42it/s] 57%|█████▋    | 572/999 [05:58&lt;04:56,  1.44it/s] 57%|█████▋    | 573/999 [05:59&lt;04:53,  1.45it/s] 57%|█████▋    | 574/999 [05:59&lt;04:57,  1.43it/s] 58%|█████▊    | 575/999 [06:00&lt;04:49,  1.47it/s] 58%|█████▊    | 576/999 [06:01&lt;04:43,  1.49it/s] 58%|█████▊    | 577/999 [06:01&lt;04:46,  1.47it/s] 58%|█████▊    | 578/999 [06:02&lt;04:43,  1.48it/s] 58%|█████▊    | 579/999 [06:03&lt;04:39,  1.50it/s] 58%|█████▊    | 580/999 [06:03&lt;04:36,  1.52it/s] 58%|█████▊    | 581/999 [06:04&lt;04:45,  1.46it/s] 58%|█████▊    | 582/999 [06:05&lt;04:41,  1.48it/s] 58%|█████▊    | 583/999 [06:05&lt;04:41,  1.48it/s] 58%|█████▊    | 584/999 [06:06&lt;04:44,  1.46it/s] 59%|█████▊    | 585/999 [06:07&lt;04:45,  1.45it/s] 59%|█████▊    | 586/999 [06:07&lt;04:51,  1.42it/s] 59%|█████▉    | 587/999 [06:08&lt;04:53,  1.41it/s] 59%|█████▉    | 588/999 [06:09&lt;04:54,  1.40it/s] 59%|█████▉    | 589/999 [06:10&lt;04:49,  1.42it/s] 59%|█████▉    | 590/999 [06:10&lt;04:51,  1.40it/s] 59%|█████▉    | 591/999 [06:11&lt;04:55,  1.38it/s] 59%|█████▉    | 592/999 [06:12&lt;04:51,  1.40it/s] 59%|█████▉    | 593/999 [06:12&lt;04:49,  1.40it/s] 59%|█████▉    | 594/999 [06:13&lt;05:00,  1.35it/s] 60%|█████▉    | 595/999 [06:14&lt;05:04,  1.32it/s] 60%|█████▉    | 596/999 [06:15&lt;05:04,  1.32it/s] 60%|█████▉    | 597/999 [06:16&lt;05:04,  1.32it/s] 60%|█████▉    | 598/999 [06:16&lt;04:57,  1.35it/s] 60%|█████▉    | 599/999 [06:17&lt;04:59,  1.34it/s] 60%|██████    | 600/999 [06:18&lt;04:55,  1.35it/s] 60%|██████    | 601/999 [06:18&lt;04:50,  1.37it/s] 60%|██████    | 602/999 [06:19&lt;04:46,  1.39it/s] 60%|██████    | 603/999 [06:20&lt;04:40,  1.41it/s] 60%|██████    | 604/999 [06:21&lt;04:50,  1.36it/s] 61%|██████    | 605/999 [06:21&lt;04:47,  1.37it/s] 61%|██████    | 606/999 [06:22&lt;04:52,  1.34it/s] 61%|██████    | 607/999 [06:23&lt;04:44,  1.38it/s] 61%|██████    | 608/999 [06:23&lt;04:36,  1.41it/s] 61%|██████    | 609/999 [06:24&lt;04:38,  1.40it/s] 61%|██████    | 610/999 [06:25&lt;04:36,  1.41it/s] 61%|██████    | 611/999 [06:26&lt;04:35,  1.41it/s] 61%|██████▏   | 612/999 [06:26&lt;04:37,  1.39it/s] 61%|██████▏   | 613/999 [06:27&lt;04:31,  1.42it/s] 61%|██████▏   | 614/999 [06:28&lt;04:26,  1.44it/s] 62%|██████▏   | 615/999 [06:28&lt;04:28,  1.43it/s] 62%|██████▏   | 616/999 [06:29&lt;04:37,  1.38it/s] 62%|██████▏   | 617/999 [06:30&lt;04:31,  1.40it/s] 62%|██████▏   | 618/999 [06:31&lt;04:27,  1.42it/s] 62%|██████▏   | 619/999 [06:31&lt;04:21,  1.45it/s] 62%|██████▏   | 620/999 [06:32&lt;04:20,  1.45it/s] 62%|██████▏   | 621/999 [06:33&lt;04:18,  1.46it/s] 62%|██████▏   | 622/999 [06:33&lt;04:19,  1.45it/s] 62%|██████▏   | 623/999 [06:34&lt;04:23,  1.43it/s] 62%|██████▏   | 624/999 [06:35&lt;04:14,  1.47it/s] 63%|██████▎   | 625/999 [06:35&lt;04:14,  1.47it/s] 63%|██████▎   | 626/999 [06:36&lt;04:12,  1.48it/s] 63%|██████▎   | 627/999 [06:37&lt;04:05,  1.51it/s] 63%|██████▎   | 628/999 [06:37&lt;04:09,  1.49it/s] 63%|██████▎   | 629/999 [06:38&lt;04:09,  1.48it/s] 63%|██████▎   | 630/999 [06:39&lt;04:11,  1.47it/s] 63%|██████▎   | 631/999 [06:39&lt;04:08,  1.48it/s] 63%|██████▎   | 632/999 [06:40&lt;04:08,  1.48it/s] 63%|██████▎   | 633/999 [06:41&lt;04:04,  1.50it/s] 63%|██████▎   | 634/999 [06:41&lt;04:06,  1.48it/s] 64%|██████▎   | 635/999 [06:42&lt;04:04,  1.49it/s] 64%|██████▎   | 636/999 [06:43&lt;04:03,  1.49it/s] 64%|██████▍   | 637/999 [06:43&lt;03:59,  1.51it/s] 64%|██████▍   | 638/999 [06:44&lt;04:04,  1.47it/s] 64%|██████▍   | 639/999 [06:45&lt;04:04,  1.47it/s] 64%|██████▍   | 640/999 [06:45&lt;04:05,  1.46it/s] 64%|██████▍   | 641/999 [06:46&lt;04:05,  1.46it/s] 64%|██████▍   | 642/999 [06:47&lt;04:06,  1.45it/s] 64%|██████▍   | 643/999 [06:48&lt;04:05,  1.45it/s] 64%|██████▍   | 644/999 [06:48&lt;04:04,  1.45it/s] 65%|██████▍   | 645/999 [06:49&lt;03:57,  1.49it/s] 65%|██████▍   | 646/999 [06:50&lt;04:02,  1.45it/s] 65%|██████▍   | 647/999 [06:50&lt;04:03,  1.45it/s] 65%|██████▍   | 648/999 [06:51&lt;03:55,  1.49it/s] 65%|██████▍   | 649/999 [06:52&lt;03:51,  1.51it/s] 65%|██████▌   | 650/999 [06:52&lt;03:46,  1.54it/s] 65%|██████▌   | 651/999 [06:53&lt;03:45,  1.54it/s] 65%|██████▌   | 652/999 [06:53&lt;03:51,  1.50it/s] 65%|██████▌   | 653/999 [06:54&lt;03:52,  1.49it/s] 65%|██████▌   | 654/999 [06:55&lt;03:43,  1.54it/s] 66%|██████▌   | 655/999 [06:55&lt;03:38,  1.58it/s] 66%|██████▌   | 656/999 [06:56&lt;03:47,  1.51it/s] 66%|██████▌   | 657/999 [06:57&lt;03:49,  1.49it/s] 66%|██████▌   | 658/999 [06:57&lt;03:42,  1.53it/s] 66%|██████▌   | 659/999 [06:58&lt;03:42,  1.53it/s] 66%|██████▌   | 660/999 [06:59&lt;03:44,  1.51it/s] 66%|██████▌   | 661/999 [06:59&lt;03:42,  1.52it/s] 66%|██████▋   | 662/999 [07:00&lt;03:45,  1.49it/s] 66%|██████▋   | 663/999 [07:01&lt;03:48,  1.47it/s] 66%|██████▋   | 664/999 [07:01&lt;03:49,  1.46it/s] 67%|██████▋   | 665/999 [07:02&lt;03:45,  1.48it/s] 67%|██████▋   | 666/999 [07:03&lt;03:41,  1.50it/s] 67%|██████▋   | 667/999 [07:03&lt;03:36,  1.53it/s] 67%|██████▋   | 668/999 [07:04&lt;03:39,  1.51it/s] 67%|██████▋   | 669/999 [07:05&lt;03:43,  1.48it/s] 67%|██████▋   | 670/999 [07:05&lt;03:43,  1.47it/s] 67%|██████▋   | 671/999 [07:06&lt;03:36,  1.51it/s] 67%|██████▋   | 672/999 [07:07&lt;03:31,  1.54it/s] 67%|██████▋   | 673/999 [07:07&lt;03:32,  1.53it/s] 67%|██████▋   | 674/999 [07:08&lt;03:27,  1.57it/s] 68%|██████▊   | 675/999 [07:09&lt;03:29,  1.55it/s] 68%|██████▊   | 676/999 [07:09&lt;03:28,  1.55it/s] 68%|██████▊   | 677/999 [07:10&lt;03:27,  1.55it/s] 68%|██████▊   | 678/999 [07:11&lt;03:28,  1.54it/s] 68%|██████▊   | 679/999 [07:11&lt;03:27,  1.54it/s] 68%|██████▊   | 680/999 [07:12&lt;03:27,  1.54it/s] 68%|██████▊   | 681/999 [07:13&lt;03:24,  1.56it/s] 68%|██████▊   | 682/999 [07:13&lt;03:19,  1.59it/s] 68%|██████▊   | 683/999 [07:14&lt;03:24,  1.54it/s] 68%|██████▊   | 684/999 [07:14&lt;03:27,  1.52it/s] 69%|██████▊   | 685/999 [07:15&lt;03:28,  1.50it/s] 69%|██████▊   | 686/999 [07:16&lt;03:28,  1.50it/s] 69%|██████▉   | 687/999 [07:17&lt;03:32,  1.47it/s] 69%|██████▉   | 688/999 [07:17&lt;03:32,  1.46it/s] 69%|██████▉   | 689/999 [07:18&lt;03:31,  1.46it/s] 69%|██████▉   | 690/999 [07:19&lt;03:28,  1.48it/s] 69%|██████▉   | 691/999 [07:19&lt;03:26,  1.49it/s] 69%|██████▉   | 692/999 [07:20&lt;03:23,  1.51it/s] 69%|██████▉   | 693/999 [07:21&lt;03:24,  1.50it/s] 69%|██████▉   | 694/999 [07:21&lt;03:31,  1.44it/s] 70%|██████▉   | 695/999 [07:22&lt;03:32,  1.43it/s] 70%|██████▉   | 696/999 [07:23&lt;03:38,  1.39it/s] 70%|██████▉   | 697/999 [07:24&lt;03:38,  1.38it/s] 70%|██████▉   | 698/999 [07:24&lt;03:38,  1.38it/s] 70%|██████▉   | 699/999 [07:25&lt;03:37,  1.38it/s] 70%|███████   | 700/999 [07:26&lt;03:34,  1.39it/s] 70%|███████   | 701/999 [07:26&lt;03:33,  1.39it/s] 70%|███████   | 702/999 [07:27&lt;03:41,  1.34it/s] 70%|███████   | 703/999 [07:28&lt;03:39,  1.35it/s] 70%|███████   | 704/999 [07:29&lt;03:34,  1.37it/s] 71%|███████   | 705/999 [07:29&lt;03:42,  1.32it/s] 71%|███████   | 706/999 [07:30&lt;03:38,  1.34it/s] 71%|███████   | 707/999 [07:31&lt;03:32,  1.37it/s] 71%|███████   | 708/999 [07:32&lt;03:32,  1.37it/s] 71%|███████   | 709/999 [07:32&lt;03:30,  1.38it/s] 71%|███████   | 710/999 [07:33&lt;03:34,  1.35it/s] 71%|███████   | 711/999 [07:34&lt;03:32,  1.35it/s] 71%|███████▏  | 712/999 [07:35&lt;03:31,  1.36it/s] 71%|███████▏  | 713/999 [07:35&lt;03:25,  1.39it/s] 71%|███████▏  | 714/999 [07:36&lt;03:29,  1.36it/s] 72%|███████▏  | 715/999 [07:37&lt;03:28,  1.36it/s] 72%|███████▏  | 716/999 [07:37&lt;03:27,  1.37it/s] 72%|███████▏  | 717/999 [07:38&lt;03:33,  1.32it/s] 72%|███████▏  | 718/999 [07:39&lt;03:31,  1.33it/s] 72%|███████▏  | 719/999 [07:40&lt;03:33,  1.31it/s] 72%|███████▏  | 720/999 [07:41&lt;03:38,  1.28it/s] 72%|███████▏  | 721/999 [07:41&lt;03:41,  1.26it/s] 72%|███████▏  | 722/999 [07:42&lt;03:38,  1.27it/s] 72%|███████▏  | 723/999 [07:43&lt;03:34,  1.28it/s] 72%|███████▏  | 724/999 [07:44&lt;03:31,  1.30it/s] 73%|███████▎  | 725/999 [07:45&lt;03:32,  1.29it/s] 73%|███████▎  | 726/999 [07:45&lt;03:30,  1.29it/s] 73%|███████▎  | 727/999 [07:46&lt;03:27,  1.31it/s] 73%|███████▎  | 728/999 [07:47&lt;03:28,  1.30it/s] 73%|███████▎  | 729/999 [07:48&lt;03:26,  1.31it/s] 73%|███████▎  | 730/999 [07:48&lt;03:32,  1.26it/s] 73%|███████▎  | 731/999 [07:49&lt;03:32,  1.26it/s] 73%|███████▎  | 732/999 [07:50&lt;03:27,  1.29it/s] 73%|███████▎  | 733/999 [07:51&lt;03:24,  1.30it/s] 73%|███████▎  | 734/999 [07:51&lt;03:18,  1.33it/s] 74%|███████▎  | 735/999 [07:52&lt;03:21,  1.31it/s] 74%|███████▎  | 736/999 [07:53&lt;03:28,  1.26it/s] 74%|███████▍  | 737/999 [07:54&lt;03:25,  1.27it/s] 74%|███████▍  | 738/999 [07:55&lt;03:38,  1.19it/s] 74%|███████▍  | 739/999 [07:56&lt;03:44,  1.16it/s] 74%|███████▍  | 740/999 [07:57&lt;03:45,  1.15it/s] 74%|███████▍  | 741/999 [07:57&lt;03:42,  1.16it/s] 74%|███████▍  | 742/999 [07:58&lt;03:41,  1.16it/s] 74%|███████▍  | 743/999 [07:59&lt;03:37,  1.18it/s] 74%|███████▍  | 744/999 [08:00&lt;03:40,  1.15it/s] 75%|███████▍  | 745/999 [08:01&lt;03:37,  1.17it/s] 75%|███████▍  | 746/999 [08:02&lt;03:36,  1.17it/s] 75%|███████▍  | 747/999 [08:03&lt;03:33,  1.18it/s] 75%|███████▍  | 748/999 [08:03&lt;03:37,  1.15it/s] 75%|███████▍  | 749/999 [08:04&lt;03:36,  1.15it/s] 75%|███████▌  | 750/999 [08:05&lt;03:38,  1.14it/s] 75%|███████▌  | 751/999 [08:06&lt;03:38,  1.14it/s] 75%|███████▌  | 752/999 [08:07&lt;03:33,  1.16it/s] 75%|███████▌  | 753/999 [08:08&lt;03:31,  1.16it/s] 75%|███████▌  | 754/999 [08:09&lt;03:31,  1.16it/s] 76%|███████▌  | 755/999 [08:10&lt;03:34,  1.14it/s] 76%|███████▌  | 756/999 [08:10&lt;03:31,  1.15it/s] 76%|███████▌  | 757/999 [08:11&lt;03:31,  1.15it/s] 76%|███████▌  | 758/999 [08:12&lt;03:28,  1.15it/s] 76%|███████▌  | 759/999 [08:13&lt;03:27,  1.16it/s] 76%|███████▌  | 760/999 [08:14&lt;03:26,  1.16it/s] 76%|███████▌  | 761/999 [08:15&lt;03:28,  1.14it/s] 76%|███████▋  | 762/999 [08:16&lt;03:25,  1.15it/s] 76%|███████▋  | 763/999 [08:17&lt;03:29,  1.12it/s] 76%|███████▋  | 764/999 [08:17&lt;03:27,  1.13it/s] 77%|███████▋  | 765/999 [08:18&lt;03:21,  1.16it/s] 77%|███████▋  | 766/999 [08:19&lt;03:20,  1.16it/s] 77%|███████▋  | 767/999 [08:20&lt;03:16,  1.18it/s] 77%|███████▋  | 768/999 [08:21&lt;03:15,  1.18it/s] 77%|███████▋  | 769/999 [08:22&lt;03:20,  1.15it/s] 77%|███████▋  | 770/999 [08:23&lt;03:14,  1.18it/s] 77%|███████▋  | 771/999 [08:23&lt;03:10,  1.20it/s] 77%|███████▋  | 772/999 [08:24&lt;03:09,  1.20it/s] 77%|███████▋  | 773/999 [08:25&lt;03:07,  1.20it/s] 77%|███████▋  | 774/999 [08:26&lt;03:05,  1.21it/s] 78%|███████▊  | 775/999 [08:27&lt;03:05,  1.20it/s] 78%|███████▊  | 776/999 [08:27&lt;03:06,  1.20it/s] 78%|███████▊  | 777/999 [08:28&lt;03:08,  1.17it/s] 78%|███████▊  | 778/999 [08:29&lt;03:11,  1.15it/s] 78%|███████▊  | 779/999 [08:30&lt;03:07,  1.17it/s] 78%|███████▊  | 780/999 [08:31&lt;03:05,  1.18it/s] 78%|███████▊  | 781/999 [08:32&lt;03:04,  1.18it/s] 78%|███████▊  | 782/999 [08:33&lt;03:03,  1.18it/s] 78%|███████▊  | 783/999 [08:33&lt;03:03,  1.18it/s] 78%|███████▊  | 784/999 [08:34&lt;03:00,  1.19it/s] 79%|███████▊  | 785/999 [08:35&lt;03:08,  1.14it/s] 79%|███████▊  | 786/999 [08:36&lt;03:09,  1.12it/s] 79%|███████▉  | 787/999 [08:37&lt;03:08,  1.12it/s] 79%|███████▉  | 788/999 [08:38&lt;03:07,  1.13it/s] 79%|███████▉  | 789/999 [08:39&lt;03:09,  1.11it/s] 79%|███████▉  | 790/999 [08:40&lt;03:07,  1.11it/s] 79%|███████▉  | 791/999 [08:41&lt;03:04,  1.13it/s] 79%|███████▉  | 792/999 [08:42&lt;03:04,  1.12it/s] 79%|███████▉  | 793/999 [08:42&lt;03:05,  1.11it/s] 79%|███████▉  | 794/999 [08:43&lt;03:05,  1.11it/s] 80%|███████▉  | 795/999 [08:44&lt;03:02,  1.12it/s] 80%|███████▉  | 796/999 [08:45&lt;02:59,  1.13it/s] 80%|███████▉  | 797/999 [08:46&lt;02:59,  1.13it/s] 80%|███████▉  | 798/999 [08:47&lt;03:00,  1.11it/s] 80%|███████▉  | 799/999 [08:48&lt;03:02,  1.10it/s] 80%|████████  | 800/999 [08:49&lt;03:01,  1.10it/s] 80%|████████  | 801/999 [08:50&lt;02:58,  1.11it/s] 80%|████████  | 802/999 [08:51&lt;02:59,  1.10it/s] 80%|████████  | 803/999 [08:52&lt;02:59,  1.09it/s] 80%|████████  | 804/999 [08:52&lt;02:59,  1.09it/s] 81%|████████  | 805/999 [08:53&lt;02:57,  1.09it/s] 81%|████████  | 806/999 [08:54&lt;02:57,  1.08it/s] 81%|████████  | 807/999 [08:55&lt;02:56,  1.09it/s] 81%|████████  | 808/999 [08:56&lt;02:53,  1.10it/s] 81%|████████  | 809/999 [08:57&lt;02:53,  1.09it/s] 81%|████████  | 810/999 [08:58&lt;02:50,  1.11it/s] 81%|████████  | 811/999 [08:59&lt;02:47,  1.12it/s] 81%|████████▏ | 812/999 [09:00&lt;02:45,  1.13it/s] 81%|████████▏ | 813/999 [09:01&lt;02:47,  1.11it/s] 81%|████████▏ | 814/999 [09:02&lt;02:52,  1.07it/s] 82%|████████▏ | 815/999 [09:03&lt;02:52,  1.07it/s] 82%|████████▏ | 816/999 [09:03&lt;02:49,  1.08it/s] 82%|████████▏ | 817/999 [09:04&lt;02:48,  1.08it/s] 82%|████████▏ | 818/999 [09:05&lt;02:47,  1.08it/s] 82%|████████▏ | 819/999 [09:06&lt;02:55,  1.03it/s] 82%|████████▏ | 820/999 [09:07&lt;02:55,  1.02it/s] 82%|████████▏ | 821/999 [09:08&lt;02:55,  1.01it/s] 82%|████████▏ | 822/999 [09:09&lt;02:54,  1.01it/s] 82%|████████▏ | 823/999 [09:10&lt;02:54,  1.01it/s] 82%|████████▏ | 824/999 [09:11&lt;02:54,  1.00it/s] 83%|████████▎ | 825/999 [09:12&lt;02:56,  1.01s/it] 83%|████████▎ | 826/999 [09:13&lt;02:50,  1.01it/s] 83%|████████▎ | 827/999 [09:14&lt;02:43,  1.05it/s] 83%|████████▎ | 828/999 [09:15&lt;02:42,  1.05it/s] 83%|████████▎ | 829/999 [09:16&lt;02:42,  1.05it/s] 83%|████████▎ | 830/999 [09:17&lt;02:38,  1.06it/s] 83%|████████▎ | 831/999 [09:18&lt;02:33,  1.09it/s] 83%|████████▎ | 832/999 [09:19&lt;02:33,  1.09it/s] 83%|████████▎ | 833/999 [09:20&lt;02:25,  1.14it/s] 83%|████████▎ | 834/999 [09:20&lt;02:26,  1.12it/s] 84%|████████▎ | 835/999 [09:21&lt;02:27,  1.11it/s] 84%|████████▎ | 836/999 [09:22&lt;02:25,  1.12it/s] 84%|████████▍ | 837/999 [09:23&lt;02:24,  1.12it/s] 84%|████████▍ | 838/999 [09:24&lt;02:25,  1.11it/s] 84%|████████▍ | 839/999 [09:25&lt;02:23,  1.12it/s] 84%|████████▍ | 840/999 [09:26&lt;02:20,  1.13it/s] 84%|████████▍ | 841/999 [09:27&lt;02:16,  1.15it/s] 84%|████████▍ | 842/999 [09:28&lt;02:17,  1.14it/s] 84%|████████▍ | 843/999 [09:28&lt;02:15,  1.16it/s] 84%|████████▍ | 844/999 [09:29&lt;02:13,  1.16it/s] 85%|████████▍ | 845/999 [09:30&lt;02:11,  1.17it/s] 85%|████████▍ | 846/999 [09:31&lt;02:10,  1.17it/s] 85%|████████▍ | 847/999 [09:32&lt;02:09,  1.18it/s] 85%|████████▍ | 848/999 [09:33&lt;02:08,  1.17it/s] 85%|████████▍ | 849/999 [09:34&lt;02:10,  1.15it/s] 85%|████████▌ | 850/999 [09:34&lt;02:08,  1.16it/s] 85%|████████▌ | 851/999 [09:35&lt;02:09,  1.14it/s] 85%|████████▌ | 852/999 [09:36&lt;02:08,  1.14it/s] 85%|████████▌ | 853/999 [09:37&lt;02:08,  1.14it/s] 85%|████████▌ | 854/999 [09:38&lt;02:04,  1.16it/s] 86%|████████▌ | 855/999 [09:39&lt;02:05,  1.15it/s] 86%|████████▌ | 856/999 [09:40&lt;02:02,  1.17it/s] 86%|████████▌ | 857/999 [09:40&lt;01:58,  1.19it/s] 86%|████████▌ | 858/999 [09:41&lt;01:58,  1.19it/s] 86%|████████▌ | 859/999 [09:42&lt;01:59,  1.18it/s] 86%|████████▌ | 860/999 [09:43&lt;01:58,  1.18it/s] 86%|████████▌ | 861/999 [09:44&lt;02:01,  1.14it/s] 86%|████████▋ | 862/999 [09:45&lt;01:57,  1.17it/s] 86%|████████▋ | 863/999 [09:46&lt;01:59,  1.13it/s] 86%|████████▋ | 864/999 [09:47&lt;01:58,  1.14it/s] 87%|████████▋ | 865/999 [09:47&lt;01:58,  1.13it/s] 87%|████████▋ | 866/999 [09:48&lt;01:56,  1.14it/s] 87%|████████▋ | 867/999 [09:49&lt;01:57,  1.13it/s] 87%|████████▋ | 868/999 [09:50&lt;01:54,  1.14it/s] 87%|████████▋ | 869/999 [09:51&lt;01:51,  1.17it/s] 87%|████████▋ | 870/999 [09:52&lt;01:49,  1.18it/s] 87%|████████▋ | 871/999 [09:53&lt;01:50,  1.16it/s] 87%|████████▋ | 872/999 [09:54&lt;01:52,  1.13it/s] 87%|████████▋ | 873/999 [09:54&lt;01:51,  1.13it/s] 87%|████████▋ | 874/999 [09:55&lt;01:51,  1.12it/s] 88%|████████▊ | 875/999 [09:56&lt;01:52,  1.11it/s] 88%|████████▊ | 876/999 [09:57&lt;01:51,  1.10it/s] 88%|████████▊ | 877/999 [09:58&lt;01:52,  1.08it/s] 88%|████████▊ | 878/999 [09:59&lt;01:49,  1.10it/s] 88%|████████▊ | 879/999 [10:00&lt;01:49,  1.09it/s] 88%|████████▊ | 880/999 [10:01&lt;01:49,  1.09it/s] 88%|████████▊ | 881/999 [10:02&lt;01:47,  1.09it/s] 88%|████████▊ | 882/999 [10:03&lt;01:46,  1.10it/s] 88%|████████▊ | 883/999 [10:04&lt;01:46,  1.09it/s] 88%|████████▊ | 884/999 [10:04&lt;01:43,  1.11it/s] 89%|████████▊ | 885/999 [10:05&lt;01:39,  1.15it/s] 89%|████████▊ | 886/999 [10:06&lt;01:39,  1.13it/s] 89%|████████▉ | 887/999 [10:07&lt;01:38,  1.13it/s] 89%|████████▉ | 888/999 [10:08&lt;01:41,  1.09it/s] 89%|████████▉ | 889/999 [10:09&lt;01:40,  1.09it/s] 89%|████████▉ | 890/999 [10:10&lt;01:37,  1.12it/s] 89%|████████▉ | 891/999 [10:11&lt;01:34,  1.15it/s] 89%|████████▉ | 892/999 [10:11&lt;01:31,  1.17it/s] 89%|████████▉ | 893/999 [10:12&lt;01:30,  1.17it/s] 89%|████████▉ | 894/999 [10:13&lt;01:30,  1.16it/s] 90%|████████▉ | 895/999 [10:14&lt;01:29,  1.17it/s] 90%|████████▉ | 896/999 [10:15&lt;01:28,  1.16it/s] 90%|████████▉ | 897/999 [10:16&lt;01:27,  1.17it/s] 90%|████████▉ | 898/999 [10:17&lt;01:26,  1.16it/s] 90%|████████▉ | 899/999 [10:17&lt;01:25,  1.17it/s] 90%|█████████ | 900/999 [10:18&lt;01:24,  1.17it/s] 90%|█████████ | 901/999 [10:19&lt;01:22,  1.18it/s] 90%|█████████ | 902/999 [10:20&lt;01:22,  1.18it/s] 90%|█████████ | 903/999 [10:21&lt;01:19,  1.21it/s] 90%|█████████ | 904/999 [10:22&lt;01:19,  1.19it/s] 91%|█████████ | 905/999 [10:23&lt;01:20,  1.16it/s] 91%|█████████ | 906/999 [10:23&lt;01:19,  1.17it/s] 91%|█████████ | 907/999 [10:24&lt;01:18,  1.17it/s] 91%|█████████ | 908/999 [10:25&lt;01:16,  1.18it/s] 91%|█████████ | 909/999 [10:26&lt;01:16,  1.18it/s] 91%|█████████ | 910/999 [10:27&lt;01:16,  1.17it/s] 91%|█████████ | 911/999 [10:28&lt;01:15,  1.16it/s] 91%|█████████▏| 912/999 [10:29&lt;01:15,  1.15it/s] 91%|█████████▏| 913/999 [10:29&lt;01:14,  1.15it/s] 91%|█████████▏| 914/999 [10:30&lt;01:13,  1.15it/s] 92%|█████████▏| 915/999 [10:31&lt;01:13,  1.14it/s] 92%|█████████▏| 916/999 [10:32&lt;01:12,  1.14it/s] 92%|█████████▏| 917/999 [10:33&lt;01:12,  1.14it/s] 92%|█████████▏| 918/999 [10:34&lt;01:10,  1.15it/s] 92%|█████████▏| 919/999 [10:35&lt;01:09,  1.15it/s] 92%|█████████▏| 920/999 [10:35&lt;01:06,  1.18it/s] 92%|█████████▏| 921/999 [10:36&lt;01:05,  1.19it/s] 92%|█████████▏| 922/999 [10:37&lt;01:03,  1.21it/s] 92%|█████████▏| 923/999 [10:38&lt;01:03,  1.20it/s] 92%|█████████▏| 924/999 [10:39&lt;01:02,  1.20it/s] 93%|█████████▎| 925/999 [10:40&lt;01:02,  1.18it/s] 93%|█████████▎| 926/999 [10:40&lt;01:01,  1.19it/s] 93%|█████████▎| 927/999 [10:41&lt;01:01,  1.17it/s] 93%|█████████▎| 928/999 [10:42&lt;01:00,  1.17it/s] 93%|█████████▎| 929/999 [10:43&lt;01:00,  1.16it/s] 93%|█████████▎| 930/999 [10:44&lt;00:59,  1.15it/s] 93%|█████████▎| 931/999 [10:45&lt;00:59,  1.15it/s] 93%|█████████▎| 932/999 [10:46&lt;00:58,  1.14it/s] 93%|█████████▎| 933/999 [10:47&lt;00:58,  1.13it/s] 93%|█████████▎| 934/999 [10:47&lt;00:56,  1.16it/s] 94%|█████████▎| 935/999 [10:48&lt;00:54,  1.17it/s] 94%|█████████▎| 936/999 [10:49&lt;00:54,  1.16it/s] 94%|█████████▍| 937/999 [10:50&lt;00:55,  1.11it/s] 94%|█████████▍| 938/999 [10:51&lt;00:53,  1.14it/s] 94%|█████████▍| 939/999 [10:52&lt;00:53,  1.13it/s] 94%|█████████▍| 940/999 [10:53&lt;00:50,  1.16it/s] 94%|█████████▍| 941/999 [10:54&lt;00:50,  1.15it/s] 94%|█████████▍| 942/999 [10:54&lt;00:49,  1.15it/s] 94%|█████████▍| 943/999 [10:55&lt;00:48,  1.16it/s] 94%|█████████▍| 944/999 [10:56&lt;00:47,  1.16it/s] 95%|█████████▍| 945/999 [10:57&lt;00:45,  1.17it/s] 95%|█████████▍| 946/999 [10:58&lt;00:45,  1.17it/s] 95%|█████████▍| 947/999 [10:59&lt;00:43,  1.20it/s] 95%|█████████▍| 948/999 [10:59&lt;00:41,  1.22it/s] 95%|█████████▍| 949/999 [11:00&lt;00:41,  1.21it/s] 95%|█████████▌| 950/999 [11:01&lt;00:41,  1.19it/s] 95%|█████████▌| 951/999 [11:02&lt;00:41,  1.17it/s] 95%|█████████▌| 952/999 [11:03&lt;00:40,  1.15it/s] 95%|█████████▌| 953/999 [11:04&lt;00:40,  1.14it/s] 95%|█████████▌| 954/999 [11:05&lt;00:40,  1.12it/s] 96%|█████████▌| 955/999 [11:06&lt;00:39,  1.11it/s] 96%|█████████▌| 956/999 [11:07&lt;00:39,  1.10it/s] 96%|█████████▌| 957/999 [11:08&lt;00:38,  1.08it/s] 96%|█████████▌| 958/999 [11:08&lt;00:37,  1.08it/s] 96%|█████████▌| 959/999 [11:09&lt;00:37,  1.07it/s] 96%|█████████▌| 960/999 [11:10&lt;00:35,  1.09it/s] 96%|█████████▌| 961/999 [11:11&lt;00:35,  1.08it/s] 96%|█████████▋| 962/999 [11:12&lt;00:33,  1.09it/s] 96%|█████████▋| 963/999 [11:13&lt;00:33,  1.07it/s] 96%|█████████▋| 964/999 [11:14&lt;00:33,  1.04it/s] 97%|█████████▋| 965/999 [11:15&lt;00:32,  1.05it/s] 97%|█████████▋| 966/999 [11:16&lt;00:31,  1.06it/s] 97%|█████████▋| 967/999 [11:17&lt;00:30,  1.06it/s] 97%|█████████▋| 968/999 [11:18&lt;00:28,  1.07it/s] 97%|█████████▋| 969/999 [11:19&lt;00:28,  1.05it/s] 97%|█████████▋| 970/999 [11:20&lt;00:27,  1.06it/s] 97%|█████████▋| 971/999 [11:21&lt;00:26,  1.06it/s] 97%|█████████▋| 972/999 [11:22&lt;00:24,  1.08it/s] 97%|█████████▋| 973/999 [11:23&lt;00:24,  1.08it/s] 97%|█████████▋| 974/999 [11:24&lt;00:23,  1.05it/s] 98%|█████████▊| 975/999 [11:24&lt;00:22,  1.05it/s] 98%|█████████▊| 976/999 [11:25&lt;00:21,  1.09it/s] 98%|█████████▊| 977/999 [11:26&lt;00:20,  1.06it/s] 98%|█████████▊| 978/999 [11:27&lt;00:19,  1.06it/s] 98%|█████████▊| 979/999 [11:28&lt;00:19,  1.04it/s] 98%|█████████▊| 980/999 [11:29&lt;00:18,  1.05it/s] 98%|█████████▊| 981/999 [11:30&lt;00:17,  1.03it/s] 98%|█████████▊| 982/999 [11:31&lt;00:16,  1.02it/s] 98%|█████████▊| 983/999 [11:32&lt;00:15,  1.03it/s] 98%|█████████▊| 984/999 [11:33&lt;00:14,  1.06it/s] 99%|█████████▊| 985/999 [11:34&lt;00:13,  1.03it/s] 99%|█████████▊| 986/999 [11:35&lt;00:12,  1.06it/s] 99%|█████████▉| 987/999 [11:36&lt;00:11,  1.07it/s] 99%|█████████▉| 988/999 [11:37&lt;00:10,  1.04it/s] 99%|█████████▉| 989/999 [11:38&lt;00:09,  1.04it/s] 99%|█████████▉| 990/999 [11:39&lt;00:08,  1.05it/s] 99%|█████████▉| 991/999 [11:40&lt;00:07,  1.05it/s] 99%|█████████▉| 992/999 [11:41&lt;00:06,  1.07it/s] 99%|█████████▉| 993/999 [11:42&lt;00:05,  1.04it/s] 99%|█████████▉| 994/999 [11:43&lt;00:04,  1.02it/s]100%|█████████▉| 995/999 [11:44&lt;00:03,  1.04it/s]100%|█████████▉| 996/999 [11:45&lt;00:02,  1.04it/s]100%|█████████▉| 997/999 [11:46&lt;00:01,  1.04it/s]100%|█████████▉| 998/999 [11:47&lt;00:00,  1.03it/s]100%|██████████| 999/999 [11:47&lt;00:00,  1.04it/s]100%|██████████| 999/999 [11:47&lt;00:00,  1.41it/s]</code></pre>
</div>
</div>
<div id="ac2fb5a1" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(quantiles_theoriques, quantiles_empiriques)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>plt.plot(quantiles_theoriques, quantiles_theoriques, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'Première bissectrice'</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'QQ Plot - Quantiles empiriques vs Quantiles théoriques'</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Quantiles théoriques (distribution Skew Student)'</span>)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Quantiles empiriques'</span>)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-39-output-1.png" width="840" height="525" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="dca8e7e0" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # kstest y revenir</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ks_stat, ks_p_value = kstest(data_train, skew_student_pdf, args=(**params_sstd,))</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># print("="*80)</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print("H0 : Les données suivent une loi de Skew Student")</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"Statistique de test : {ks_stat:.4f}")</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"P-value : {ks_p_value:.4f}")</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># print("="*80)</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="co"># A revoir</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ii.4.2.-calcul-de-la-var-skew-student" class="level3">
<h3 class="anchored" data-anchor-id="ii.4.2.-calcul-de-la-var-skew-student">II.4.2. Calcul de la VaR Skew Student</h3>
<div id="bd3255e4" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Objectif : écrire une fonction qui calcule la VaR skew-student</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sstd_var_fct(alpha, params):</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcul de la VaR skew student</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co">    data : les rendements logarithmiques</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : le niveau de confiance</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>skew_student_quantile(<span class="dv">1</span><span class="op">-</span>alpha, <span class="op">**</span>params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0c58874e" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>sstd_var <span class="op">=</span> sstd_var_fct(alpha, params_sstd)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"La VaR skew student pour h=1j et alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss"> est : </span><span class="sc">{</span>sstd_var<span class="sc">:.4%}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>La VaR skew student pour h=1j et alpha=0.99 est : 4.2576%</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="iii.-implémentation-de-les" class="level1">
<h1>III. Implémentation de l’ES</h1>
<p>L’expected shortfall (ES) est une mesure de risque qui donne une estimation de la perte moyenne au-delà du seuil de la VaR. Par exemple, un ES à 5% sur 1 jour de 1000 euros signifie que si la perte dépasse 1000 euros, alors la perte moyenne sera de 1500 euros. L’ES est une mesure plus robuste que la VaR, car elle prend en compte les queues de distribution et est particulièrement utile pour évaluer les risques extrêmes. Elle est définie comme suit :</p>
<p><span class="math display">\[ES_{\alpha}(h) = E(PnL | PnL \leq -VaR_{\alpha}(h))\]</span></p>
<p>/!&nbsp;La ES du cours est différente de celle ci. Elle est définie comme suit : <span class="math display">\[ES_{\alpha}(h) = E(PnL - VaR | PnL \leq -VaR_{\alpha}(h)) = CTE - VaR\]</span></p>
<p>Voir ce qui est fait dans le cadre réglementaire.</p>
<div id="386db4d5" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected Shortfall pour la VaR historique, bootstrap et gaussienne, et skew-student</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> expected_shortfall(data, var):</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcul de l'Expected Shortfall</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co">    data : les rendements logarithmiques</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co">    var : la VaR</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>data[data <span class="op">&lt;</span> <span class="op">-</span>var].mean()</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>es_hist_train <span class="op">=</span> expected_shortfall(data_train, var_hist_train)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>es_bs_train <span class="op">=</span> expected_shortfall(data_train, var_bs_train)</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>es_gauss_train <span class="op">=</span> expected_shortfall(data_train, var_gauss_train)</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>es_sstd_train <span class="op">=</span> expected_shortfall(data_train, sstd_var)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="co"># in a df</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> pd.DataFrame({</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Historique'</span>: [es_hist_train],</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Bootstrap'</span>: [es_bs_train],</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Gaussienne'</span>: [es_gauss_train],</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Skew Student'</span>: [es_sstd_train]</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Expected Shortfall empirique (en %) pour h=1j"</span>)</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">round</span>(<span class="dv">100</span><span class="op">*</span>es,<span class="dv">2</span>))</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Expected Shortfall empirique (en %) pour h=1j
   Historique  Bootstrap  Gaussienne  Skew Student
0        5.47       5.51        4.47          5.68
================================================================================</code></pre>
</div>
</div>
<div id="db5cfd47" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> stats</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.integrate <span class="im">as</span> integrate</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> expected_shortfall_theoretical(alpha, quantile_function, density_function,params):</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes the Expected Shortfall (Conditional VaR) for a given distribution.</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - alpha (float): Confidence level (e.g., 0.99 for 99%)</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - quantile_function (callable): Function to compute quantiles (e.g., skew_student_quantile)</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - params (dict): Parameters of the distribution</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - float: Expected Shortfall value</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the Value at Risk (VaR) at level alpha</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>    var_alpha <span class="op">=</span> quantile_function(<span class="dv">1</span><span class="op">-</span>alpha, <span class="op">**</span>params)</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected Shortfall integral</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>    integral_value, _ <span class="op">=</span> integrate.quad(<span class="kw">lambda</span> x: x <span class="op">*</span> density_function(x, <span class="op">**</span>params), <span class="op">-</span><span class="bu">float</span>(<span class="st">"inf"</span>), var_alpha)</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute Expected Shortfall</span></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>    es_alpha <span class="op">=</span> <span class="op">-</span>integral_value <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> es_alpha</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute Expected Shortfall using the corrected function</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.99</span></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>es_sstd_theoretical <span class="op">=</span> expected_shortfall_theoretical(alpha,skew_student_quantile,skew_student_pdf, params_sstd)</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>params_norm <span class="op">=</span> {</span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"loc"</span> : np.mean(data_train),</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scale"</span> : np.std(data_train)</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>es_gauss_theoretical <span class="op">=</span> expected_shortfall_theoretical(alpha,stats.norm.ppf,stats.norm.pdf, params_norm)</span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a>es_theoretical <span class="op">=</span> pd.DataFrame({</span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Gaussienne'</span>: [es_gauss_theoretical],</span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Skew Student'</span>: [es_sstd_theoretical]</span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Expected Shortfall théorique (en %) pour h=1j"</span>)</span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">round</span>(<span class="dv">100</span><span class="op">*</span>es_theoretical,<span class="dv">2</span>))</span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Expected Shortfall théorique (en %) pour h=1j
   Gaussienne  Skew Student
0         3.7          6.71
================================================================================</code></pre>
</div>
</div>
</section>
<section id="iv.protocole-de-backtesting" class="level1">
<h1>IV.Protocole de Backtesting</h1>
<p>L’exercice de backtesting consiste à vérifier la capacité d’adaptation du modèle et sa viabilité en dehors de son cadre d’entraînement. Il permet d’évaluer la performance des modèles dans le temps. Idéalement, il faudrait le realiser quotidiennement afin d’évaluer s’il est utile ou non de recalibrer le modèle.</p>
<p>Dans le cadre de TP, nous n’avons pas observé d’exceptions avec l’utilisation de la VaR historique. Cela est probablement du à la période d’apprentissage trop stricte. Notre modèle était donc trop restrictif/conservateur ce qui peut témoigner de son incapacité d’adaptation. Pour ce faire, il aurait été necessaire de le recalibrer.</p>
<p>Sachant que les modèles sont évalués quotidiennement, à quel moment doit-on considérer qu’il est nécessaire de recalibrer le modèle ? Quels indicateurs pourrait-on mettre en place pour déterminer si tout est sous contrôle (VaR trop haute, trop basse) ou si un recalibrage est requis, sachant que le modèle est backtesté chaque jour ?</p>
<p>Pour repondre à ces questions, nous proposons le protocole de backtest ci-dessous :</p>
<ul>
<li><p>Dans la réglementation baloise, il est demandé de tester les performances de la VaR sur les 250 jours suivants la date de réalisation du modèle. Dans ces 250 jours, on est censé observé 2 à 3 exceptions, soit 1%. Lorsqu’il n’y a aucune exception sur cette période de temps, nous jugerons que le modèle est mal calibré.</p></li>
<li><p>Lorsqu’il y a des exceptions, nous pouvons comparer ces exceptions théoriques aux exceptions observées à l’aide d’un test de Kupiec/Unconditionnal coverage [1], une variante du test binomiale qui permet de tester sous l’hypothèse nulle que le taux d’exception(p) est égal au niveau de confiance de la VaR (1-<span class="math inline">\(\alpha\)</span>). La statistique de test suit une loi de khi-deux à 1 degré de liberté. Lorsque cette hypothèse est rejetée, cela signifie que le modèle est mal calibré. En effet, si une banque a trop d’exceptions, i.e.&nbsp;<span class="math inline">\(p \geq 1 - \alpha\)</span>, cela signifie que son modèle sous-estime le risque, ce qui peut conduire à une exigence de recalibrage ou une augmentation du capital réglementaire. Si une banque a trop peu d’exceptions (voire 0), i.e.&nbsp;<span class="math inline">\(p \leq 1 - \alpha\)</span>, cela peut indiquer que son modèle est trop conservateur, ce qui immobilise trop de capital inutilement.</p></li>
<li><p>Puisqu’un seul test de backtesting n’est pas suffisant[2] pour juger la qualité d’un modèle de VaR, il serait préférable de combiner différentes méthodes. Pour ce faire, un autre test a été utilisé pour juger de la necessité de recalibrage du modèle. Il s’agit du test de Christoffersen’s Interval Forecast/Independance test [3]. Ce test permet de vérifier si les exceptions sont indépendantes et donc bien réparties dans le temps. En effet, si les exceptions sont concentrées dans un intervalle de temps, cela peut indiquer que le modèle est mal calibré. Sous l’hypothèse nulle, la statistique de test suit asymptotiquement une loi de khi-deux à 1 degré de liberté.</p></li>
<li><p>En couplant le test de Kupiec au test de Christoffersen [3], nous avons le test de conditional coverage mixte[3] qui suit une loi de khi-deux à 2 degrés de liberté.</p></li>
</ul>
<p>Pour la mise en place de ces tests statistiques, nous avons besoin d’une échantillon de taille suffisamment grande, i.e <span class="math inline">\(N=30\)</span>. Pour ce faire, nous ne pourrons mettre en place ce protocole qu’à partir du 30ème jour de backtesting. Pour le backtest, nous avons fait le choix d’utiliser un expanding window, i.e.&nbsp;une fenêtre d’apprentissage qui s’agrandit à chaque période de recalibrage. Il aurait été plus pertinent de privilégier un rolling window, i.e.&nbsp;une fenêtre d’apprentissage qui se déplace à chaque période de recalibrage, pour éviter de bruiter les données.</p>
<p>PROBLÈME : au bout de 30j, s’il n’y a pas d’exceptions, on ne recalibre pas le modèle mais si au 31e jour il y a une exception, le test de kupiec echoue=&gt; recalibrage. <strong><em>References</em></strong>: - [1] Kupiec, P. “Techniques for Verifying the Accuracy of Risk Management Models.” Journal of Derivatives. Vol. 3, 1995, pp.&nbsp;73–84. - [2] Haas, M. “New Methods in Backtesting.” Financial Engineering, Research Center Caesar, Bonn, 2001. - [3] Christoffersen, P. “Evaluating Interval Forecasts.” International Economic Review. Vol. 39, 1998, pp.&nbsp;841–862.</p>
<div id="7e7eaac7" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> chi2</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Backtest:</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, actual, forecast, alpha, alpha_test):</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.index <span class="op">=</span> actual.index</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.actual <span class="op">=</span> actual.values</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.forecast <span class="op">=</span> forecast</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha <span class="op">=</span> alpha</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha_test <span class="op">=</span> alpha_test</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hit_series(<span class="va">self</span>):</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Returns a series of 1s (VaR breaches) and 0s (no breach) """</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">self</span>.actual <span class="op">&lt;</span> <span class="op">-</span> <span class="va">self</span>.forecast).astype(<span class="bu">int</span>)</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> lr_bt(<span class="va">self</span>):</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Back-test protocol """</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>        hits <span class="op">=</span> <span class="va">self</span>.hit_series()  <span class="co"># Série des violations de la VaR (1 si violation, 0 sinon)</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>        transitions <span class="op">=</span> hits[<span class="dv">1</span>:] <span class="op">-</span> hits[:<span class="op">-</span><span class="dv">1</span>]  <span class="co"># Différences entre valeurs successives (1 si passage de 0 à 1, -1 si passage de 1 à 0)</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transition counts</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>        n01 <span class="op">=</span> np.<span class="bu">sum</span>(transitions <span class="op">==</span> <span class="dv">1</span>)  <span class="co"># 0 -&gt; 1</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>        n10 <span class="op">=</span> np.<span class="bu">sum</span>(transitions <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>) <span class="co"># 1 -&gt; 0</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>        n11 <span class="op">=</span> np.<span class="bu">sum</span>((transitions <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (hits[<span class="dv">1</span>:] <span class="op">==</span> <span class="dv">1</span>)) <span class="co"># 1 -&gt; 1</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>        n00 <span class="op">=</span> np.<span class="bu">sum</span>((transitions <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (hits[<span class="dv">1</span>:] <span class="op">==</span> <span class="dv">0</span>)) <span class="co"># 0 -&gt; 0</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Number of observations in each state</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>        n0, n1 <span class="op">=</span> n01 <span class="op">+</span> n00, n10 <span class="op">+</span> n11</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>        total_n <span class="op">=</span> n0 <span class="op">+</span> n1</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Probability estimates</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>        p01 <span class="op">=</span> n01 <span class="op">/</span> (n00 <span class="op">+</span> n01) <span class="cf">if</span> (n00 <span class="op">+</span> n01) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>        p11 <span class="op">=</span> n11 <span class="op">/</span> (n11 <span class="op">+</span> n10) <span class="cf">if</span> (n11 <span class="op">+</span> n10) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> n1 <span class="op">/</span> total_n <span class="cf">if</span> total_n <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n1 <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>            <span class="co">#</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Unconditional Coverage Test/Kupiec</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>            uc_h0 <span class="op">=</span> n0 <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> <span class="va">self</span>.alpha) <span class="op">+</span> n1 <span class="op">*</span> np.log(<span class="va">self</span>.alpha)</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>            uc_h1 <span class="op">=</span> n0 <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> p) <span class="op">+</span> n1 <span class="op">*</span> np.log(p)</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>            uc_stat <span class="op">=</span> <span class="op">-</span><span class="dv">2</span> <span class="op">*</span> (uc_h0 <span class="op">-</span> uc_h1)</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># uc_critical_val = chi2.ppf(self.alpha_test, 1)</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a>            uc_pval <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> chi2.cdf(uc_stat, <span class="dv">1</span>)</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Independence Test/Christoffersen</span></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>            ind_h0 <span class="op">=</span> (n00 <span class="op">+</span> n01) <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> p) <span class="op">+</span> (n01 <span class="op">+</span> n11) <span class="op">*</span> np.log(p)</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>            ind_h1 <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p01 <span class="op">&gt;</span> <span class="dv">0</span>: ind_h1 <span class="op">+=</span> n01 <span class="op">*</span> np.log(p01)</span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="dv">1</span> <span class="op">-</span> p01) <span class="op">&gt;</span> <span class="dv">0</span>: ind_h1 <span class="op">+=</span> n00 <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> p01)</span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p11 <span class="op">&gt;</span> <span class="dv">0</span>: ind_h1 <span class="op">+=</span> n11 <span class="op">*</span> np.log(p11)</span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="dv">1</span> <span class="op">-</span> p11) <span class="op">&gt;</span> <span class="dv">0</span>: ind_h1 <span class="op">+=</span> n10 <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> p11)</span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a>            ind_stat <span class="op">=</span> <span class="op">-</span><span class="dv">2</span> <span class="op">*</span> (ind_h0 <span class="op">-</span> ind_h1)</span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ind_critical_val = chi2.ppf(self.alpha_test, 1)</span></span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a>            ind_pval <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> chi2.cdf(ind_stat, <span class="dv">1</span>)</span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Conditional Coverage Test/ Christoffersen &amp; Kupiec mixture</span></span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a>            cc_stat <span class="op">=</span> uc_stat <span class="op">+</span> ind_stat</span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># cc_critical_val = chi2.ppf(self.alpha_test, 2)</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>            cc_pval <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> chi2.cdf(cc_stat, <span class="dv">2</span>)</span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store results in a DataFrame</span></span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Statistic"</span>: [uc_stat, cc_stat, ind_stat],</span>
<span id="cb69-66"><a href="#cb69-66" aria-hidden="true" tabindex="-1"></a>                <span class="co"># "Critical Value": [uc_critical_val, ind_critical_val, cc_critical_val],</span></span>
<span id="cb69-67"><a href="#cb69-67" aria-hidden="true" tabindex="-1"></a>                <span class="st">"p-value"</span>: [uc_pval, cc_pval, ind_pval]</span>
<span id="cb69-68"><a href="#cb69-68" aria-hidden="true" tabindex="-1"></a>            }, index<span class="op">=</span>[<span class="st">"Unconditional"</span>, <span class="st">"Conditional"</span>,<span class="st">"Independence"</span>])</span>
<span id="cb69-69"><a href="#cb69-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-70"><a href="#cb69-70" aria-hidden="true" tabindex="-1"></a>            binomial_test <span class="op">=</span> stats.binomtest(n1, total_n, <span class="dv">1</span><span class="op">-</span><span class="va">self</span>.alpha, alternative<span class="op">=</span><span class="st">'two-sided'</span>)</span>
<span id="cb69-71"><a href="#cb69-71" aria-hidden="true" tabindex="-1"></a>            df.loc[<span class="st">"Binomial"</span>] <span class="op">=</span> [binomial_test.statistic, binomial_test.pvalue]</span>
<span id="cb69-72"><a href="#cb69-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb69-73"><a href="#cb69-73" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.DataFrame(np.nan, index<span class="op">=</span>[<span class="st">"Unconditional"</span>, <span class="st">"Conditional"</span>, <span class="st">"Independence"</span>], columns<span class="op">=</span>[<span class="st">"Statistic"</span>, <span class="st">"p-value"</span>])</span>
<span id="cb69-74"><a href="#cb69-74" aria-hidden="true" tabindex="-1"></a>            binomial_test <span class="op">=</span> stats.binomtest(n1, total_n, <span class="dv">1</span><span class="op">-</span><span class="va">self</span>.alpha, alternative<span class="op">=</span><span class="st">'two-sided'</span>)</span>
<span id="cb69-75"><a href="#cb69-75" aria-hidden="true" tabindex="-1"></a>            df.loc[<span class="st">"Binomial"</span>] <span class="op">=</span> [binomial_test.statistic, binomial_test.pvalue]</span>
<span id="cb69-76"><a href="#cb69-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-77"><a href="#cb69-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-78"><a href="#cb69-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c3c32c07" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> daily_backtest(actual, forecast, alpha<span class="op">=</span><span class="fl">0.99</span>, alpha_test <span class="op">=</span> <span class="fl">0.95</span>,min_days<span class="op">=</span><span class="dv">30</span>, max_days<span class="op">=</span><span class="dv">250</span>):</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Runs a growing backtest daily, starting at min_days up to max_days """</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    recalibration_needed <span class="op">=</span> <span class="va">False</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    end_test <span class="op">=</span> <span class="bu">min</span>(max_days,<span class="bu">len</span>(actual))</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> end <span class="kw">in</span> <span class="bu">range</span>(min_days, end_test <span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        data_to_test <span class="op">=</span> actual[:end]</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>        var_to_test <span class="op">=</span> forecast</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(data_to_test) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>        bt <span class="op">=</span> Backtest(actual<span class="op">=</span>data_to_test, forecast<span class="op">=</span>var_to_test, alpha<span class="op">=</span>alpha, alpha_test<span class="op">=</span>alpha_test)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> bt.lr_bt()</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>        nb_exceptions <span class="op">=</span> bt.hit_series().<span class="bu">sum</span>()</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># res=bootstrap((data_to_test,), statistic=lambda x: exceptions(x, var_to_test)/len(x), method='percentile', n_resamples=1000)</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ci_lower, ci_upper = res.confidence_interval</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if ci_lower &lt;= 1-alpha &lt;= ci_upper:</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     print(f"Recalibration needed at {end} days: The conditional test failed.")</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     recalibration_needed = True</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     return recalibration_needed, end</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if "conditional" in result.index and result.loc["Independence", "p-value"] &lt; 0.05:</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     print(f"Recalibration needed at {end} days: The Independence test failed.")</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     recalibration_needed = True</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     return recalibration_needed, end</span></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># failed_tests = result.iloc[2:][result.iloc[2:]["p-value"] &lt; 0.05].index.tolist()</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>        failed_tests <span class="op">=</span> result[result[<span class="st">"p-value"</span>] <span class="op">&lt;</span> <span class="fl">0.05</span>].index.tolist()</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> failed_tests:</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Recalibration needed at </span><span class="sc">{</span>end<span class="sc">}</span><span class="ss"> days: The following tests failed: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(failed_tests)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>            recalibration_needed <span class="op">=</span> <span class="va">True</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> recalibration_needed, end</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> end <span class="op">==</span> max_days <span class="kw">and</span> nb_exceptions <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Recalibration needed at </span><span class="sc">{</span>end<span class="sc">}</span><span class="ss"> days: No exceptions observed in the test window."</span>)</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>            recalibration_needed <span class="op">=</span> <span class="va">True</span></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> recalibration_needed, end</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> recalibration_needed:</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No recalibration needed in the tested period."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ba99d46c" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> iterative_backtest(data_train, data_test, var_model, alpha):</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Runs an iterative backtest with recalibration """</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    data_train <span class="op">=</span> data_train.copy()</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    data_test <span class="op">=</span> data_test.copy()</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    var_result <span class="op">=</span> var_model(data_train, alpha<span class="op">=</span>alpha)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    var_to_test <span class="op">=</span> var_result[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(var_result, (<span class="bu">list</span>, <span class="bu">tuple</span>)) <span class="cf">else</span> var_result </span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    recalibration_points <span class="op">=</span> [<span class="dv">0</span>]</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    vars_stored <span class="op">=</span> [var_to_test]</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="bu">len</span>(data_test) <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(data_test) <span class="op">&gt;=</span> <span class="dv">250</span>:</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Old VaR to test: </span><span class="sc">{</span>var_to_test<span class="sc">:.4%}</span><span class="ss">"</span>)</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run daily backtest correctly</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>        res_backtest, index <span class="op">=</span> daily_backtest(data_test, var_to_test, alpha<span class="op">=</span>alpha, alpha_test<span class="op">=</span><span class="fl">0.95</span>, min_days<span class="op">=</span><span class="dv">30</span>, max_days<span class="op">=</span><span class="dv">250</span>)</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the index of recalibration</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> res_backtest:</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="bu">len</span>(data_test))</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>            recalibration_points.append(index)</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Expand training data and shrink test data</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>            data_train <span class="op">=</span> pd.concat([data_train, data_test.iloc[:index,]])</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>            data_test <span class="op">=</span> data_test.iloc[index:,]</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>            var_result <span class="op">=</span> var_model(data_train, alpha<span class="op">=</span>alpha)</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>            var_to_test <span class="op">=</span> var_result[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(var_result, (<span class="bu">list</span>, <span class="bu">tuple</span>)) <span class="cf">else</span> var_result </span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>            vars_stored.append(var_to_test)</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"New VaR to test: </span><span class="sc">{</span>var_to_test<span class="sc">:.4%}</span><span class="ss">"</span>)</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No recalibration needed."</span>)</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> recalibration_points, vars_stored</span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute iterative backtest</span></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>recalibration_points, vars_stored <span class="op">=</span> iterative_backtest(data_train, data_test, gaussian_var_ewma, alpha<span class="op">=</span>alpha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Old VaR to test: 2.7763%
Recalibration needed at 103 days: The following tests failed: Unconditional, Conditional
586
New VaR to test: 2.5925%
================================================================================
Old VaR to test: 2.5925%
Recalibration needed at 61 days: The following tests failed: Unconditional, Conditional
483
New VaR to test: 2.6675%
================================================================================
Old VaR to test: 2.6675%
Recalibration needed at 30 days: The following tests failed: Unconditional, Conditional
422
New VaR to test: 1.8885%
================================================================================
Old VaR to test: 1.8885%
Recalibration needed at 50 days: The following tests failed: Unconditional, Conditional
392
New VaR to test: 2.5369%
================================================================================
Old VaR to test: 2.5369%
Recalibration needed at 240 days: The following tests failed: Unconditional, Conditional
342
New VaR to test: 2.7075%</code></pre>
</div>
</div>
<div id="8fd9d17f" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>data_test.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>plt.plot(data_test, label<span class="op">=</span><span class="st">"Returns"</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>recab <span class="op">=</span> np.cumsum(np.array(recalibration_points))</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>vars_stored_neg <span class="op">=</span> <span class="op">-</span>np.array(vars_stored)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>plt.scatter(recab, vars_stored_neg, color<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">"Recalibration points"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(recab) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    plt.step(recab, vars_stored_neg, where<span class="op">=</span><span class="st">'post'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'solid'</span>, label<span class="op">=</span><span class="st">"VaR Adjusted"</span>)</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    plt.hlines(vars_stored_neg[<span class="op">-</span><span class="dv">1</span>], xmin<span class="op">=</span>recab[<span class="op">-</span><span class="dv">1</span>], xmax<span class="op">=</span><span class="bu">len</span>(data_test), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'solid'</span>)</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Time"</span>)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"VaR / Returns"</span>)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Backtesting VaR with Recalibration Points"</span>)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="var_classiques_files/figure-html/cell-48-output-1.png" width="980" height="523" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>